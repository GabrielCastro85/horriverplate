<section class="space-y-6 animate-fadeIn">
  <header class="page-hero space-y-3">
    <span class="hero-badge text-horriver-gray">
      <span class="hero-icon">TL</span>
      Tierlist
    </span>
    <h1 class="font-title text-3xl md:text-4xl text-horriver-light">
      Monte sua tierlist da pelada
    </h1>
    <p class="text-sm text-horriver-gray max-w-2xl">
      Arraste os jogadores para os tiers. VocÃª pode renomear e personalizar as cores.
      Ao final, gere a imagem para compartilhar.
    </p>
  </header>

  <div class="flex flex-col md:flex-row gap-4 md:items-end">
    <label class="text-sm text-horriver-gray w-full md:w-80">
      TÃ­tulo da tierlist
      <input
        type="text"
        id="tierTitle"
        value="Tierlist Horriver Plate"
        class="mt-1 w-full rounded-xl bg-black/40 border border-horriver-border px-4 py-2 text-horriver-light"
      />
    </label>
    <div class="flex flex-wrap items-center gap-2">
      <button
        type="button"
        id="addTierBtn"
        class="px-4 py-2 rounded-full bg-horriver-orange text-black text-sm font-semibold"
      >
        Adicionar tier
      </button>
      <button
        type="button"
        id="downloadTierBtn"
        class="px-4 py-2 rounded-full border border-horriver-orange/70 text-horriver-orange text-sm font-semibold hover:bg-horriver-orange hover:text-black transition"
      >
        Baixar imagem
      </button>
    </div>
  </div>

  <div id="tier-board" class="space-y-3" data-export-root>
  <div class="tier-export-header export-only">
    <div class="tier-export-title">
      <span class="tier-export-title-text">HORRIVER PLATE — TIER LIST</span>
    </div>
    <div class="tier-export-logo">
      <img src="/img/logo-128x128.svg" alt="Horriver Plate" />
    </div>
  </div>
    <div id="tiers" class="space-y-3"></div>

    <section class="rounded-3xl border border-horriver-border bg-black/40 p-4 tier-pool-section">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-title text-xl text-horriver-light">Jogadores</h2>
        <span class="text-[11px] text-horriver-gray"><%= players.length %> jogadores</span>
      </div>
      <ul id="tier-pool" class="tier-list grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></ul>
    </section>

    <div class="tier-export-footer export-only">
      @horriverplate
    </div>
  </div>
</section>

<style>
  .export-only {
    display: none;
  }
  .tier-row {
    display: grid;
    grid-template-columns: 110px 1fr;
    gap: 8px;
  }
  .tier-label {
    border-radius: 14px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    border: 1px solid rgba(255, 255, 255, 0.08);
  }
  .tier-name {
    background: transparent;
    border: none;
    color: #f8fafc;
    font-weight: 800;
    font-size: 16px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .tier-name:focus {
    outline: none;
  }
  .tier-list {
    min-height: 64px;
    border-radius: 16px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(0, 0, 0, 0.35);
    padding: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .player-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 8px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(0, 0, 0, 0.6);
    color: #f8fafc;
    font-size: 11px;
    cursor: grab;
    user-select: none;
  }
  .player-item img {
    width: 22px;
    height: 22px;
    border-radius: 999px;
    object-fit: cover;
  }
  .tier-actions {
    display: flex;
    gap: 6px;
  }
  .tier-actions button {
    font-size: 10px;
    border-radius: 999px;
    border: 1px solid rgba(0, 0, 0, 0.35);
    background: rgba(0, 0, 0, 0.2);
    color: #0b0b0b;
    padding: 4px 6px;
  }
  .tier-letter {
    display: none;
    font-size: 24px;
    font-weight: 800;
    color: #0b0b0b;
    text-align: center;
  }

  #tier-board.is-exporting {
    width: 1600px;
    height: auto;
    padding: 28px 28px 20px;
    background: linear-gradient(180deg, #0f1115 0%, #050608 100%);
    border-radius: 28px;
    overflow: visible;
    display: flex;
    flex-direction: column;
  }
  body.is-exporting {
    height: auto !important;
  }
  #tier-board.is-exporting .export-only {
    display: flex;
  }
  #tier-board.is-exporting .tier-export-header {
    align-items: center;
    justify-content: space-between;
    padding: 6px 8px 18px;
  }
  #tier-board.is-exporting .tier-export-title {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  #tier-board.is-exporting .tier-export-title-text {
    font-size: 34px;
    font-weight: 800;
    letter-spacing: 0.08em;
    color: #f8fafc;
  }
  #tier-board.is-exporting .tier-export-subtitle {
    font-size: 16px;
    color: #cbd5f5;
    opacity: 0.9;
  }
  #tier-board.is-exporting .tier-export-logo img {
    width: 64px;
    height: 64px;
    object-fit: contain;
  }
  #tier-board.is-exporting #tiers {
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex: 1 1 auto;
  }
  #tier-board.is-exporting .tier-pool-section {
    display: none;
  }
  #tier-board.is-exporting .tier-row {
    grid-template-columns: 120px 1fr;
    gap: 10px;
  }
  #tier-board.is-exporting .tier-label {
    background: var(--tier-color, #ef4444);
    border: none;
    align-items: center;
    justify-content: center;
    min-height: 92px;
  }
  #tier-board.is-exporting .tier-name,
  #tier-board.is-exporting input[type="color"],
  #tier-board.is-exporting .tier-actions {
    display: none;
  }
  #tier-board.is-exporting .tier-letter {
    display: block;
  }
  #tier-board.is-exporting .tier-list {
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.03);
    padding: 10px;
    min-height: auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
  }
  #tier-board.is-exporting .player-item {
    width: 100%;
    max-width: 220px;
    padding: 8px 10px;
    border-radius: 14px;
    border: 1px solid var(--tier-color-soft, rgba(255,255,255,0.16));
    background: rgba(255, 255, 255, 0.06);
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
    font-size: 13px;
    font-weight: 600;
  }
  #tier-board.is-exporting .player-item img {
    width: 68px;
    height: 68px;
  }
  #tier-board.is-exporting .player-item span {
    white-space: normal;
    line-height: 1.2;
  }
  #tier-board.is-exporting .tier-export-footer {
    justify-content: center;
    font-size: 14px;
    color: rgba(248, 250, 252, 0.35);
    margin-top: auto;
    padding-top: 10px;
  }

  @media (max-width: 640px) {
    .tier-row {
      grid-template-columns: 1fr;
    }
    .tier-label {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
    .tier-actions {
      margin-left: auto;
    }
  }
</style>

<script>
  (function () {
    const tierContainer = document.getElementById("tiers");
    const pool = document.getElementById("tier-pool");
    const addTierBtn = document.getElementById("addTierBtn");
    const downloadBtn = document.getElementById("downloadTierBtn");
    const titleInput = document.getElementById("tierTitle");

    const defaultTiers = [
      { label: "S", color: "#c62828" },
      { label: "A", color: "#ef6c00" },
      { label: "B", color: "#f9a825" },
      { label: "C", color: "#2e7d32" },
      { label: "D", color: "#1565c0" },
    ];

    const playerData = <%- JSON.stringify(
      (players || []).map((p) => ({
        id: p.id,
        name: p.name,
        nickname: p.nickname,
        avatar: thumbUrl(p.photoUrl || "/img/logo-128x128.svg", 48),
      }))
    ) %>;

    const toRgba = (hex, alpha = 0.35) => {
      if (!hex || !hex.startsWith("#") || (hex.length !== 7 && hex.length !== 4)) {
        return `rgba(255,255,255,${alpha})`;
      }
      const full = hex.length === 4
        ? `#${hex[1]}${hex[1]}${hex[2]}${hex[2]}${hex[3]}${hex[3]}`
        : hex;
      const r = parseInt(full.slice(1, 3), 16);
      const g = parseInt(full.slice(3, 5), 16);
      const b = parseInt(full.slice(5, 7), 16);
      return `rgba(${r},${g},${b},${alpha})`;
    };

    const createTierRow = (tier) => {
      const row = document.createElement("div");
      row.className = "tier-row";
      row.dataset.tier = tier.label;

      const label = document.createElement("div");
      label.className = "tier-label";
      label.setAttribute("data-tier-handle", "true");
      label.style.background = `${tier.color}33`;
      label.style.borderColor = `${tier.color}80`;

      row.style.setProperty("--tier-color", tier.color);
      row.style.setProperty("--tier-color-soft", toRgba(tier.color));

      const letter = document.createElement("div");
      letter.className = "tier-letter";
      letter.textContent = tier.label;

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.className = "tier-name";
      nameInput.value = tier.label;

      const colorInput = document.createElement("input");
      colorInput.type = "color";
      colorInput.value = tier.color;

      const actions = document.createElement("div");
      actions.className = "tier-actions";
      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.textContent = "Remover";
      actions.appendChild(removeBtn);

      label.appendChild(letter);
      label.appendChild(nameInput);
      label.appendChild(colorInput);
      label.appendChild(actions);

      const list = document.createElement("ul");
      list.className = "tier-list";
      list.dataset.list = "tier";

      row.appendChild(label);
      row.appendChild(list);

      colorInput.addEventListener("input", () => {
        label.style.background = `${colorInput.value}33`;
        label.style.borderColor = `${colorInput.value}80`;
        row.style.setProperty("--tier-color", colorInput.value);
        row.style.setProperty("--tier-color-soft", toRgba(colorInput.value));
      });

      nameInput.addEventListener("input", () => {
        letter.textContent = nameInput.value || tier.label;
      });

      removeBtn.addEventListener("click", () => {
        const items = Array.from(list.querySelectorAll(".player-item"));
        items.forEach((item) => pool.appendChild(item));
        row.remove();
      });

      return row;
    };

    const setupSortable = (el) => {
      new Sortable(el, {
        group: "tiers",
        animation: 150,
        ghostClass: "bg-horriver-orange/30",
        draggable: ".player-item",
      });
    };

    defaultTiers.forEach((tier) => {
      const row = createTierRow(tier);
      tierContainer.appendChild(row);
      setupSortable(row.querySelector(".tier-list"));
    });

    playerData.forEach((p) => {
      const item = document.createElement("li");
      item.className = "player-item";
      item.dataset.playerId = p.id;
      const img = document.createElement("img");
      img.src = p.avatar;
      const name = document.createElement("span");
      name.textContent = p.nickname ? `${p.name} (${p.nickname})` : p.name;
      item.appendChild(img);
      item.appendChild(name);
      pool.appendChild(item);
    });

    setupSortable(pool);

    new Sortable(tierContainer, {
      animation: 150,
      handle: "[data-tier-handle]",
      draggable: ".tier-row",
      ghostClass: "bg-horriver-orange/20",
    });

    addTierBtn.addEventListener("click", () => {
      const row = createTierRow({ label: "Novo", color: "#f97316" });
      tierContainer.appendChild(row);
      setupSortable(row.querySelector(".tier-list"));
      row.querySelector(".tier-name").focus();
    });

    downloadBtn.addEventListener("click", async () => {
      let board = null;
      try {
        board = document.querySelector("[data-export-root]");
        if (!board) return;
        if (typeof html2canvas === "undefined") return;
        if (document.fonts && document.fonts.ready) {
          await document.fonts.ready;
        }
        document.body.classList.add("is-exporting");
        board.classList.add("is-exporting");

        const exportHeight = Math.ceil(board.scrollHeight || board.getBoundingClientRect().height || 0);
        const canvas = await html2canvas(board, {
          backgroundColor: "#0f1115",
          scale: 2,
          height: exportHeight,
          windowHeight: exportHeight,
        });

        board.classList.remove("is-exporting");
        document.body.classList.remove("is-exporting");
        const link = document.createElement("a");
        link.download = "tierlist-horriver.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      } catch (err) {
        console.error(err);
        if (board) board.classList.remove("is-exporting");
        document.body.classList.remove("is-exporting");
      }
    });
  })();
</script>
























