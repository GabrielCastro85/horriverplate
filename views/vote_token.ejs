<section class="space-y-6 max-w-3xl mx-auto animate-fadeIn">
  <style>
    .vote-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 16px;
    }
    .rating-pill input:checked + span {
      background: #ff7a1a;
      color: #0b0b0b;
      border-color: #ff7a1a;
      box-shadow: 0 8px 16px rgba(0,0,0,0.25);
    }
    .rating-row {
      justify-content: center;
    }
  </style>

  <header class="text-center space-y-2">
    <h1 class="font-title text-3xl text-horriver-light">Votacao da pelada</h1>
    <% if (match) { %>
      <p class="text-sm text-horriver-gray">
        Pelada de <span class="text-horriver-orange"><%= new Date(match.playedAt).toLocaleDateString("pt-BR", { timeZone: 'America/Sao_Paulo' }) %></span>
        <% if (match.description) { %> Â· <%= match.description %> <% } %>
      </p>
    <% } %>
    <% if (voter) { %>
      <p class="text-xs text-horriver-gray">
        Link gerado para: <span class="text-horriver-light"><%= voter.name %></span>
      </p>
      <p class="text-[11px] text-horriver-gray">
        Voce nao pode votar em si mesmo.
      </p>
    <% } %>
  </header>

  <% if (error) { %>
    <div class="bg-red-900/40 border border-red-600/60 text-red-100 rounded-2xl p-4 text-sm">
      <%= error %>
    </div>
  <% } %>

  <% if (success) { %>
    <div class="bg-emerald-900/40 border border-emerald-600/60 text-emerald-100 rounded-2xl p-4 text-sm">
      Voto registrado com sucesso. Obrigado!
    </div>
  <% } %>

  <% if (!error && !success) { %>
    <form method="POST" class="space-y-4" id="vote-flow-form">
      <div class="flex items-center justify-between text-xs text-horriver-gray">
        <span id="vote-progress">Jogador 1 de <%= players.length %></span>
        <span>Notas de 1 a 5 (obrigatorio)</span>
      </div>

      <div id="vote-alert" class="hidden text-xs text-red-300 bg-red-900/30 border border-red-700/40 rounded-lg px-3 py-2"></div>

      <div class="space-y-4">
        <% players.forEach((p, idx) => { %>
          <div class="vote-card <%= idx === 0 ? '' : 'hidden' %>" data-vote-card data-index="<%= idx %>">
            <div class="flex items-center gap-4">
              <img
                src="<%= p.photoUrl || '/img/logo-64x64.svg' %>"
                alt="<%= p.name %>"
                class="w-16 h-16 rounded-full object-cover border border-horriver-orange/60 bg-horriver-dark"
              />
              <div class="min-w-0">
                <p class="text-horriver-light font-semibold text-lg truncate"><%= p.name %></p>
                <% if (p.nickname) { %>
                  <p class="text-[11px] text-horriver-gray">"<%= p.nickname %>"</p>
                <% } %>
                <p class="text-[11px] text-horriver-gray">
                  Posicao: <span class="text-horriver-light"><%= p.positionLabel || p.position || "Outros" %></span>
                </p>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-3 gap-2 text-[11px] text-horriver-gray">
              <div class="rounded-xl border border-horriver-border/60 bg-black/40 px-2 py-2 text-center">
                <p class="text-horriver-orange font-semibold"><%= p.goals || 0 %></p>
                <p>Gols</p>
              </div>
              <div class="rounded-xl border border-horriver-border/60 bg-black/40 px-2 py-2 text-center">
                <p class="text-horriver-orange font-semibold"><%= p.assists || 0 %></p>
                <p>Assist.</p>
              </div>
              <div class="rounded-xl border border-horriver-border/60 bg-black/40 px-2 py-2 text-center">
                <p class="text-horriver-orange font-semibold"><%= p.appearedInPhoto ? "SIM" : "NAO" %></p>
                <p>Foto</p>
              </div>
            </div>

            <div class="mt-4 flex items-center gap-2 rating-row">
              <% for (let r = 1; r <= 5; r++) { %>
                <label class="rating-pill">
                  <input type="radio" name="rating_<%= p.id %>" value="<%= r %>" class="hidden" />
                  <span class="inline-flex items-center justify-center w-9 h-9 rounded-full border border-horriver-border text-horriver-light text-sm font-semibold hover:border-horriver-orange transition leading-none">
                    <%= r %>
                  </span>
                </label>
              <% } %>
            </div>
          </div>
        <% }) %>
      </div>

      <div class="flex items-center justify-between pt-2">
        <button
          type="button"
          id="vote-prev"
          class="px-4 py-2 rounded-full border border-horriver-border text-horriver-gray text-sm hover:border-horriver-orange hover:text-horriver-orange transition disabled:opacity-40"
          disabled
        >
          Anterior
        </button>
        <div class="flex items-center gap-2">
          <button
            type="button"
            id="vote-next"
            class="px-4 py-2 rounded-full bg-horriver-orange text-black text-sm font-semibold hover:bg-orange-500 transition"
          >
            Proximo
          </button>
          <button
            type="submit"
            id="vote-submit"
            class="hidden px-4 py-2 rounded-full bg-horriver-orange text-black text-sm font-semibold hover:bg-orange-500 transition"
          >
            Enviar votos
          </button>
        </div>
      </div>
    </form>
  <% } %>
</section>

<script>
  (() => {
    const cards = Array.from(document.querySelectorAll("[data-vote-card]"));
    const alertBox = document.getElementById("vote-alert");
    const progress = document.getElementById("vote-progress");
    const prevBtn = document.getElementById("vote-prev");
    const nextBtn = document.getElementById("vote-next");
    const submitBtn = document.getElementById("vote-submit");
    const form = document.getElementById("vote-flow-form");
    if (!cards.length || !form) return;

    let index = 0;

    const showCard = (idx) => {
      cards.forEach((card, i) => card.classList.toggle("hidden", i !== idx));
      progress.textContent = `Jogador ${idx + 1} de ${cards.length}`;
      prevBtn.disabled = idx === 0;
      nextBtn.classList.toggle("hidden", idx === cards.length - 1);
      submitBtn.classList.toggle("hidden", idx !== cards.length - 1);
      if (alertBox) {
        alertBox.classList.add("hidden");
        alertBox.textContent = "";
      }
    };

    const currentHasRating = () => {
      const current = cards[index];
      if (!current) return false;
      return !!current.querySelector('input[type="radio"]:checked');
    };

    const ensureAllRated = () => {
      return cards.every((card) => !!card.querySelector('input[type="radio"]:checked'));
    };

    nextBtn.addEventListener("click", () => {
      if (!currentHasRating()) {
        alertBox.textContent = "Selecione uma nota de 1 a 5 para continuar.";
        alertBox.classList.remove("hidden");
        return;
      }
      index = Math.min(index + 1, cards.length - 1);
      showCard(index);
    });

    prevBtn.addEventListener("click", () => {
      index = Math.max(index - 1, 0);
      showCard(index);
    });

    form.addEventListener("submit", (e) => {
      if (!ensureAllRated()) {
        e.preventDefault();
        alertBox.textContent = "Preencha todas as notas antes de enviar.";
        alertBox.classList.remove("hidden");
      }
    });

    showCard(index);
  })();
</script>

