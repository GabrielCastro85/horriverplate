<% /* Painel do Admin - reorganizado para destacar as funcoes principais */ %>

<div class="space-y-10">
  <!-- Header + acoes rapidas -->
  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <p class="text-xs text-horriver-gray uppercase tracking-[0.2em]">Painel</p>
      <h1 class="font-title text-2xl text-horriver-light">Admin Horriver Plate</h1>
      <p class="text-sm text-horriver-gray">Gerencie peladas, jogadores e destaques.</p>
    </div>
    <div class="flex flex-wrap gap-2 text-xs">
      <a
        href="/admin/recalculate-totals"
        class="px-3 py-2 rounded-md border border-horriver-red text-horriver-red hover:bg-horriver-red hover:text-horriver-dark transition"
        onclick="return confirm('Isso pode demorar. Recalcular totais de todos os jogadores?');"
      >Recalcular Totais (All-Time)</a>
      <form action="/admin/recalculate-overall" method="POST">
        <button
          type="submit"
          class="px-3 py-2 rounded-md border border-blue-500 text-blue-400 hover:bg-blue-500 hover:text-horriver-dark transition"
          onclick="return confirm('Recalcular Overall das ultimas 10 peladas?');"
        >Recalcular Overall (Ultimas 10)</button>
      </form>
    </div>
  </header>

  <!-- Peladas -->
  <section id="peladas" class="scroll-mt-16 space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="font-title text-xl text-horriver-orange">Peladas</h2>
      <p class="text-xs text-horriver-gray">Criar, listar, abrir stats ou excluir.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Nova pelada -->
      <div class="bg-black/40 border border-horriver-border rounded-2xl p-4 space-y-3">
        <h3 class="font-semibold text-lg text-horriver-light">Nova Pelada</h3>
        <form id="newMatchForm" action="/admin/matches" method="POST" class="space-y-3">
          <label class="flex flex-col gap-1 text-sm text-horriver-gray">
            Data
            <input
              type="datetime-local"
              name="playedAt"
              id="playedAt"
              required
              placeholder="AAAA-MM-DDThh:mm"
              class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light"
            />
          </label>
          <label class="flex flex-col gap-1 text-sm text-horriver-gray">
            Descricao (opcional)
            <input
              type="text"
              name="description"
              id="description"
              placeholder="Ex: Pelada de feriado"
              class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light"
            />
          </label>
          <label class="flex flex-col gap-1 text-sm text-horriver-gray">
            Time vencedor (opcional)
            <input
              type="text"
              name="winnerTeam"
              id="winnerTeam"
              placeholder="Ex: Laranja"
              class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light"
            />
          </label>
          <button
            type="submit"
            class="w-full px-4 py-2 rounded-full bg-horriver-orange text-black font-semibold hover:bg-orange-500 transition"
          >Criar Pelada</button>
        </form>
      </div>

      <!-- Historico -->
      <div class="lg:col-span-2 bg-black/40 border border-horriver-border rounded-2xl p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold text-lg text-horriver-light">Historico de Peladas</h3>
          <span class="text-xs text-horriver-gray">Role para ver meses anteriores</span>
        </div>
        <div class="space-y-3 max-h-[520px] overflow-y-auto pr-1 text-sm">
          <% if (groupedMatches.length > 0) { %>
            <% groupedMatches.forEach(group => { %>
              <div class="space-y-2">
                <p class="text-horriver-gray uppercase text-[11px] tracking-wide"><%= group.group %></p>
                <div class="space-y-2">
                  <% group.matches.forEach(match => { %>
                    <div class="flex items-center justify-between bg-white/5 rounded-xl px-3 py-2 border border-horriver-border/60">
                      <div>
                        <p class="text-horriver-light font-semibold">
                          <%= new Date(match.playedAt).toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: '2-digit' }) %>
                        </p>
                        <p class="text-[12px] text-horriver-gray">
                          <%= match.description || 'Pelada Padrao' %>
                        </p>
                      </div>
                      <div class="flex items-center gap-2">
                        <a
                          href="/admin/matches/<%= match.id %>"
                          class="px-3 py-1 rounded-full bg-horriver-orange text-black text-[11px] font-semibold hover:bg-orange-500 transition"
                        >Stats</a>
                        <form action="/admin/matches/<%= match.id %>/delete" method="POST" onsubmit="return confirm('Excluir esta pelada e todos os dados?');">
                           <button type="submit" class="text-red-500 hover:text-red-400 text-[11px]">Excluir</button>
                        </form>
                      </div>
                    </div>
                  <% }) %>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-horriver-gray">Nenhuma pelada cadastrada.</p>
          <% } %>
        </div>
      </div>
    </div>
  </section>

  <!-- Destaques -->
  <section id="destaques" class="scroll-mt-16 space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="font-title text-xl text-horriver-orange">Destaques</h2>
      <p class="text-xs text-horriver-gray">Craque da semana e do mes.</p>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Craque da semana -->
      <div class="bg-black/40 border border-horriver-border rounded-2xl p-4 space-y-3">
        <h3 class="font-semibold text-lg text-horriver-light">Craque da Semana</h3>
        <form action="/admin/weekly-awards" method="POST" enctype="multipart/form-data" class="space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-horriver-gray">
            <label class="flex flex-col gap-1">
              Data de inicio
              <input type="date" name="weekStart" required class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light" />
            </label>
            <label class="flex flex-col gap-1">
              Craque
              <select name="bestPlayerId" class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light">
                <option value="">Nenhum</option>
                <% players.forEach(p => { %>
                  <option value="<%= p.id %>"><%= p.name %></option>
                <% }) %>
              </select>
            </label>
          </div>
          <label class="flex flex-col gap-1 text-sm text-horriver-gray">
            Pelada do destaque
            <select name="winningMatchId" class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light">
              <option value="">Nenhuma</option>
              <% matches.forEach(m => { %>
                <option value="<%= m.id %>"><%= new Date(m.playedAt).toLocaleDateString('pt-BR') %> - <%= m.description || 'Pelada' %></option>
              <% }) %>
            </select>
          </label>
          <label class="flex flex-col gap-1 text-sm text-horriver-gray">
            Foto (time da semana)
            <input type="file" name="teamPhoto" class="text-sm" />
          </label>
          <button type="submit" class="w-full px-4 py-2 rounded-full bg-horriver-orange text-black font-semibold hover:bg-orange-500 transition">Salvar</button>
        </form>
        <% if (weeklyAwards.length > 0) { %>
          <div class="border-t border-horriver-border/50 pt-3 space-y-2 text-xs text-horriver-gray">
            <p class="font-semibold text-horriver-light">Ultimos destaques</p>
            <% weeklyAwards.forEach(award => { %>
              <div class="flex justify-between items-center bg-white/5 rounded-lg px-2 py-1">
                <span><%= new Date(award.weekStart).toLocaleDateString('pt-BR') %> - <%= award.bestPlayer?.name || 'N/A' %></span>
                <form action="/admin/weekly-awards/<%= award.id %>/delete" method="POST" onsubmit="return confirm('Excluir destaque?');">
                  <button type="submit" class="text-red-500 hover:text-red-300">Excluir</button>
                </form>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>

      <!-- Craque do mes -->
      <div class="bg-black/40 border border-horriver-border rounded-2xl p-4 space-y-3">
        <h3 class="font-semibold text-lg text-horriver-light">Craque do Mes</h3>
        <form action="/admin/monthly-awards" method="POST" class="space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-horriver-gray">
            <label class="flex flex-col gap-1">
              Mes
              <select name="month" required class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light">
                <% for (let i = 1; i <= 12; i++) { %>
                  <option value="<%= i %>"><%= new Date(2000, i - 1, 1).toLocaleString('pt-BR', { month: 'long' }) %></option>
                <% } %>
              </select>
            </label>
            <label class="flex flex-col gap-1">
              Ano
              <input type="number" name="year" value="<%= new Date().getFullYear() %>" required class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light" />
            </label>
          </div>
          <label class="flex flex-col gap-1 text-sm text-horriver-gray">
            Craque
            <select name="craqueId" class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light">
              <option value="">Nenhum</option>
              <% players.forEach(p => { %>
                <option value="<%= p.id %>"><%= p.name %></option>
              <% }) %>
            </select>
          </label>
          <button type="submit" class="w-full px-4 py-2 rounded-full bg-horriver-orange text-black font-semibold hover:bg-orange-500 transition">Salvar</button>
        </form>
        <% if (monthlyAwards.length > 0) { %>
          <div class="border-t border-horriver-border/50 pt-3 space-y-2 text-xs text-horriver-gray">
            <p class="font-semibold text-horriver-light">Ultimos premiados</p>
            <% monthlyAwards.forEach(award => { %>
              <div class="flex justify-between items-center bg-white/5 rounded-lg px-2 py-1">
                <span><%= new Date(award.year, award.month - 1, 1).toLocaleString('pt-BR', { month: 'long' }) %>/<%= award.year %> - <%= award.craque?.name || 'N/A' %></span>
                <form action="/admin/monthly-awards/<%= award.id %>/delete" method="POST" onsubmit="return confirm('Excluir premiação?');">
                  <button type="submit" class="text-red-500 hover:text-red-300">Excluir</button>
                </form>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </div>
  </section>

  <!-- Premiação da temporada / Hall da Fama -->
  <section class="pt-4 border-t border-horriver-border/60">
    <div class="card-inner rounded-2xl p-5 md:p-6 space-y-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h2 class="text-lg md:text-xl font-semibold text-horriver-light">
            Premiação da temporada
          </h2>
          <p class="text-[11px] md:text-xs text-horriver-gray/80">
            Cadastre os prêmios de fim de ano (melhor jogador, artilheiro, por posição, etc).
          </p>
        </div>
        <a
          href="/admin/premiacao"
          class="inline-flex items-center justify-center px-4 py-2 rounded-full bg-horriver-orange text-[11px] md:text-xs font-medium text-black hover:bg-orange-500 transition shadow-card-soft"
        >
          Gerenciar premiação da temporada
        </a>
      </div>

      <%
        const hasSeasonAwards =
          typeof seasonAwards !== "undefined" &&
          seasonAwards &&
          seasonAwards.length;

        let latestYear = null;
        let latestAwards = [];
        if (hasSeasonAwards) {
          latestYear = seasonAwards[0].year;
          latestAwards = seasonAwards.filter(a => a.year === latestYear);
        }
      %>

      <% if (hasSeasonAwards && latestAwards.length) { %>
        <div class="mt-2 space-y-3">
          <p class="text-[11px] md:text-xs text-horriver-gray/80">
            Campeões atuais da temporada
            <span class="text-horriver-orange font-semibold"><%= latestYear %></span>:
          </p>
          <div class="overflow-x-auto text-[11px] md:text-xs">
            <table class="min-w-full border-collapse">
              <thead>
                <tr class="border-b border-horriver-border/60 text-horriver-gray/80">
                  <th class="py-2 pr-3 text-left font-normal">Categoria</th>
                  <th class="py-2 pr-3 text-left font-normal">Jogador</th>
                </tr>
              </thead>
              <tbody>
                <% latestAwards.forEach(a => { %>
                  <tr class="border-b border-horriver-border/40 last:border-0">
                    <td class="py-2 pr-3 text-horriver-gray/90">
                      <%= a.category %>
                    </td>
                    <td class="py-2 pr-3 text-horriver-light">
                      <% if (a.player) { %>
                        <%= a.player.name %><% if (a.player.nickname) { %> (<%= a.player.nickname %>)<% } %>
                      <% } else { %>
                        -
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      <% } else { %>
        <p class="text-[11px] md:text-xs text-horriver-gray/80">
          Nenhuma premiação cadastrada ainda. Clique em "Gerenciar premiação da temporada" para começar.
        </p>
      <% } %>
    </div>
  </section>

  <!-- Jogadores -->
  <section id="jogadores" class="scroll-mt-16 space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="font-title text-xl text-horriver-orange">Jogadores</h2>
      <p class="text-xs text-horriver-gray">Cadastrar, editar ou excluir.</p>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- novo jogador -->
      <div class="bg-black/40 border border-horriver-border rounded-2xl p-4 space-y-3">
        <h3 class="font-semibold text-lg text-horriver-light">Novo Jogador</h3>
        <form action="/admin/players" method="POST" enctype="multipart/form-data" class="space-y-3 text-sm text-horriver-gray">
          <label class="flex flex-col gap-1">
            Nome completo
            <input type="text" name="name" required class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light" />
          </label>
          <label class="flex flex-col gap-1">
            Apelido (opcional)
            <input type="text" name="nickname" class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light" />
          </label>
          <label class="flex flex-col gap-1">
            Telefone (opcional)
            <input type="tel" name="whatsapp" placeholder="21999998888" class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light" />
            <span class="text-[11px] text-horriver-gray">Somente números; +55 adicionado automaticamente.</span>
          </label>
          <label class="flex flex-col gap-1">
            Posicao principal
            <select name="position" required class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light">
              <option value="GOL">Goleiro</option>
              <option value="ZAG">Zagueiro</option>
              <option value="MEI">Meio-campo</option>
              <option value="ATA">Atacante</option>
            </select>
          </label>
          <label class="flex flex-col gap-1">
            Foto
            <input type="file" name="photo" class="text-sm" />
          </label>
          <button type="submit" class="w-full px-4 py-2 rounded-full bg-horriver-orange text-black font-semibold hover:bg-orange-500 transition">Adicionar</button>
        </form>
      </div>

      <!-- lista -->
      <div class="lg:col-span-2 bg-black/40 border border-horriver-border rounded-2xl p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold text-lg text-horriver-light">Jogadores cadastrados</h3>
          <span class="text-xs text-horriver-gray"><%= players.length %> total</span>
        </div>
        <div class="space-y-2 max-h-[520px] overflow-y-auto pr-1 text-sm">
          <% if (players.length > 0) { %>
            <% players.forEach(player => { %>
              <div class="flex items-center justify-between bg-white/5 rounded-xl px-3 py-2 border border-horriver-border/60">
                <div class="flex items-center gap-3">
                  <img src="<%= player.photoUrl || '/img/logo-64x64.svg' %>" class="w-10 h-10 rounded-full object-cover bg-horriver-dark" />
                  <div>
                    <p class="text-horriver-light font-semibold"><%= player.name %></p>
                    <% if (player.nickname) { %><p class="text-[11px] text-horriver-gray">"<%= player.nickname %>"</p><% } %>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <span class="text-[11px] px-2 py-1 rounded-full bg-horriver-dark text-horriver-light uppercase"><%= player.position %></span>
                  <a href="/admin/players/<%= player.id %>/edit" class="text-[12px] text-horriver-orange hover:underline">Editar</a>
                  <form action="/admin/players/<%= player.id %>/delete" method="POST" onsubmit="return confirm('Excluir jogador e todo o histórico?');">
                    <button type="submit" class="text-red-500 hover:text-red-300 text-[12px]">Excluir</button>
                  </form>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-horriver-gray">Nenhum jogador cadastrado.</p>
          <% } %>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
  // Normaliza a data do formulário de nova pelada
  (function () {
    const form = document.getElementById("newMatchForm");
    const input = document.getElementById("playedAt");
    if (!form || !input) return;

    const setDefaultNow = () => {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      const isoLocal = now.toISOString().slice(0, 16);
      if (!input.value) input.value = isoLocal;
    };

    const tryNormalize = () => {
      const v = input.value.trim();
      if (/^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}$/.test(v)) return true;
      const ddmmyyyy = /^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/;
      const m = v.match(ddmmyyyy);
      if (m) {
        const [_, d, mth, y] = m;
        input.value = `${y}-${mth}-${d}T19:30`;
        return true;
      }
      return false;
    };

    setDefaultNow();
    input.addEventListener("blur", tryNormalize);
    form.addEventListener("submit", (e) => {
      if (!tryNormalize()) {
        e.preventDefault();
        alert("Use o formato AAAA-MM-DDThh:mm ou selecione no calendario.");
      }
    });
  })();
</script>
