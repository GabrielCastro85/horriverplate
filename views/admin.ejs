<!-- CSS do Cropper (somente usado no admin) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css"
/>

<div class="space-y-10">
  <!-- Título -->
  <header class="mb-4">
    <h1 class="text-2xl md:text-3xl font-semibold text-horriver-light">
      Painel do Administrador
    </h1>
  </header>

  <!-- Grid principal: pelada / jogador -->
  <div class="grid lg:grid-cols-2 gap-8">
    <!-- Nova Pelada -->
    <section class="card-highlight rounded-2xl p-[1px] animate-fadeIn">
      <div class="card-inner rounded-2xl p-6 md:p-7 space-y-4">
        <h2 class="text-lg md:text-xl font-semibold text-horriver-orange">
          Nova Pelada
        </h2>

        <form action="/admin/matches" method="POST" class="space-y-4">
          <div class="space-y-1 text-xs md:text-sm">
            <label class="block text-horriver-gray/80">
              Data
            </label>
            <input
              type="date"
              name="playedAt"
              class="w-full bg-black/40 border border-horriver-border rounded-lg px-3 py-2 text-horriver-light text-xs md:text-sm focus:outline-none focus:ring-1 focus:ring-horriver-orange"
              required
            />
          </div>

          <div class="space-y-1 text-xs md:text-sm">
            <label class="block text-horriver-gray/80">
              Descrição (opcional)
            </label>
            <input
              type="text"
              name="description"
              placeholder="ex: Pelada da terça à noite"
              class="w-full bg-black/40 border border-horriver-border rounded-lg px-3 py-2 text-horriver-light text-xs md:text-sm placeholder:text-horriver-gray/60 focus:outline-none focus:ring-1 focus:ring-horriver-orange"
            />
          </div>

          <div class="space-y-1 text-xs md:text-sm">
            <label class="block text-horriver-gray/80">
              Time vencedor (opcional)
            </label>
            <input
              type="text"
              name="winnerTeam"
              placeholder="ex: Time Azul"
              class="w-full bg-black/40 border border-horriver-border rounded-lg px-3 py-2 text-horriver-light text-xs md:text-sm placeholder:text-horriver-gray/60 focus:outline-none focus:ring-1 focus:ring-horriver-orange"
            />
          </div>

          <button
            type="submit"
            class="mt-2 inline-flex items-center justify-center px-4 py-2 rounded-full bg-horriver-orange text-xs md:text-sm font-medium text-black hover:bg-orange-500 transition shadow-card-soft"
          >
            Criar Pelada
          </button>
        </form>
      </div>
    </section>

    <!-- Novo / Editar Jogador -->
    <section class="card-highlight rounded-2xl p-[1px] animate-fadeIn">
      <div class="card-inner rounded-2xl p-6 md:p-7 space-y-4">
        <div class="flex items-center justify-between">
          <h2
            id="playerFormTitle"
            class="text-lg md:text-xl font-semibold text-horriver-orange"
          >
            Novo Jogador
          </h2>
          <button
            id="playerCancelEdit"
            type="button"
            class="hidden text-[11px] md:text-xs text-horriver-gray/80 hover:text-horriver-orange"
          >
            Cancelar edição
          </button>
        </div>
        <p
          id="playerFormHint"
          class="text-[11px] text-horriver-gray/70"
        >
          Preencha para cadastrar um novo jogador.
        </p>

        <form
          id="playerForm"
          action="/admin/players"
          method="POST"
          class="space-y-4"
        >
          <div class="space-y-1 text-xs md:text-sm">
            <label class="block text-horriver-gray/80">
              Nome
            </label>
            <input
              type="text"
              name="name"
              required
              class="w-full bg-black/40 border border-horriver-border rounded-lg px-3 py-2 text-horriver-light text-xs md:text-sm focus:outline-none focus:ring-1 focus:ring-horriver-orange"
            />
          </div>

          <div class="space-y-1 text-xs md:text-sm">
            <label class="block text-horriver-gray/80">
              Apelido (opcional)
            </label>
            <input
              type="text"
              name="nickname"
              placeholder="ex: Gabigol, Romarinho..."
              class="w-full bg-black/40 border border-horriver-border rounded-lg px-3 py-2 text-horriver-light text-xs md:text-sm placeholder:text-horriver-gray/60 focus:outline-none focus:ring-1 focus:ring-horriver-orange"
            />
          </div>

          <div class="space-y-1 text-xs md:text-sm">
            <label class="block text-horriver-gray/80">
              Posição
            </label>
            <select
              name="position"
              required
              class="w-full bg-black/40 border border-horriver-border rounded-lg px-3 py-2 text-horriver-light text-xs md:text-sm focus:outline-none focus:ring-1 focus:ring-horriver-orange"
            >
              <option value="Goleiro">Goleiro</option>
              <option value="Zagueiro">Zagueiro</option>
              <option value="Meia">Meia</option>
              <option value="Atacante">Atacante</option>
            </select>
          </div>

          <!-- Foto do jogador (só no cadastro; em edição fica escondido) -->
          <div
            id="playerPhotoBlock"
            class="space-y-1 text-xs md:text-sm"
          >
            <label class="block text-horriver-gray/80">
              Foto do jogador
            </label>
            <input
              type="file"
              name="photo"
              accept="image/jpeg,image/png"
              class="block w-full text-[11px] md:text-xs text-horriver-gray"
            />
            <p class="text-[10px] text-horriver-gray/70">
              Aceita JPG/PNG, até 5MB. (Foto só é usada ao cadastrar novo
              jogador.)
            </p>
          </div>

          <button
            id="playerFormSubmit"
            type="submit"
            class="mt-2 inline-flex items-center justify-center px-4 py-2 rounded-full bg-horriver-orange text-xs md:text-sm font-medium text-black hover:bg-orange-500 transition shadow-card-soft"
          >
            Adicionar Jogador
          </button>
        </form>
      </div>
    </section>
  </div>

  <!-- Jogadores cadastrados (expandir/recolher) -->
  <section class="space-y-3">
    <div class="flex items-center justify-between">
      <h2 class="text-lg md:text-xl font-semibold text-horriver-light">
        Jogadores cadastrados
      </h2>
      <% if (players.length) { %>
        <button
          type="button"
          class="text-[11px] md:text-xs text-horriver-gray/80 hover:text-horriver-orange"
          data-collapse-trigger="players-list"
        >
          <span data-collapse-label-players>Mostrar lista</span>
        </button>
      <% } %>
    </div>

    <% if (!players.length) { %>
      <p class="text-xs md:text-sm text-horriver-gray/80">
        Nenhum jogador cadastrado ainda.
      </p>
    <% } else { %>
      <div
        id="players-list"
        data-collapse-target="players-list"
        class="hidden"
      >
        <div class="card-inner rounded-2xl p-4 md:p-5 mt-1">
          <div class="overflow-x-auto text-[11px] md:text-xs">
            <table class="min-w-full border-collapse">
              <thead>
                <tr class="border-b border-horriver-border/70 text-horriver-gray/80">
                  <th class="py-2 pr-3 text-left font-normal">Nome</th>
                  <th class="py-2 pr-3 text-left font-normal">Apelido</th>
                  <th class="py-2 pr-3 text-left font-normal">Posição</th>
                  <th class="py-2 pr-3 text-left font-normal">Ações</th>
                </tr>
              </thead>
              <tbody>
                <% players.forEach(p => { %>
                  <tr class="border-b border-horriver-border/40 last:border-0">
                    <td class="py-2 pr-3">
                      <%= p.name %>
                    </td>
                    <td class="py-2 pr-3 text-horriver-gray/90">
                      <%= p.nickname || "-" %>
                    </td>
                    <td class="py-2 pr-3 text-horriver-gray/90">
                      <%= p.position %>
                    </td>
                    <td class="py-2 pr-3">
                      <div class="flex items-center gap-2">
                        <button
                          type="button"
                          class="text-[11px] text-horriver-orange hover:underline"
                          data-player-edit
                          data-id="<%= p.id %>"
                          data-name="<%= p.name %>"
                          data-nickname="<%= p.nickname || '' %>"
                          data-position="<%= p.position %>"
                        >
                          Editar
                        </button>

                        <form
                          action="/admin/players/<%= p.id %>/delete"
                          method="POST"
                          onsubmit="return confirm('Excluir o jogador <%= p.name %>? Isso pode afetar estatísticas.');"
                        >
                          <button
                            type="submit"
                            class="text-[11px] text-red-500 hover:underline"
                          >
                            Excluir
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    <% } %>
  </section>

  <!-- Peladas cadastradas (expandir/recolher) -->
  <section class="space-y-3">
    <div class="flex items-center justify-between">
      <h2 class="text-lg md:text-xl font-semibold text-horriver-light">
        Peladas cadastradas
      </h2>
      <% if (groupedMatches.length) { %>
        <button
          type="button"
          class="text-[11px] md:text-xs text-horriver-gray/80 hover:text-horriver-orange"
          data-collapse-trigger="matches-list"
        >
          <span data-collapse-label-matches>Mostrar lista</span>
        </button>
      <% } %>
    </div>

    <% if (!groupedMatches.length) { %>
      <p class="text-xs md:text-sm text-horriver-gray/80">
        Nenhuma pelada cadastrada ainda.
      </p>
    <% } else { %>
      <div
        id="matches-list"
        data-collapse-target="matches-list"
        class="hidden"
      >
        <div class="space-y-4 mt-1">
          <% groupedMatches.forEach(group => { %>
            <div class="card-inner rounded-2xl p-4 md:p-5">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm md:text-base font-semibold text-horriver-orange">
                  <%= group.group %>
                </h3>
              </div>

              <div class="overflow-x-auto text-[11px] md:text-xs">
                <table class="min-w-full border-collapse">
                  <thead>
                    <tr class="border-b border-horriver-border/60 text-horriver-gray/80">
                      <th class="py-2 pr-4 text-left font-normal">Data</th>
                      <th class="py-2 pr-4 text-left font-normal">Descrição</th>
                      <th class="py-2 pr-4 text-left font-normal">Vencedor</th>
                      <th class="py-2 pr-4 text-left font-normal">Ações</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% group.matches.forEach(match => { %>
                      <tr class="border-b border-horriver-border/40 last:border-0">
                        <td class="py-2 pr-4">
                          <%= new Date(match.playedAt).toLocaleDateString("pt-BR") %>
                        </td>
                        <td class="py-2 pr-4 text-horriver-gray/90">
                          <%= match.description || "-" %>
                        </td>
                        <td class="py-2 pr-4">
                          <span class="text-horriver-orange/90">
                            <%= match.winnerTeam || "-" %>
                          </span>
                        </td>
                        <td class="py-2 pr-4 space-x-2">
                          <a
                            href="/admin/matches/<%= match.id %>"
                            class="text-[11px] text-horriver-orange hover:underline"
                          >
                            Estatísticas
                          </a>

                          <form
                            action="/admin/matches/<%= match.id %>/delete"
                            method="POST"
                            class="inline"
                            onsubmit="return confirm('Tem certeza que deseja excluir essa pelada?');"
                          >
                            <button
                              type="submit"
                              class="text-[11px] text-red-500 hover:underline"
                            >
                              Excluir
                            </button>
                          </form>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    <% } %>
  </section>

  <!-- Destaques da semana / mês -->
  <section class="grid lg:grid-cols-2 gap-8">
    <!-- Craque / Time da semana -->
    <div class="card-inner rounded-2xl p-6 md:p-7 space-y-5">
      <div class="flex items-center justify-between">
        <h2 class="text-lg md:text-xl font-semibold text-horriver-light">
          Destaque da semana
        </h2>
      </div>

      <form
        id="weeklyForm"
        action="/admin/weekly-awards"
        method="POST"
        enctype="multipart/form-data"
        class="space-y-4 text-xs md:text-sm"
      >
        <div class="space-y-1">
          <label class="block text-horriver-gray/80">
            Semana (data de início)
          </label>
          <input
            id="weekly_weekStart"
            type="date"
            name="weekStart"
            class="w-full bg-black/40 border border-horriver-border rounded-lg px-3 py-2 text-horriver-light focus:outline-none focus:ring-1 focus:ring-horriver-orange"
            required
          />
        </div>

        <div class="space-y-1">
          <label class="block text-horriver-gray/80">
            Craque da semana (opcional)
          </label>
          <select
            id="weekly_bestPlayer"
            name="bestPlayerId"
            class="w-full bg-black/40 border border-horriver-border rounded-lg px-3 py-2 text-horriver-light"
          >
            <option value="">Nenhum</option>
            <% players.forEach(p => { %>
              <option value="<%= p.id %>">
                <%= p.name %><% if (p.nickname) { %> (<%= p.nickname %>)<% } %>
              </option>
            <% }) %>
          </select>
        </div>

        <div class="space-y-1">
          <label class="block text-horriver-gray/80">
            Pelada destaque (opcional)
          </label>
          <select
            id="weekly_match"
            name="winningMatchId"
            class="w-full bg-black/40 border border-horriver-border rounded-lg px-3 py-2 text-horriver-light"
          >
            <option value="">Nenhuma</option>
            <% matches.forEach(m => { %>
              <option value="<%= m.id %>">
                <%= new Date(m.playedAt).toLocaleDateString("pt-BR") %>
                <% if (m.description) { %> - <%= m.description %><% } %>
              </option>
            <% }) %>
          </select>
        </div>

        <div class="space-y-1">
          <label class="block text-horriver-gray/80">
            Foto do time da semana (opcional)
          </label>
          <input
            id="weekly_teamPhotoInput"
            type="file"
            name="teamPhoto"
            accept="image/jpeg,image/png"
            class="block w-full text-[11px] md:text-xs text-horriver-gray"
          />
          <p class="text-[10px] text-horriver-gray/70">
            Assim que você escolher uma imagem, o editor de corte aparece
            logo abaixo.
          </p>

          <!-- Área de crop -->
          <div
            id="teamPhotoCropContainer"
            class="mt-2 hidden space-y-2"
          >
            <p class="text-[10px] text-horriver-gray/70">
              Ajuste o corte da imagem (arraste / use o scroll do mouse):
            </p>
            <div
              class="border border-horriver-border rounded-lg overflow-hidden max-h-64 bg-black/60 flex items-center justify-center"
            >
              <img
                id="teamPhotoCropImage"
                class="max-w-full block"
                alt="Pré-visualização do corte"
              />
            </div>
            <button
              type="button"
              id="applyTeamPhotoCrop"
              class="px-3 py-1 rounded-full bg-horriver-orange text-[11px] font-medium text-black hover:bg-orange-500 transition"
            >
              Aplicar corte
            </button>
            <p
              id="teamPhotoCropDone"
              class="text-[10px] text-horriver-gray/70 hidden"
            >
              Corte aplicado! A imagem será enviada já recortada.
            </p>
          </div>
        </div>

        <button
          type="submit"
          class="mt-2 inline-flex items-center justify-center px-4 py-2 rounded-full bg-horriver-orange text-xs md:text-sm font-medium text-black hover:bg-orange-500 transition shadow-card-soft"
        >
          Salvar destaque da semana
        </button>
      </form>

      <!-- Lista últimos destaques -->
      <div class="pt-4 border-t border-horriver-border/60 space-y-3">
        <h3 class="text-xs md:text-sm font-semibold text-horriver-gray/90">
          Últimos destaques
        </h3>

        <% if (!weeklyAwards.length) { %>
          <p class="text-[11px] text-horriver-gray/70">
            Nenhum destaque da semana cadastrado.
          </p>
        <% } else { %>
          <ul class="space-y-2 text-[11px] md:text-xs">
            <% weeklyAwards.forEach(w => { %>
              <li
                class="flex items-center justify-between gap-3 border border-horriver-border/60 rounded-lg px-3 py-2 bg-black/30"
              >
                <div class="space-y-0.5">
                  <p class="text-horriver-light/90">
                    Semana de
                    <span class="text-horriver-orange">
                      <%= new Date(w.weekStart).toLocaleDateString("pt-BR") %>
                    </span>
                  </p>
                  <p class="text-[11px] text-horriver-gray/80">
                    Craque:
                    <span class="text-horriver-light">
                      <%= w.bestPlayer
                        ? w.bestPlayer.name + (w.bestPlayer.nickname ? " (" + w.bestPlayer.nickname + ")" : "")
                        : "—"
                      %>
                    </span>
                  </p>
                </div>

                <div class="flex items-center gap-2">
                  <button
                    type="button"
                    class="text-[11px] text-horriver-orange hover:underline"
                    data-weekly-edit
                    data-weekstart="<%= w.weekStart.toISOString().slice(0,10) %>"
                    data-best-id="<%= w.bestPlayerId || '' %>"
                    data-match-id="<%= w.winningMatchId || '' %>"
                  >
                    Editar
                  </button>

                  <form
                    action="/admin/weekly-awards/<%= w.id %>/delete"
                    method="POST"
                    onsubmit="return confirm('Remover esse destaque da semana?');"
                  >
                    <button
                      type="submit"
                      class="text-[11px] text-red-500 hover:underline"
                    >
                      Excluir
                    </button>
                  </form>
                </div>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </div>
    </div>

    <!-- Craque do mês -->
    <div class="card-inner rounded-2xl p-6 md:p-7 space-y-5">
      <div class="flex items-centered justify-between">
        <h2 class="text-lg md:text-xl font-semibold text-horriver-light">
          Craque do mês
        </h2>
      </div>

      <form
        id="monthlyForm"
        action="/admin/monthly-awards"
        method="POST"
        class="space-y-4 text-xs md:text-sm"
      >
        <div class="space-y-1">
          <label class="block text-horriver-gray/80">
            Mês
          </label>
          <select
            id="monthly_month"
            name="month"
            class="w-full bg-black/40 border border-horriver-border rounded-lg px-3 py-2 text-horriver-light"
            required
          >
            <option value="">Selecione</option>
            <option value="1">Janeiro</option>
            <option value="2">Fevereiro</option>
            <option value="3">Março</option>
            <option value="4">Abril</option>
            <option value="5">Maio</option>
            <option value="6">Junho</option>
            <option value="7">Julho</option>
            <option value="8">Agosto</option>
            <option value="9">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
          </select>
        </div>

        <div class="space-y-1">
          <label class="block text-horriver-gray/80">
            Ano
          </label>
          <input
            id="monthly_year"
            type="number"
            name="year"
            value="<%= new Date().getFullYear() %>"
            class="w-full bg-black/40 border border-horriver-border rounded-lg px-3 py-2 text-horriver-light"
            required
          />
        </div>

        <div class="space-y-1">
          <label class="block text-horriver-gray/80">
            Craque do mês (opcional)
          </label>
          <select
            id="monthly_craque"
            name="craqueId"
            class="w-full bg-black/40 border border-horriver-border rounded-lg px-3 py-2 text-horriver-light"
          >
            <option value="">Nenhum</option>
            <% players.forEach(p => { %>
              <option value="<%= p.id %>">
                <%= p.name %><% if (p.nickname) { %> (<%= p.nickname %>)<% } %>
              </option>
            <% }) %>
          </select>
        </div>

        <button
          type="submit"
          class="mt-2 inline-flex items-center justify-center px-4 py-2 rounded-full bg-horriver-orange text-xs md:text-sm font-medium text-black hover:bg-orange-500 transition shadow-card-soft"
        >
          Salvar craque do mês
        </button>
      </form>

      <!-- Lista últimos craques do mês -->
      <div class="pt-4 border-t border-horriver-border/60 space-y-3">
        <h3 class="text-xs md:text-sm font-semibold text-horriver-gray/90">
          Últimos craques do mês
        </h3>

        <% if (!monthlyAwards.length) { %>
          <p class="text-[11px] text-horriver-gray/70">
            Nenhum craque do mês cadastrado.
          </p>
        <% } else { %>
          <ul class="space-y-2 text-[11px] md:text-xs">
            <% monthlyAwards.forEach(m => { %>
              <li
                class="flex items-center justify-between gap-3 border border-horriver-border/60 rounded-lg px-3 py-2 bg-black/30"
              >
                <div class="space-y-0.5">
                  <p class="text-horriver-light/90">
                    <span class="text-horriver-orange">
                      <%= m.month %>/<%= m.year %>
                    </span>
                  </p>
                  <p class="text-[11px] text-horriver-gray/80">
                    Craque:
                    <span class="text-horriver-light">
                      <%= m.craque
                        ? m.craque.name + (m.craque.nickname ? " (" + m.craque.nickname + ")" : "")
                        : "—"
                      %>
                    </span>
                  </p>
                </div>

                <div class="flex items-center gap-2">
                  <button
                    type="button"
                    class="text-[11px] text-horriver-orange hover:underline"
                    data-monthly-edit
                    data-month="<%= m.month %>"
                    data-year="<%= m.year %>"
                    data-player-id="<%= m.craqueId || '' %>"
                  >
                    Editar
                  </button>

                  <form
                    action="/admin/monthly-awards/<%= m.id %>/delete"
                    method="POST"
                    onsubmit="return confirm('Remover esse craque do mês?');"
                  >
                    <button
                      type="submit"
                      class="text-[11px] text-red-500 hover:underline"
                    >
                      Excluir
                    </button>
                  </form>
                </div>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </div>
    </div>
  </section>

  <!-- Rodapé admin: botão de reset -->
  <section class="pt-4 border-t border-horriver-border/60">
    <form
      method="POST"
      action="/admin/recalculate-totals"
      class="inline"
    >
      <button
        type="submit"
        class="px-3 py-1 rounded-full border border-horriver-orange
              text-[11px] md:text-xs text-horriver-orange
              hover:bg-horriver-orange hover:text-horriver-bg
              transition-colors"
      >
        Recalcular totais de todos os jogadores
      </button>
    </form>

  </section>
</div>

<!-- Scripts: Cropper + lógica -->
<script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>

<script>
  (function () {
    // ============
    // EDITAR JOGADOR
    // ============
    const playerForm = document.getElementById("playerForm");
    const playerFormTitle = document.getElementById("playerFormTitle");
    const playerFormHint = document.getElementById("playerFormHint");
    const playerSubmit = document.getElementById("playerFormSubmit");
    const playerCancelEdit = document.getElementById("playerCancelEdit");
    const playerPhotoBlock = document.getElementById("playerPhotoBlock");

    const inputName = playerForm.querySelector('input[name="name"]');
    const inputNickname = playerForm.querySelector('input[name="nickname"]');
    const selectPosition = playerForm.querySelector('select[name="position"]');
    const inputPhoto = playerForm.querySelector('input[name="photo"]');

    const originalAction = "/admin/players";

    function setCreateMode() {
      playerForm.setAttribute("action", originalAction);
      playerForm.setAttribute("enctype", "multipart/form-data");
      playerFormTitle.textContent = "Novo Jogador";
      playerFormHint.textContent = "Preencha para cadastrar um novo jogador.";
      playerSubmit.textContent = "Adicionar Jogador";
      playerCancelEdit.classList.add("hidden");
      if (playerPhotoBlock) playerPhotoBlock.classList.remove("hidden");

      inputName.value = "";
      inputNickname.value = "";
      selectPosition.value = "Goleiro";
      if (inputPhoto) inputPhoto.value = "";
    }

    function setEditMode({ id, name, nickname, position }) {
      playerForm.setAttribute("action", "/admin/players/" + id + "/edit");
      playerForm.removeAttribute("enctype");
      playerFormTitle.textContent = "Editar Jogador";
      playerFormHint.textContent =
        'Editando o jogador selecionado. Clique em "Cancelar edição" para voltar ao modo de cadastro.';
      playerSubmit.textContent = "Salvar alterações";
      playerCancelEdit.classList.remove("hidden");
      if (playerPhotoBlock) playerPhotoBlock.classList.add("hidden");

      inputName.value = name || "";
      inputNickname.value = nickname || "";
      selectPosition.value = position || "Goleiro";
      if (inputPhoto) inputPhoto.value = "";

      playerForm.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    document.querySelectorAll("[data-player-edit]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-id");
        const name = btn.getAttribute("data-name") || "";
        const nickname = btn.getAttribute("data-nickname") || "";
        const position = btn.getAttribute("data-position") || "Goleiro";

        setEditMode({ id, name, nickname, position });
      });
    });

    playerCancelEdit.addEventListener("click", () => {
      setCreateMode();
    });

    // começa em modo criar
    setCreateMode();

    // ============
    // EDITAR WEEKLY
    // ============
    const weeklyForm = document.getElementById("weeklyForm");
    const weeklyWeekStart = document.getElementById("weekly_weekStart");
    const weeklyBestPlayer = document.getElementById("weekly_bestPlayer");
    const weeklyMatch = document.getElementById("weekly_match");

    document.querySelectorAll("[data-weekly-edit]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const weekStart = btn.getAttribute("data-weekstart");
        const bestId = btn.getAttribute("data-best-id") || "";
        const matchId = btn.getAttribute("data-match-id") || "";

        if (weekStart) weeklyWeekStart.value = weekStart;
        weeklyBestPlayer.value = bestId;
        weeklyMatch.value = matchId;

        weeklyForm.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    });

    // ============
    // EDITAR MONTHLY
    // ============
    const monthlyForm = document.getElementById("monthlyForm");
    const monthlyMonth = document.getElementById("monthly_month");
    const monthlyYear = document.getElementById("monthly_year");
    const monthlyCraque = document.getElementById("monthly_craque");

    document.querySelectorAll("[data-monthly-edit]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const month = btn.getAttribute("data-month") || "";
        theYear = btn.getAttribute("data-year") || "";
        const playerId = btn.getAttribute("data-player-id") || "";

        monthlyMonth.value = month;
        if (theYear) monthlyYear.value = theYear;
        monthlyCraque.value = playerId;

        monthlyForm.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    });

    // ============
    // CROP DA FOTO DO TIME DA SEMANA
    // ============
    const input = document.getElementById("weekly_teamPhotoInput");
    const container = document.getElementById("teamPhotoCropContainer");
    const img = document.getElementById("teamPhotoCropImage");
    const applyBtn = document.getElementById("applyTeamPhotoCrop");
    const doneMsg = document.getElementById("teamPhotoCropDone");

    let cropper = null;
    let originalFileName = null;

    if (input && container && img && applyBtn) {
      input.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith("image/")) {
          return;
        }

        originalFileName = file.name || "time-semana.jpg";

        const reader = new FileReader();
        reader.onload = function (ev) {
          img.src = ev.target.result;
          container.classList.remove("hidden");
          doneMsg.classList.add("hidden");

          if (cropper) {
            cropper.destroy();
            cropper = null;
          }

          if (typeof Cropper === "undefined") {
            alert(
              "Ferramenta de corte não carregou. Verifique sua conexão com a internet."
            );
            return;
          }

          cropper = new Cropper(img, {
            aspectRatio: 16 / 9,
            viewMode: 1,
            autoCropArea: 1,
            dragMode: "move",
          });
        };
        reader.readAsDataURL(file);
      });

      applyBtn.addEventListener("click", function () {
        if (!cropper) {
          return;
        }

        const canvas = cropper.getCroppedCanvas({
          width: 1280,
          height: 720,
        });

        canvas.toBlob(
          function (blob) {
            if (!blob) {
              return;
            }

            const file = new File([blob], originalFileName, {
              type: "image/jpeg",
              lastModified: Date.now(),
            });

            const dt = new DataTransfer();
            dt.items.add(file);
            input.files = dt.files;

            doneMsg.classList.remove("hidden");
          },
          "image/jpeg",
          0.9
        );
      });
    }

    // ============
    // COLAPSE: Jogadores / Peladas
    // ============
    function setupCollapse(targetId, labelType) {
      const trigger = document.querySelector(
        `[data-collapse-trigger="${targetId}"]`
      );
      const target = document.querySelector(
        `[data-collapse-target="${targetId}"]`
      );
      if (!trigger || !target) return;

      let labelEl = null;
      if (labelType === "players") {
        labelEl = trigger.querySelector("[data-collapse-label-players]");
      } else if (labelType === "matches") {
        labelEl = trigger.querySelector("[data-collapse-label-matches]");
      }

      function updateLabel() {
        if (!labelEl) return;
        const hidden = target.classList.contains("hidden");
        labelEl.textContent = hidden ? "Mostrar lista" : "Esconder lista";
      }

      updateLabel();

      trigger.addEventListener("click", () => {
        target.classList.toggle("hidden");
        updateLabel();
      });
    }

    setupCollapse("players-list", "players");
    setupCollapse("matches-list", "matches");
  })();
</script>
