<%# views/vote_page.ejs %>

<% if (error) { %>
  <div class="text-center p-8 bg-red-900/20 rounded-lg">
    <h1 class="text-xl font-bold text-red-400">Erro</h1>
    <p class="mt-2 text-horriver-light"><%= error %></p>
    <a href="/" class="mt-4 inline-block px-4 py-2 text-sm font-semibold text-white bg-horriver-orange rounded-lg">Voltar para Home</a>
  </div>
<% } else if (success) { %>
  <div class="text-center p-8 bg-green-900/20 rounded-lg">
    <h1 class="text-xl font-bold text-green-400">Voto computado!</h1>
    <p class="mt-2 text-horriver-light">Obrigado pela sua participa��o.</p>
    <a href="/" class="mt-4 inline-block px-4 py-2 text-sm font-semibold text-white bg-horriver-orange rounded-lg">Voltar para Home</a>
  </div>
<% } else { %>

  <h1 class="text-2xl font-bold text-center text-horriver-orange">Vota��o da Pelada</h1>
  <p class="text-center text-horriver-gray mb-8">Partida de <%= new Date(match.playedAt).toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' }) %></p>

  <form id="vote-form" method="POST" action="/vote/match/<%= match.id %>/<%= token %>" class="space-y-8">
    <% const blocks = (groupedOrder && groupedOrder.length) ? groupedOrder : Object.keys(grouped || {}).map(k => ({label:k, list: grouped[k]})); %>
    <% blocks.forEach(({label, list}) => { if (!list || !list.length) return; const labelId = String(label).toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, ""); %>
      <div class="p-4 bg-black/30 rounded-lg border border-horriver-border">
        <h2 class="text-lg font-semibold mb-3 text-horriver-light">Arraste para rankear - <span class="text-horriver-orange"><%= label %></span></h2>
        <ul id="rank-<%= labelId %>" class="space-y-2 player-list" data-label="<%= label %>" data-input-id="input-rank-<%= labelId %>" aria-live="polite">
          <% list.forEach(player => { %>
            <li id="<%= player.id %>" data-id="<%= player.id %>" class="p-3 bg-horriver-dark rounded-md cursor-grab flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
              <div class="flex items-center gap-3 min-w-0">
                <img
                  src="<%= thumbUrl(player.photoUrl || '/img/logo-128x128.svg', 80) %>"
                  srcset="<%= thumbUrl(player.photoUrl || '/img/logo-128x128.svg', 80) %> 1x, <%= thumbUrl(player.photoUrl || '/img/logo-128x128.svg', 160) %> 2x"
                  sizes="40px"
                  class="w-10 h-10 rounded-full object-cover"
                  alt="<%= player.name %>"
                  width="40"
                  height="40"
                >
                <div class="min-w-0">
                  <span class="font-medium text-horriver-light"><%= player.name %></span>
                  <% if (player.nickname) { %>
                    <p class="text-[11px] text-horriver-gray"><%= player.nickname %></p>
                  <% } %>
                  <p class="text-[11px] text-horriver-gray">
                    Gols: <span class="text-horriver-orange"><%= player.goals %></span>
                    � Ast: <span class="text-horriver-orange"><%= player.assists %></span>
                    <% if (player.appearedInPhoto) { %> � <span title="Saiu na foto">??</span><% } %>
                  </p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <div class="text-xs text-horriver-gray">
                  Pos: <span class="text-horriver-orange"><%= player.positionLabel || player.position %></span>
                </div>
                <div class="flex items-center gap-1">
                  <button type="button" class="px-2 py-1 text-[10px] rounded-md border border-horriver-border text-horriver-gray hover:text-horriver-orange" data-move="up" aria-label="Mover para cima">?</button>
                  <button type="button" class="px-2 py-1 text-[10px] rounded-md border border-horriver-border text-horriver-gray hover:text-horriver-orange" data-move="down" aria-label="Mover para baixo">?</button>
                </div>
              </div>
            </li>
          <% }) %>
        </ul>
        <input type="hidden" name="rank-<%= label %>" id="input-rank-<%= labelId %>">
      </div>
    <% }) %>

    <div class="p-4 bg-black/30 rounded-lg border border-horriver-border">
      <h2 class="text-lg font-semibold mb-3 text-horriver-light">? Craque da Pelada (MVP)</h2>
      <select name="mvpPlayerId" class="w-full p-3 bg-horriver-dark rounded-md border border-horriver-border text-horriver-light">
        <option value="">-- Escolha o melhor jogador --</option>
        <% players.forEach(player => { %>
          <option value="<%= player.id %>"><%= player.name %></option>
        <% }) %>
      </select>
    </div>

    <div class="text-center">
      <button
        type="submit"
        data-submit-label="Enviando..."
        class="w-full sm:w-auto px-8 py-3 bg-horriver-orange text-black font-bold rounded-lg transition hover:bg-orange-500 active:scale-[0.98]"
      >
        Enviar Voto
      </button>
    </div>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('vote-form');
      const playerLists = document.querySelectorAll('.player-list');

      playerLists.forEach(list => {
        new Sortable(list, {
          animation: 150,
          ghostClass: 'bg-horriver-orange/30'
        });
      });

      form.addEventListener('submit', function () {
        playerLists.forEach(list => {
          const inputId = list.dataset.inputId;
          const hiddenInput = inputId ? document.getElementById(inputId) : null;
          if (!hiddenInput) return;
          const sortableInstance = Sortable.get(list);
          const playerIds = sortableInstance.toArray();
          hiddenInput.value = playerIds.join(',');
        });
      });

      playerLists.forEach((list) => {
        list.addEventListener("click", (event) => {
          const btn = event.target.closest("button[data-move]");
          if (!btn) return;
          const item = btn.closest("li");
          if (!item) return;
          const direction = btn.dataset.move;
          if (direction === "up" && item.previousElementSibling) {
            list.insertBefore(item, item.previousElementSibling);
          } else if (direction === "down" && item.nextElementSibling) {
            list.insertBefore(item.nextElementSibling, item);
          }
        });
      });
    });
  </script>
<% } %>



