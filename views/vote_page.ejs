<%# views/vote_page.ejs %>

<% if (error) { %>
  <div class="text-center p-8 bg-red-900/20 rounded-lg">
    <h1 class="text-xl font-bold text-red-400">Erro</h1>
    <p class="mt-2 text-horriver-light"><%= error %></p>
    <a href="/" class="mt-4 inline-block px-4 py-2 text-sm font-semibold text-white bg-horriver-orange rounded-lg">Voltar para Home</a>
  </div>
<% } else if (success) { %>
  <div class="text-center p-8 bg-green-900/20 rounded-lg">
    <h1 class="text-xl font-bold text-green-400">Voto computado!</h1>
    <p class="mt-2 text-horriver-light">Obrigado pela sua participa√ß√£o.</p>
    <a href="/" class="mt-4 inline-block px-4 py-2 text-sm font-semibold text-white bg-horriver-orange rounded-lg">Voltar para Home</a>
  </div>
<% } else { %>

  <h1 class="text-2xl font-bold text-center text-horriver-orange">Vota√ß√£o da Pelada</h1>
  <p class="text-center text-horriver-gray mb-8">Partida de <%= new Date(match.playedAt).toLocaleDateString('pt-BR') %></p>

  <form id="vote-form" method="POST" action="/vote/match/<%= match.id %>?token=<%= token %>" class="space-y-8">
    <% const blocks = (groupedOrder && groupedOrder.length) ? groupedOrder : Object.keys(grouped || {}).map(k => ({label:k, list: grouped[k]})); %>
    <% blocks.forEach(({label, list}) => { if (!list || !list.length) return; %>
      <div class="p-4 bg-black/30 rounded-lg border border-horriver-border">
        <h2 class="text-lg font-semibold mb-3 text-horriver-light">Arraste para rankear - <span class="text-horriver-orange"><%= label %></span></h2>
        <ul id="rank-<%= label %>" class="space-y-2 player-list">
          <% list.forEach(player => { %>
            <li id="<%= player.id %>" data-id="<%= player.id %>" class="p-3 bg-horriver-dark rounded-md cursor-grab flex items-center gap-3 justify-between">
              <div class="flex items-center gap-3">
                <img src="<%= player.photoUrl || '/img/logo-128x128.svg' %>" class="w-10 h-10 rounded-full object-cover" alt="<%= player.name %>">
                <div>
                  <span class="font-medium text-horriver-light"><%= player.name %></span>
                  <% if (player.nickname) { %>
                    <p class="text-[11px] text-horriver-gray"><%= player.nickname %></p>
                  <% } %>
                  <p class="text-[11px] text-horriver-gray">
                    Gols: <span class="text-horriver-orange"><%= player.goals %></span>
                    ¬∑ Ast: <span class="text-horriver-orange"><%= player.assists %></span>
                    <% if (player.appearedInPhoto) { %> ¬∑ <span title="Saiu na foto">üì∏</span><% } %>
                  </p>
                </div>
              </div>
              <div class="text-xs text-horriver-gray">
                Pos: <span class="text-horriver-orange"><%= player.positionLabel || player.position %></span>
              </div>
            </li>
          <% }) %>
        </ul>
        <input type="hidden" name="rank-<%= label %>" id="input-rank-<%= label %>">
      </div>
    <% }) %>

    <div class="p-4 bg-black/30 rounded-lg border border-horriver-border">
      <h2 class="text-lg font-semibold mb-3 text-horriver-light">‚≠ê Craque da Pelada (MVP)</h2>
      <select name="mvpPlayerId" class="w-full p-3 bg-horriver-dark rounded-md border border-horriver-border text-horriver-light">
        <option value="">-- Escolha o melhor jogador --</option>
        <% players.forEach(player => { %>
          <option value="<%= player.id %>"><%= player.name %></option>
        <% }) %>
      </select>
    </div>

    <div class="text-center">
      <button type="submit" class="px-8 py-3 bg-horriver-orange text-black font-bold rounded-lg transition hover:bg-orange-500">
        Enviar Voto
      </button>
    </div>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('vote-form');
      const playerLists = document.querySelectorAll('.player-list');

      playerLists.forEach(list => {
        new Sortable(list, {
          animation: 150,
          ghostClass: 'bg-horriver-orange/30'
        });
      });

      form.addEventListener('submit', function () {
        playerLists.forEach(list => {
          const position = list.id.replace('rank-', '');
          const hiddenInput = document.getElementById('input-rank-' + position);
          const sortableInstance = Sortable.get(list);
          const playerIds = sortableInstance.toArray();
          hiddenInput.value = playerIds.join(',');
        });
      });
    });
  </script>
<% } %>
