<%
// views/admin_match.ejs
// Variáveis recebidas: match, players, stats
// O layout.ejs já cuida de <html>, <body>, header, footer etc.
// Aqui é só o conteúdo interno do <main>.
  const fmtDateTimeBR = (d) =>
    d ? new Date(d).toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo" }) : "-";
%>

<div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
  <div>
    <h1 class="text-xl md:text-2xl font-semibold text-horriver-light">
      Estatísticas da pelada
    </h1>
    <p class="text-xs md:text-sm text-horriver-gray mt-1">
      Data:
      <span class="text-horriver-orange font-medium">
        <%= new Date(match.playedAt).toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' }) %>
      </span>
      <% if (match.description) { %>
      · <%= match.description %>
      <% } %>
    </p>
  </div>

  <a
    href="/admin"
    class="w-full sm:w-auto text-center px-3 py-2 rounded-full border border-horriver-orange text-[11px] md:text-xs text-horriver-orange hover:bg-horriver-orange hover:text-horriver-bg transition"
  >
    Voltar ao painel
  </a>
</div>

<div class="sticky top-20 z-40 bg-black/70 border border-horriver-border rounded-2xl px-4 py-3 mb-4">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 text-[11px]">
    <span class="text-horriver-gray uppercase tracking-[0.2em]">Acoes rapidas</span>
    <div class="flex items-center gap-2 flex-wrap sm:flex-nowrap sm:overflow-visible overflow-x-auto whitespace-nowrap pb-1">
      <a href="#stats" class="px-3 py-1 rounded-full border border-horriver-border text-horriver-light hover:border-horriver-orange hover:text-horriver-orange transition">Stats</a>
      <a href="#votacao" class="px-3 py-1 rounded-full border border-horriver-border text-horriver-light hover:border-horriver-orange hover:text-horriver-orange transition">Votacao</a>
      <a href="#sorteador" class="px-3 py-1 rounded-full border border-horriver-border text-horriver-light hover:border-horriver-orange hover:text-horriver-orange transition">Sorteador</a>
      <button type="submit" form="statsForm" class="px-3 py-1 rounded-full bg-horriver-orange text-black font-semibold hover:bg-orange-500 transition">Salvar stats</button>
      <a href="/admin" class="px-3 py-1 rounded-full border border-horriver-border text-horriver-light hover:border-horriver-orange hover:text-horriver-orange transition">Cancelar</a>
    </div>
  </div>
</div>

<div id="stats" class="scroll-mt-20"></div>

<form
  action="/admin/matches/<%= match.id %>/stats/bulk"
  method="POST"
  id="statsForm"
  class="space-y-4"
  data-autosave="true"
  data-toast="Estatisticas salvas."
>
  <div class="bg-black/40 border border-horriver-border rounded-xl p-3 text-[12px] text-horriver-gray">
    <label class="flex flex-col gap-1 w-full sm:max-w-[240px]">
      Cor do time vencedor (opcional)
      <select
        name="winnerColor"
        class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light"
      >
        <option value="" <%= !match.winnerColor ? "selected" : "" %>>Nenhuma</option>
        <option value="Amarelo" <%= match.winnerColor === "Amarelo" ? "selected" : "" %>>Amarelo</option>
        <option value="Azul" <%= match.winnerColor === "Azul" ? "selected" : "" %>>Azul</option>
        <option value="Preto" <%= match.winnerColor === "Preto" ? "selected" : "" %>>Preto</option>
        <option value="Vermelho" <%= match.winnerColor === "Vermelho" ? "selected" : "" %>>Vermelho</option>
        
      </select>
    </label>
  </div>
  <div class="flex flex-wrap items-center gap-3 text-xs text-horriver-gray">
    <label class="flex items-center gap-2">
      <input
        type="checkbox"
        id="filterPresentOnly"
        class="w-4 h-4 accent-horriver-orange"
      />
      Mostrar so presentes (desmarque para editar)
    </label>
    <span id="presentCount"></span>
  </div>
  <div class="hidden sm:block overflow-x-auto rounded-2xl border border-horriver-border bg-black/50">
    <table class="min-w-full text-xs md:text-sm">
      <thead class="bg-black/60">
        <tr>
          <th class="px-3 py-3 text-left font-semibold text-horriver-gray">Jogador</th>
          <th class="px-3 py-3 text-center font-semibold text-horriver-gray">OVR</th>
          <th class="px-3 py-3 text-center font-semibold text-horriver-gray">Presente</th>
          <th class="px-3 py-3 text-center font-semibold text-horriver-gray">Gols</th>
          <th class="px-3 py-3 text-center font-semibold text-horriver-gray">Assistências</th>
          <th class="px-3 py-3 text-center font-semibold text-horriver-gray">Nota</th>
          <th class="px-3 py-3 text-center font-semibold text-horriver-gray">Foto</th>
        </tr>
      </thead>
      <tbody>
        <% players.forEach(function(player) { 
             const stat = stats.find(s => s.playerId === player.id);
        %>
        <tr class="border-t border-horriver-border/40 hover:bg-white/5 transition">
          <td class="px-3 py-2">
            <div class="flex flex-col">
              <span class="font-medium text-horriver-light"><%= player.name %></span>
              <% if (player.nickname) { %>
                <span class="text-[11px] text-horriver-gray">"<%= player.nickname %>"</span>
              <% } %>
              <span class="text-[10px] uppercase text-horriver-orange mt-1"><%= player.position %></span>
            </div>
          </td>
          <td class="px-3 py-2 text-center align-middle">
            <% if (player.overall != null) { %>
              <span class="px-2 py-1 rounded-full bg-horriver-orange text-black text-[11px] font-semibold"><%= player.overall %></span>
            <% } else { %>
              <span class="text-horriver-gray text-[11px]">-</span>
            <% } %>
          </td>
          <td class="px-3 py-2 text-center align-middle">
            <input
              type="checkbox"
              name="present_<%= player.id %>"
              data-player-name="<%= player.name %>"
              data-player-position="<%= player.position %>"
              data-player-strength="<%= player.overall != null ? player.overall : '' %>"
              data-input-scope="desktop"
              class="w-5 h-5 sm:w-4 sm:h-4 accent-horriver-orange"
              <%= stat && stat.present ? 'checked' : '' %>
            />
          </td>
          <td class="px-3 py-2 text-center align-middle">
            <input
              type="number"
              name="goals_<%= player.id %>"
              min="0"
              step="1"
              data-input-scope="desktop"
              class="w-20 sm:w-16 bg-black/40 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs md:text-sm"
              value="<%= stat && stat.goals ? stat.goals : '' %>"
            />
          </td>
          <td class="px-3 py-2 text-center align-middle">
            <input
              type="number"
              name="assists_<%= player.id %>"
              min="0"
              step="1"
              data-input-scope="desktop"
              class="w-20 sm:w-16 bg-black/40 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs md:text-sm"
              value="<%= stat && stat.assists ? stat.assists : '' %>"
            />
          </td>
          <td class="px-3 py-2 text-center align-middle">
            <input
              type="text"
              name="rating_<%= player.id %>"
              inputmode="decimal"
              data-input-scope="desktop"
              class="w-24 sm:w-20 bg-black/40 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs md:text-sm"
              placeholder="7,50"
              value="<%= stat && (stat.rating != null || stat.finalRating != null) ? (stat.rating != null ? stat.rating : stat.finalRating).toFixed(2).replace('.', ',') : '' %>"
            />
          </td>
          <td class="px-3 py-2 text-center align-middle">
            <input
              type="checkbox"
              name="photo_<%= player.id %>"
              data-input-scope="desktop"
              class="w-5 h-5 sm:w-4 sm:h-4 accent-horriver-orange"
              <%= stat && stat.appearedInPhoto ? 'checked' : '' %>
            />
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <div class="sm:hidden space-y-3">
    <% players.forEach(function(player) { 
         const stat = stats.find(s => s.playerId === player.id);
    %>
      <div class="rounded-2xl border border-horriver-border bg-black/50 p-3" data-player-card>
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-sm font-semibold text-horriver-light"><%= player.name %></p>
            <% if (player.nickname) { %>
              <p class="text-[11px] text-horriver-gray">"<%= player.nickname %>"</p>
            <% } %>
            <p class="text-[10px] uppercase text-horriver-orange mt-1"><%= player.position %></p>
          </div>
          <div>
            <% if (player.overall != null) { %>
              <span class="px-2 py-1 rounded-full bg-horriver-orange text-black text-[11px] font-semibold"><%= player.overall %></span>
            <% } else { %>
              <span class="text-horriver-gray text-[11px]">-</span>
            <% } %>
          </div>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-2 text-[11px]">
          <label class="flex items-center justify-between gap-2 rounded-xl border border-horriver-border/60 bg-black/40 px-3 py-2">
            <span>Presente</span>
            <input
              type="checkbox"
              name="present_<%= player.id %>"
              data-player-name="<%= player.name %>"
              data-player-position="<%= player.position %>"
              data-player-strength="<%= player.overall != null ? player.overall : '' %>"
              data-input-scope="mobile"
              class="w-5 h-5 accent-horriver-orange"
              <%= stat && stat.present ? 'checked' : '' %>
            />
          </label>

          <label class="flex items-center justify-between gap-2 rounded-xl border border-horriver-border/60 bg-black/40 px-3 py-2">
            <span>Foto</span>
            <input
              type="checkbox"
              name="photo_<%= player.id %>"
              data-input-scope="mobile"
              class="w-5 h-5 accent-horriver-orange"
              <%= stat && stat.appearedInPhoto ? 'checked' : '' %>
            />
          </label>

          <label class="flex flex-col gap-1 rounded-xl border border-horriver-border/60 bg-black/40 px-3 py-2">
            <span>Gols</span>
            <input
              type="number"
              name="goals_<%= player.id %>"
              min="0"
              step="1"
              data-input-scope="mobile"
              class="w-full bg-black/20 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs"
              value="<%= stat && stat.goals ? stat.goals : '' %>"
            />
          </label>

          <label class="flex flex-col gap-1 rounded-xl border border-horriver-border/60 bg-black/40 px-3 py-2">
            <span>Assist.</span>
            <input
              type="number"
              name="assists_<%= player.id %>"
              min="0"
              step="1"
              data-input-scope="mobile"
              class="w-full bg-black/20 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs"
              value="<%= stat && stat.assists ? stat.assists : '' %>"
            />
          </label>

          <label class="col-span-2 flex flex-col gap-1 rounded-xl border border-horriver-border/60 bg-black/40 px-3 py-2">
            <span>Nota</span>
            <input
              type="text"
              name="rating_<%= player.id %>"
              inputmode="decimal"
              data-input-scope="mobile"
              class="w-full bg-black/20 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs"
              placeholder="7,50"
              value="<%= stat && (stat.rating != null || stat.finalRating != null) ? (stat.rating != null ? stat.rating : stat.finalRating).toFixed(2).replace('.', ',') : '' %>"
            />
          </label>
        </div>
      </div>
    <% }); %>
  </div>

  <div class="flex justify-end mt-4">
    <div class="flex flex-col sm:flex-row w-full sm:w-auto items-stretch sm:items-center gap-3">
      <a
        href="/admin/matches/<%= match.id %>/votes"
        class="w-full sm:w-auto text-center px-4 py-2 rounded-full border border-horriver-border text-horriver-light text-xs md:text-sm font-semibold hover:border-horriver-orange hover:text-horriver-orange transition"
      >
        Ver votos
      </a>
      <a
        href="/admin/matches/<%= match.id %>/awards"
        class="w-full sm:w-auto text-center px-4 py-2 rounded-full border border-horriver-orange/60 text-horriver-orange text-xs md:text-sm font-semibold hover:bg-horriver-orange hover:text-black transition shadow-card-soft"
      >
        Ver prêmios / baixar imagem
      </a>
      <button
        type="submit"
        class="w-full sm:w-auto px-4 py-2 rounded-full bg-horriver-orange text-horriver-bg text-xs md:text-sm font-semibold hover:bg-orange-500 transition shadow-card-soft"
      >
        Salvar estatísticas
      </button>
    </div>
  </div>
</form>

<!-- ========================= -->
<!-- Votação: geração de links -->
<!-- ========================= -->
<section id="votacao" class="mt-10 space-y-4">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h2 class="text-lg md:text-xl font-semibold text-horriver-light">
        Votação da pelada
      </h2>
      <p class="text-xs text-horriver-gray">
        Gera links únicos para os jogadores presentes votarem (via WhatsApp).
      </p>
    </div>
    <form
      action="/admin/matches/<%= match.id %>/vote-session"
      method="POST"
      class="flex flex-col sm:flex-row sm:items-center gap-2 text-[11px] w-full sm:w-auto"
      data-autosave="true"
      data-toast="Links de votacao gerados."
    >
      <label class="flex items-center gap-1 text-horriver-gray">
        Expira em (horas):
        <input
          type="number"
          name="expiresHours"
          min="0"
          value="24"
          class="w-full sm:w-16 bg-black/50 border border-horriver-border rounded px-2 py-1 text-horriver-light"
        />
      </label>
      <button
        type="submit"
        class="w-full sm:w-auto px-3 py-2 rounded-full bg-horriver-orange text-black font-semibold hover:bg-orange-500 transition"
      >
        Gerar links
      </button>
    </form>
  </div>

  <% if (!voteSession || !voteSession.tokens || !voteSession.tokens.length) { %>
    <p class="text-sm text-horriver-gray">
      Nenhuma sessão de votação criada ainda. Gere os links após marcar os presentes.
    </p>
  <% } else { %>
    <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3 text-[12px]">
      <form
        action="/admin/matches/<%= match.id %>/apply-votes"
        method="POST"
        class="flex items-center gap-2"
        data-toast="Votos aplicados."
        onsubmit="return confirm('Aplicar notas baseadas na votação? Não sobrescreve notas já lançadas.');"
      >
        <button
          type="submit"
          class="px-3 py-2 rounded-full bg-horriver-orange text-black font-semibold hover:bg-orange-500 transition"
        >
          Aplicar votos como notas
        </button>
        <span class="text-horriver-gray text-[11px]">
          Calcula notas para presentes (não altera notas já preenchidas).
        </span>
      </form>

      <form
        action="/admin/matches/<%= match.id %>/close-votes"
        method="POST"
        class="flex items-center gap-2"
        data-toast="Votacao encerrada."
        onsubmit="return confirm('Encerrar a votação agora? Links restantes serão bloqueados.');"
      >
        <button
          type="submit"
          class="px-3 py-2 rounded-full bg-red-600 text-white font-semibold hover:bg-red-500 transition"
        >
          Encerrar votação
        </button>
        <span class="text-horriver-gray text-[11px]">
          Expira a sessão e bloqueia links não usados.
        </span>
      </form>
    </div>

    <div class="bg-black/40 border border-horriver-border rounded-2xl p-4 w-full">
      <p class="text-xs text-horriver-gray mb-2">
        Sessão criada em <%= fmtDateTimeBR(voteSession.createdAt) %>
        <% if (voteSession.expiresAt) { %>
          · expira em <%= fmtDateTimeBR(voteSession.expiresAt) %>
        <% } else { %>
          · sem expiração
        <% } %>
      </p>

      <div class="overflow-x-auto text-[11px] md:text-xs w-full">
        <table class="w-full min-w-[640px] border-collapse">
          <thead>
            <tr class="border-b border-horriver-border/60 text-horriver-gray/80">
              <th class="py-2 pr-3 text-left font-normal">Jogador</th>
              <th class="py-2 pr-3 text-left font-normal">Posição</th>
              <th class="py-2 pr-3 text-left font-normal">Link</th>
              <th class="py-2 pr-3 text-left font-normal">WhatsApp</th>
              <th class="py-2 pr-3 text-left font-normal">Votou</th>
            </tr>
          </thead>
          <tbody>
            <% voteSession.tokens.forEach((t) => {
                 const link = `${voteBaseUrl}/vote/${t.token}`;
                 const waRaw = t.player.whatsapp || "";
                 const waDigits = waRaw.replace(/\\D/g, "");
                 const msg = `Fala ${t.player.name}! Seu link de votação da pelada: ${link}`;
                 const waUrl = waDigits ? `https://wa.me/${waDigits}?text=${encodeURIComponent(msg)}` : null;
            %>
                <tr class="border-b border-horriver-border/40 last:border-0">
                <td class="py-2 pr-3 text-horriver-light">
                  <%= t.player.name %>
                  <% if (t.player.nickname) { %>
                    (<%= t.player.nickname %>)
                  <% } %>
                </td>
                <td class="py-2 pr-3 text-horriver-orange/90 text-[10px] uppercase whitespace-nowrap">
                  <%= t.player.position %>
                </td>
                <td class="py-2 pr-3">
                  <a
                    href="<%= link %>"
                    target="_blank"
                    class="text-horriver-orange hover:underline break-all"
                  >
                    <%= link %>
                  </a>
                </td>
                <td class="py-2 pr-3 whitespace-nowrap">
                  <% if (waUrl) { %>
                    <a
                      href="<%= waUrl %>"
                      target="_blank"
                      class="inline-flex items-center px-3 py-1 rounded-full bg-horriver-red text-white hover:bg-horriver-orange transition"
                    >
                      Mandar link
                    </a>
                  <% } else { %>
                    <span class="text-horriver-gray">Sem número</span>
                  <% } %>
                </td>
                <td class="py-2 pr-3">
                  <% if (t.usedAt) { %>
                    <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-emerald-500/20 text-emerald-300 text-[11px]">✓</span>
                  <% } else { %>
                    <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-white/10 text-horriver-gray text-[11px]">—</span>
                  <% } %>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>
  <% } %>
</section>

<!-- ========================= -->
<!-- Sorteador de times (beta) -->
<section id="sorteador" class="mt-10 space-y-4">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h2 class="text-lg md:text-xl font-semibold text-horriver-light">
        Sorteador inteligente de times
      </h2>
      <p class="text-xs text-horriver-gray">
        Usa o mesmo overall do ranking e trava 6 jogadores por time. Convidados entram só no sorteio (não salvam no banco).
      </p>
    </div>
  </div>

  <div class="bg-black/40 border border-horriver-border rounded-2xl p-4 space-y-3">
    <form id="sorterForm" class="space-y-3 text-[12px]">
      <div class="grid md:grid-cols-2 gap-3">
        <div class="space-y-2">
          <p class="text-horriver-gray text-[12px]">Convidados (só para este sorteio)</p>
          <div class="bg-black/30 border border-horriver-border rounded-xl p-3 space-y-2">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <label class="flex flex-col gap-1 text-horriver-gray">
                Nome
                <input
                  type="text"
                  id="guestName"
                  class="bg-horriver-dark border border-horriver-border rounded px-2 py-1 text-horriver-light"
                  placeholder="Ex: Convidado"
                />
              </label>
              <label class="flex flex-col gap-1 text-horriver-gray">
                Posição
                <select
                  id="guestPos"
                  class="bg-horriver-dark border border-horriver-border rounded px-2 py-1 text-horriver-light"
                >
                  <option>Goleiro</option>
                  <option>Zagueiro</option>
                  <option>Meia</option>
                  <option>Atacante</option>
                  <option>Outros</option>
                </select>
              </label>
            </div>
            <label class="flex flex-col gap-1 text-horriver-gray">
              Força (40-100)
              <input
                type="number"
                id="guestStr"
                min="40"
                max="100"
                value="60"
                class="bg-horriver-dark border border-horriver-border rounded px-2 py-1 text-horriver-light w-full sm:w-24"
              />
            </label>
            <button
              type="button"
              id="addGuestBtn"
              class="w-full sm:w-auto px-3 py-2 rounded-full bg-horriver-orange text-black font-semibold hover:bg-orange-500 transition"
            >
              Adicionar convidado
            </button>
            <input type="hidden" name="guests" id="guestsField" />
            <div id="guestList" class="flex flex-wrap gap-2 text-[11px]"></div>
          </div>
        </div>

                <div class="flex flex-col gap-2">
          <p class="text-horriver-gray text-[12px]">
            Sorteio automático usando os presentes marcados acima. Se tiver mais de 12 presentes, cria 2, 3 ou 4 times com 6 em cada; extras vão para o banco.
          </p>
          <div class="space-y-1 text-[11px]">
            <p class="text-horriver-gray">
              Marque os cabeças de chave (entre os presentes) para travar um em cada time.
            </p>
            <div
              id="seedList"
              class="bg-black/30 border border-horriver-border rounded-xl p-2 flex flex-wrap gap-2 min-h-[46px]"
            ></div>
            <p class="text-horriver-gray text-[10px]">
              Atualiza automaticamente ao marcar/desmarcar presença.
            </p>
          </div>
          <div class="flex items-center gap-2 flex-wrap">
            <button
              type="button"
              id="sortBtn"
              class="w-full sm:w-auto px-3 py-2 rounded-full bg-horriver-orange text-black font-semibold hover:bg-orange-500 transition"
            >
              Sortear times
            </button>
            <span id="sorterStatus" class="text-horriver-gray"></span>
          </div>
        </div>

    <div class="space-y-3 w-full md:col-span-2">
      <div class="grid gap-3 text-[12px] w-full [grid-template-columns:repeat(auto-fit,minmax(260px,1fr))] sm:[grid-template-columns:repeat(auto-fit,minmax(320px,1fr))]" id="sorterResults"></div>

      <div class="grid gap-3">
        <div id="goalkeeperBenchBox" class="hidden w-full text-[12px] border border-horriver-border/60 rounded-xl p-3 bg-black/30"></div>
        <div id="availableBox" class="hidden w-full text-[12px] border border-horriver-border/60 rounded-xl p-3 bg-black/30"></div>
        <div id="benchBox" class="hidden text-[12px] border border-horriver-border/60 rounded-xl p-3 bg-black/30"></div>
      </div>

      <div id="sorterShare" class="hidden flex flex-wrap items-center gap-2 text-[12px]">
        <button
          type="button"
          id="copyTeamsBtn"
          class="px-3 py-2 rounded-full bg-horriver-orange text-black font-semibold hover:bg-orange-500 transition"
        >
          Copiar texto
        </button>
        <button
          type="button"
          id="saveTeamsBtn"
          class="px-3 py-2 rounded-full bg-green-500 text-black font-semibold hover:bg-green-400 transition"
        >
          Salvar times
        </button>
        <button
          type="button"
          id="imgTeamsBtn"
          class="px-3 py-2 rounded-full border border-horriver-border text-horriver-light font-semibold hover:border-horriver-orange hover:text-horriver-orange transition"
        >
          Baixar imagem
        </button>
        <span id="shareStatus" class="text-horriver-gray"></span>
      </div>
    </form>

      <form
        id="importTournamentForm"
        action="/admin/matches/<%= match.id %>/tournament/import-from-draw"
        method="POST"
        class="hidden flex flex-wrap items-center gap-2 text-[12px]"
      >
        <% for (let i = 0; i < 4; i += 1) { %>
          <input type="hidden" name="teamNames[<%= i %>]" data-import-name data-index="<%= i %>" />
          <input type="hidden" name="teamColors[<%= i %>]" data-import-color data-index="<%= i %>" />
        <% } %>
        <button
          type="submit"
          id="importTournamentBtn"
          class="px-3 py-2 rounded-full bg-horriver-orange text-black font-semibold hover:bg-orange-500 transition"
        >
          Importar times sorteados
        </button>
        <span id="importTournamentStatus" class="text-horriver-gray"></span>
      </form>
    </div>
<script>
  (() => {
    const filterToggle = document.getElementById("filterPresentOnly");
    const countEl = document.getElementById("presentCount");
    if (!filterToggle || !countEl) return;
    const filterStorageKey = "admin_match_<%= match.id %>_filter_present_only";

    const rows = Array.from(document.querySelectorAll("tbody tr"));
    const cards = Array.from(document.querySelectorAll("[data-player-card]"));
    const entries = [
      ...rows.map((row) => ({
        row,
        checkbox: row.querySelector('input[name^="present_"]'),
      })),
      ...cards.map((card) => ({
        row: card,
        checkbox: card.querySelector('input[name^="present_"]'),
      })),
    ].filter((item) => item.checkbox);

    const restoreFilterState = () => {
      try {
        const stored = window.localStorage.getItem(filterStorageKey);
        if (stored === "1") filterToggle.checked = true;
        if (stored === "0") filterToggle.checked = false;
      } catch (_) {
        // Sem acesso ao localStorage (modo privado/restricao): segue sem persistir.
      }
    };

    const persistFilterState = () => {
      try {
        window.localStorage.setItem(filterStorageKey, filterToggle.checked ? "1" : "0");
      } catch (_) {
        // Ignora erro de persistencia para nao quebrar a pagina.
      }
    };

    const update = () => {
      let count = 0;
      entries.forEach(({ row, checkbox }) => {
        if (checkbox.disabled) return;
        const isPresent = checkbox.checked;
        if (isPresent) count += 1;
        row.classList.toggle("hidden", filterToggle.checked && !isPresent);
      });
      countEl.textContent = `${count} presentes selecionados`;
    };

    entries.forEach(({ checkbox }) => {
      checkbox.addEventListener("change", update);
    });
    restoreFilterState();
    filterToggle.addEventListener("change", () => {
      persistFilterState();
      update();
    });
    update();
  })();
</script>


<script>
  window.addEventListener("DOMContentLoaded", () => {
    const buttons = Array.from(document.querySelectorAll("[data-export-target]"));
    if (!buttons.length) return;

    const loadHtml2Canvas = () =>
      new Promise((resolve, reject) => {
        if (typeof html2canvas !== "undefined") return resolve();
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js";
        s.onload = resolve;
        s.onerror = () => reject(new Error("Falha ao carregar html2canvas"));
        document.body.appendChild(s);
      });

    const runExport = async (targetId, name) => {
      const el = document.getElementById(targetId);
      if (!el) return;
      try {
        await loadHtml2Canvas();
        document.body.classList.add("is-exporting");
        el.classList.add("is-exporting");
        await (document.fonts?.ready || Promise.resolve());

        const exportHeight = Math.ceil(el.scrollHeight || el.getBoundingClientRect().height || 0);
        const canvas = await html2canvas(el, {
          backgroundColor: "#0f1115",
          scale: 2,
          height: exportHeight,
          windowHeight: exportHeight,
        });

        const link = document.createElement("a");
        link.download = `${name}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
      } catch (err) {
        console.error(err);
      } finally {
        el.classList.remove("is-exporting");
        document.body.classList.remove("is-exporting");
      }
    };

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        runExport(btn.dataset.exportTarget, btn.dataset.exportName || "tournament");
      });
    });
  });
</script>

<script>
  (function () {
    const mq = window.matchMedia("(max-width: 639px)");
    const toggleInputs = () => {
      const isMobile = mq.matches;
      document.querySelectorAll("[data-input-scope='desktop']").forEach((el) => {
        el.disabled = isMobile;
      });
      document.querySelectorAll("[data-input-scope='mobile']").forEach((el) => {
        el.disabled = !isMobile;
      });
    };
    toggleInputs();
    if (mq.addEventListener) {
      mq.addEventListener("change", toggleInputs);
    } else {
      mq.addListener(toggleInputs);
    }
  })();
</script>

</section>

<!-- ========================= -->
<!-- Torneio -->
<!-- ========================= -->
<section id="tournament" class="mt-10 space-y-4">
  <% const hasTournament = typeof tournament !== "undefined" && tournament; %>
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h2 class="text-lg md:text-xl font-semibold text-horriver-light">
        Torneio
      </h2>
      <p class="text-xs text-horriver-gray">
        Classificacao e jogos do torneio desta pelada.
      </p>
    </div>
    <% if (hasTournament) { %>
      <div class="flex items-center gap-2">
        <button
          type="button"
          class="px-3 py-1.5 rounded-full border border-horriver-border text-[11px] text-horriver-gray hover:border-horriver-orange hover:text-horriver-orange transition"
          data-export-target="tournament-standings-export-admin"
          data-export-name="tournament-classificacao"
        >
          Exportar classificacao
        </button>
        <button
          type="button"
          class="px-3 py-1.5 rounded-full border border-horriver-border text-[11px] text-horriver-gray hover:border-horriver-orange hover:text-horriver-orange transition"
          data-export-target="tournament-games-export-admin"
          data-export-name="tournament-jogos"
        >
          Exportar jogos
        </button>
      </div>
    <% } %>
  </div>

<%
    const tournamentData = typeof tournament !== "undefined" ? tournament : null;
    const standings = Array.isArray(tournamentStandings) ? tournamentStandings : [];
    const games = tournamentData && Array.isArray(tournamentData.games) ? tournamentData.games : [];
    const tournamentTeamList = Array.isArray(tournamentTeams) ? tournamentTeams : [];
    const stages = ["GROUP", "SEMI", "FINAL"];
    const stageLabels = {
      GROUP: "Fase de grupos",
      SEMI: "Semifinais",
      FINAL: "Final",
    };
    const sponsorNameByLabel = {
      Amarelo: "Natureza em Flores",
      Vermelho: "Matheus Gomes Barbearia",
      Azul: "Carrocerias Santana",
      Preto: "Advance Compressores",
    };
    const sponsorStyleByLabel = {
      Amarelo: "color: #facc15;",
      Vermelho: "color: #ef4444;",
      Azul: "color: #3b82f6;",
      Preto: "color: #6b7280;",
    };
    const sponsorColorByLabel = {
      Amarelo: "#facc15",
      Vermelho: "#ef4444",
      Azul: "#3b82f6",
      Preto: "#111111",
    };
    const normalizeSponsorLabel = (value) => {
      const raw = value ? String(value).trim().toLowerCase() : "";
      if (raw.includes("amarelo")) return "Amarelo";
      if (raw.includes("vermelho")) return "Vermelho";
      if (raw.includes("azul")) return "Azul";
      if (raw.includes("preto")) return "Preto";
      if (raw.includes("#facc15")) return "Amarelo";
      if (raw.includes("#ef4444")) return "Vermelho";
      if (raw.includes("#3b82f6")) return "Azul";
      if (raw.includes("#18181b") || raw.includes("#111827")) return "Preto";
      return null;
    };
    const sortByRoundOrId = (a, b) => {
      const ar = a.round != null ? a.round : 999;
      const br = b.round != null ? b.round : 999;
      if (ar !== br) return ar - br;
      return (a.id || 0) - (b.id || 0);
    };
    const gamesByStage = stages.reduce((acc, stage) => {
      acc[stage] = games.filter((g) => g.stage === stage).sort(sortByRoundOrId);
      return acc;
    }, {});
    const groupGames = gamesByStage.GROUP || [];
    const semiGames = gamesByStage.SEMI || [];
    const finalGames = gamesByStage.FINAL || [];
    const finalGame = finalGames.find((g) => g.round === 1) || finalGames[0] || null;
    const thirdPlaceGame = finalGames.find((g) => g.round === 2) || null;
    const groupComplete =
      groupGames.length > 0 &&
      groupGames.every((g) => g.homeGoals != null && g.awayGoals != null);
    const semisExist = semiGames.length > 0;
    const semisDecided = semisExist && semiGames.every((g) => g.winnerTeamId);
    const finalExists = finalGames.length > 0;
    const teamById = new Map(tournamentTeamList.map((team) => [team.id, team]));
    const getLoserTeam = (game) => {
      if (!game || !game.winnerTeamId) return null;
      return game.homeTeamId === game.winnerTeamId ? game.awayTeam : game.homeTeam;
    };
    const formatTeamName = (team) => {
      if (!team) return "Time";
      const label = normalizeSponsorLabel(team.color || team.name);
      return sponsorNameByLabel[label] || team.name || "Time";
    };
    const renderTeamName = (team, fallbackName) => {
      if (!team) return fallbackName || "Time";
      const label = normalizeSponsorLabel(team.color || team.name);
      const name = sponsorNameByLabel[label] || team.name || fallbackName || "Time";
      const style = sponsorStyleByLabel[label] || "";
      return `<span style="${style}">${name}</span>`;
    };
    const getTeamLabel = (team) => normalizeSponsorLabel(team?.color || team?.name);
    const getTeamColor = (team) => sponsorColorByLabel[getTeamLabel(team)] || "#f97316";
    const teamNameFromRow = (row) => {
      const team = teamById.get(row.teamId);
      if (team) return formatTeamName(team);
      const label = normalizeSponsorLabel(row.name);
      return sponsorNameByLabel[label] || row.name || "Time";
    };
    const statVal = (row, primary, fallback) => {
      if (row && row[primary] != null) return row[primary];
      if (fallback && row && row[fallback] != null) return row[fallback];
      return 0;
    };
    const canImportDraw =
      lineupResult &&
      Array.isArray(lineupResult.teams) &&
      lineupResult.teams.length === 4;
  %>

  <% if (!tournamentData) { %>
    <div class="bg-black/40 border border-horriver-border rounded-2xl p-4 space-y-3">
      <div class="flex flex-wrap items-center justify-between gap-2">
        <p class="text-sm text-horriver-gray">
          Nenhum torneio vinculado. Crie abaixo os 4 times do torneio.
        </p>
        <% if (canImportDraw) { %>
          <span class="text-[11px] text-horriver-gray">
            Use o botao no sorteador para importar.
          </span>
        <% } %>
      </div>
      <form
        action="/admin/matches/<%= match.id %>/tournament/create"
        method="POST"
        class="grid gap-3 md:grid-cols-2"
      >
        <%
          const sponsorDefaults = [
            { name: "Natureza em Flores", color: "#facc15" },
            { name: "Matheus Gomes Barbearia", color: "#ef4444" },
            { name: "Carrocerias Santana", color: "#3b82f6" },
            { name: "Advance Compressores", color: "#18181b" },
          ];
        %>
        <% sponsorDefaults.forEach((sponsor, idx) => { %>
          <div class="bg-black/30 border border-horriver-border rounded-xl p-3 space-y-2">
            <div class="text-[11px] uppercase text-horriver-orange font-semibold">
              Time <%= idx + 1 %>
            </div>
            <div class="flex items-center justify-between gap-2 text-sm text-horriver-light">
              <span><%= sponsor.name %></span>
              <span class="w-3 h-3 rounded-full border border-white/10" style="background:<%= sponsor.color %>"></span>
            </div>
            <input type="hidden" name="team<%= idx + 1 %>Name" value="<%= sponsor.name %>" />
            <input type="hidden" name="team<%= idx + 1 %>Color" value="<%= sponsor.color %>" />
          </div>
        <% }); %>
        <div class="md:col-span-2 flex justify-end">
          <button
            type="submit"
            class="w-full sm:w-auto px-4 py-2 rounded-full bg-horriver-orange text-horriver-bg text-xs md:text-sm font-semibold hover:bg-orange-500 transition shadow-card-soft"
          >
            Criar torneio
          </button>
        </div>
      </form>
    </div>
  <% } else { %>
    <style>
      .tournament-export {
        display: none;
        background: linear-gradient(180deg, #0f1115 0%, #050608 100%);
        border: 2px solid rgba(255, 122, 26, 0.25);
        border-radius: 24px;
        padding: 18px 22px;
        color: #f1f5f9;
      }
      .tournament-export .export-only {
        display: none;
      }
      body.is-exporting .tournament-export {
        display: block;
      }
      .tournament-export.is-exporting {
        width: 1600px;
        max-width: 1600px;
      }
      body.is-exporting .tournament-export .export-only {
        display: flex;
      }
      body.is-exporting {
        height: auto !important;
      }
      body.is-exporting .tournament-export {
        overflow: visible !important;
        height: auto !important;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.45);
      }
      body.is-exporting .tournament-export .export-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding-bottom: 6px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.08);
        margin-bottom: 6px;
      }
      body.is-exporting .tournament-export .export-title {
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }
      body.is-exporting .tournament-export .export-subtitle {
        font-size: 12px;
        color: rgba(148, 163, 184, 0.9);
        margin-top: 2px;
      }
      body.is-exporting .tournament-export .export-logo {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 2px solid rgba(255, 122, 26, 0.6);
        background: #0b0c0f;
        display: grid;
        place-items: center;
      }
      body.is-exporting .tournament-export .export-logo img {
        width: 34px;
        height: 34px;
        object-fit: contain;
      }
      body.is-exporting .tournament-export .export-footer {
        margin-top: 8px;
        font-size: 14px;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        text-align: center;
        color: rgba(255, 255, 255, 0.35);
      }
      body.is-exporting .tournament-export .export-card .overflow-x-auto {
        overflow: visible;
      }
      body.is-exporting .tournament-export table {
        min-width: 0;
        width: 100%;
        table-layout: fixed;
      }
      body.is-exporting .tournament-export .export-card {
        background: rgba(255, 255, 255, 0.04);
        border: 2px solid rgba(255, 255, 255, 0.08);
        border-radius: 18px;
      }
      body.is-exporting .tournament-export .export-section-title {
        font-size: 18px;
        font-weight: 700;
        color: #f8fafc;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        position: relative;
        padding-left: 12px;
      }
      body.is-exporting .tournament-export .export-section-title::before {
        content: "";
        position: absolute;
        left: 0;
        top: 3px;
        bottom: 3px;
        width: 4px;
        border-radius: 999px;
        background: linear-gradient(180deg, #ff7a1a, #ffb455);
      }
      body.is-exporting .tournament-export .export-section-sub {
        font-size: 12px;
        color: rgba(148, 163, 184, 0.9);
        margin-top: 2px;
      }
      body.is-exporting .tournament-export .export-card h3 {
        font-size: 18px;
      }
      body.is-exporting .tournament-export table th,
      body.is-exporting .tournament-export table td {
        font-size: 14px;
      }
      body.is-exporting .tournament-export table thead th {
        color: #f8fafc;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 11px;
        background: rgba(255, 255, 255, 0.08);
      }
      body.is-exporting .tournament-export .standings-table .col-rank {
        padding-left: 14px;
      }
      body.is-exporting .tournament-export .standings-table .col-rank .rank-number {
        display: inline-block;
        transform: translateX(6px);
      }
      body.is-exporting .tournament-export .team-cell {
        max-width: 320px;
      }
      body.is-exporting .tournament-export .team-cell span {
        line-height: 1.2;
      }
      body.is-exporting .tournament-export table tbody tr.rank-1 {
        border-left: 4px solid #f5b942;
        box-shadow: inset 0 0 0 9999px rgba(245, 185, 66, 0.05);
      }
      body.is-exporting .tournament-export table tbody tr.rank-2 {
        border-left: 4px solid #ef8f2f;
        box-shadow: inset 0 0 0 9999px rgba(239, 143, 47, 0.05);
      }
      body.is-exporting .tournament-export table tbody tr td.pts-cell {
        color: #d8dee9;
        font-weight: 600;
      }
      body.is-exporting .tournament-export table tbody tr.rank-1 td.pts-cell {
        color: #f5b942;
        font-weight: 700;
        font-size: 15px;
      }
      body.is-exporting .tournament-export table tbody tr.rank-2 td.pts-cell {
        color: #ef8f2f;
        font-weight: 700;
        font-size: 15px;
      }
      body.is-exporting .tournament-export .game-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 10px 14px;
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 10px;
      }
      body.is-exporting .tournament-export .game-card.game-pending {
        opacity: 0.7;
      }
      body.is-exporting .tournament-export .team-name {
        font-size: 16px;
        font-weight: 700;
      }
      body.is-exporting .tournament-export .team-name span {
        opacity: 0.9;
      }
      body.is-exporting .tournament-export .team-side {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      body.is-exporting .tournament-export .team-line {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      body.is-exporting .tournament-export .team-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.35);
        flex: 0 0 auto;
      }
      body.is-exporting .tournament-export .team-meta {
        font-size: 12px;
        color: rgba(148, 163, 184, 0.75);
      }
      body.is-exporting .tournament-export .score {
        font-size: 18px;
        font-weight: 800;
        color: #0b0b0b;
        background: linear-gradient(90deg, #ff7a1a, #ffb455);
        padding: 0 12px;
        border-radius: 999px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        height: 34px;
        line-height: 1;
      }
      body.is-exporting .tournament-export .score-note {
        margin-top: 4px;
        font-size: 11px;
        color: rgba(148, 163, 184, 0.9);
      }
    </style>

    <div id="tournament-standings-export-admin" class="tournament-export" data-export-root>
      <div class="export-header export-only">
        <div>
          <div class="export-title">HORRIVER PLATE — TORNEIO</div>
          <div class="export-subtitle">Classificacao</div>
        </div>
        <div class="export-logo">
          <img src="/img/logo-64x64.svg" alt="Horriver Plate" />
        </div>
      </div>

      <div class="export-card rounded-2xl border border-horriver-border/60 bg-black/40 p-2">
        <h3 class="text-sm font-semibold text-horriver-light mb-2">Classificacao</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-[11px] standings-table">
            <thead class="text-horriver-gray">
              <tr>
                <th class="text-left py-2 pr-3">#</th>
                <th class="text-left py-2 pr-3">Time</th>
                <th class="text-center py-2">J</th>
                <th class="text-center py-2">V</th>
                <th class="text-center py-2">E</th>
                <th class="text-center py-2">D</th>
                <th class="text-center py-2">GP</th>
                <th class="text-center py-2">GC</th>
                <th class="text-center py-2">SG</th>
                <th class="text-center py-2">Pts</th>
              </tr>
            </thead>
            <tbody>
              <% standings.forEach((row, idx) => { const isFirst = idx === 0; const isSecond = idx === 1; %>
                <tr class="border-t border-horriver-border/40 <%= (idx % 2 === 0) ? 'bg-white/5' : 'bg-white/10' %> <%= isFirst ? 'rank-1' : '' %> <%= isSecond ? 'rank-2' : '' %>">
                  <td class="py-2 pr-3 text-horriver-gray col-rank">
                    <span class="rank-number"><%= idx + 1 %></span>
                  </td>
                  <td class="py-2 pr-3 text-horriver-light team-cell">
                    <span class="inline-flex items-center gap-2">
                      <span class="team-dot" style="background:<%= getTeamColor(teamById.get(row.teamId)) %>;"></span>
                      <span class="font-semibold"><%- renderTeamName(teamById.get(row.teamId), teamNameFromRow(row)) %></span>
                    </span>
                  </td>
                  <td class="py-2 text-center"><%= statVal(row, "played") %></td>
                  <td class="py-2 text-center"><%= statVal(row, "wins", "v") %></td>
                  <td class="py-2 text-center"><%= statVal(row, "draws", "e") %></td>
                  <td class="py-2 text-center"><%= statVal(row, "losses", "d") %></td>
                  <td class="py-2 text-center"><%= statVal(row, "gf", "goalsFor") %></td>
                  <td class="py-2 text-center"><%= statVal(row, "ga", "goalsAgainst") %></td>
                  <td class="py-2 text-center"><%= statVal(row, "gd", "goalDiff") %></td>
                  <td class="py-2 text-center text-horriver-orange font-semibold pts-cell"><%= statVal(row, "pts", "points") %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>

      <div class="export-footer export-only">@HORRIVERPLATE</div>
    </div>

    <div id="tournament-games-export-admin" class="tournament-export" data-export-root>
      <div class="export-header export-only">
        <div>
          <div class="export-title">HORRIVER PLATE — TORNEIO</div>
          <div class="export-subtitle">Jogos e resultados</div>
        </div>
        <div class="export-logo">
          <img src="/img/logo-64x64.svg" alt="Horriver Plate" />
        </div>
      </div>

      <% stages.forEach((stage) => {
          const stageGames = gamesByStage[stage] || [];
          if (!stageGames.length) return;
      %>
        <div class="export-card rounded-2xl border border-horriver-border/60 bg-black/40 p-3 mb-4 last:mb-0">
          <div class="mb-2">
            <div class="export-section-title"><%= stageLabels[stage] || stage %></div>
          <div class="export-section-sub"><%= stageGames.length %> jogo(s)</div>
          </div>
          <div class="grid gap-3">
            <% if (stage === "FINAL") { %>
              <% if (thirdPlaceGame) { const home = teamById.get(thirdPlaceGame.homeTeamId); const away = teamById.get(thirdPlaceGame.awayTeamId); const played = thirdPlaceGame.homeGoals != null && thirdPlaceGame.awayGoals != null; %>
                <div class="export-card rounded-xl border border-white/10 bg-black/40 p-3">
                  <div class="export-section-sub mb-2">Disputa 3º lugar</div>
                  <div class="game-card <%= played ? '' : 'game-pending' %>">
                    <div class="team-side">
                      <div class="team-name text-horriver-light">
                        <span class="team-line">
                          <span class="team-dot" style="background:<%= getTeamColor(home) %>;"></span>
                          <%- renderTeamName(home, "Time") %>
                        </span>
                      </div>
                      <div class="team-meta">Mandante</div>
                    </div>
                    <div class="text-center">
                      <div class="score"><%= thirdPlaceGame.homeGoals ?? "—" %> x <%= thirdPlaceGame.awayGoals ?? "—" %></div>
                      <% if (thirdPlaceGame.decidedBy === "PENALTIES") { %>
                        <div class="score-note">
                          Pênaltis: <%= thirdPlaceGame.homePenalties %>-<%= thirdPlaceGame.awayPenalties %>
                        </div>
                      <% } %>
                    </div>
                    <div class="team-side text-right">
                      <div class="team-name text-horriver-light">
                        <span class="team-line" style="justify-content:flex-end;">
                          <%- renderTeamName(away, "Time") %>
                          <span class="team-dot" style="background:<%= getTeamColor(away) %>;"></span>
                        </span>
                      </div>
                      <div class="team-meta">Visitante</div>
                    </div>
                  </div>
                </div>
              <% } %>
              <% if (finalGame) { const home = teamById.get(finalGame.homeTeamId); const away = teamById.get(finalGame.awayTeamId); const played = finalGame.homeGoals != null && finalGame.awayGoals != null; %>
                <div class="export-card rounded-xl border border-white/10 bg-black/40 p-3">
                  <div class="export-section-sub mb-2">Final</div>
                  <div class="game-card <%= played ? '' : 'game-pending' %>">
                    <div class="team-side">
                      <div class="team-name text-horriver-light">
                        <span class="team-line">
                          <span class="team-dot" style="background:<%= getTeamColor(home) %>;"></span>
                          <%- renderTeamName(home, "Time") %>
                        </span>
                      </div>
                      <div class="team-meta">Mandante</div>
                    </div>
                    <div class="text-center">
                      <div class="score"><%= finalGame.homeGoals ?? "—" %> x <%= finalGame.awayGoals ?? "—" %></div>
                      <% if (finalGame.decidedBy === "PENALTIES") { %>
                        <div class="score-note">
                          Pênaltis: <%= finalGame.homePenalties %>-<%= finalGame.awayPenalties %>
                        </div>
                      <% } %>
                    </div>
                    <div class="team-side text-right">
                      <div class="team-name text-horriver-light">
                        <span class="team-line" style="justify-content:flex-end;">
                          <%- renderTeamName(away, "Time") %>
                          <span class="team-dot" style="background:<%= getTeamColor(away) %>;"></span>
                        </span>
                      </div>
                      <div class="team-meta">Visitante</div>
                    </div>
                  </div>
                </div>
              <% } %>
            <% } else { %>
              <% stageGames.forEach((game) => { const home = teamById.get(game.homeTeamId); const away = teamById.get(game.awayTeamId); const played = game.homeGoals != null && game.awayGoals != null; %>
                <div class="game-card <%= played ? '' : 'game-pending' %>">
                  <div class="team-side">
                    <div class="team-name text-horriver-light">
                      <span class="team-line">
                        <span class="team-dot" style="background:<%= getTeamColor(home) %>;"></span>
                        <%- renderTeamName(home, "Time") %>
                      </span>
                    </div>
                    <div class="team-meta">Mandante</div>
                  </div>
                  <div class="text-center">
                    <div class="score"><%= game.homeGoals ?? "—" %> x <%= game.awayGoals ?? "—" %></div>
                    <% if (game.decidedBy === "PENALTIES") { %>
                      <div class="score-note">
                        Pênaltis: <%= game.homePenalties %>-<%= game.awayPenalties %>
                      </div>
                    <% } %>
                  </div>
                  <div class="team-side text-right">
                    <div class="team-name text-horriver-light">
                      <span class="team-line" style="justify-content:flex-end;">
                        <%- renderTeamName(away, "Time") %>
                        <span class="team-dot" style="background:<%= getTeamColor(away) %>;"></span>
                      </span>
                    </div>
                    <div class="team-meta">Visitante</div>
                  </div>
                </div>
              <% }); %>
            <% } %>
          </div>
        </div>
      <% }); %>

      <div class="export-footer export-only">@HORRIVERPLATE</div>
    </div>
    <% const finalWinnerId = finalGame?.winnerTeamId || null; %>
    <% if (finalWinnerId && standings.length >= 4) { %>
      <% const championTeam = finalGame?.winnerTeam || teamById.get(standings[0]?.teamId); %>
      <% const runnerUpTeam = getLoserTeam(finalGame) || teamById.get(standings[1]?.teamId); %>
      <% const thirdTeam = thirdPlaceGame?.winnerTeam || teamById.get(standings[2]?.teamId); %>
      <% const fourthTeam = getLoserTeam(thirdPlaceGame) || teamById.get(standings[3]?.teamId); %>
        <div
          class="border border-horriver-border rounded-2xl p-5 shadow-[0_16px_40px_rgba(0,0,0,0.45)]"
          id="tournamentResultCard"
          style="background: radial-gradient(120% 140% at 50% 0%, rgba(255,140,0,0.12), transparent 55%), linear-gradient(180deg, rgba(7,7,7,0.95), rgba(0,0,0,0.96));"
        >
        <div class="flex items-center justify-between gap-3 mb-4">
          <h3 class="text-base md:text-lg font-semibold text-horriver-light tracking-[0.12em] uppercase">
            Resultado do campeonato
          </h3>
        </div>
        <div class="grid gap-6 md:grid-cols-3 items-center mt-4">
          <% const podiumTeams = [runnerUpTeam, championTeam, thirdTeam]; %>
          <% [2, 1, 3].forEach((pos, idx) => { %>
            <% const team = podiumTeams[idx]; %>
            <% const circleSize = pos === 1 ? 148 : 110; %>
            <% const badgeHeight = 28; %>
            <% const badgeGap = 8; %>
            <% const circleTop = badgeHeight + badgeGap; %>
            <% const podiumBoxHeight = 220; %>
            <div class="flex flex-col items-center text-center gap-2 justify-center h-full <%= pos === 1 ? 'md:-translate-y-6' : '' %>">
              <div class="relative flex items-center justify-center" style="width:<%= circleSize %>px; height:<%= podiumBoxHeight %>px;">
                <span
                  class="podium-badge px-4 h-7 rounded-full bg-horriver-orange text-horriver-bg text-[11px] font-semibold inline-flex items-center justify-center text-center min-w-[150px] shadow-[0_6px_14px_rgba(0,0,0,0.35)] absolute left-1/2 -translate-x-1/2"
                  style="top:0; line-height:<%= badgeHeight %>px;"
                >
                  <span><%= pos %>&ordm; Colocado</span>
                </span>
                <div
                  class="rounded-full <%= pos === 1 ? 'border-4' : 'border-2' %> border-horriver-orange/80"
                  style="width:<%= circleSize %>px; height:<%= circleSize %>px; background:<%= getTeamColor(team) %>; box-shadow:<%= pos === 1 ? '0 0 0 4px rgba(255,140,0,0.22), 0 0 22px rgba(255,140,0,0.35), 0 16px 32px rgba(0,0,0,0.45)' : '0 10px 22px rgba(0,0,0,0.35)' %>; position:absolute; top:<%= circleTop %>px; left:50%; transform:translateX(-50%);"
                ></div>
              </div>
              <div class="<%= pos === 1 ? 'text-base md:text-lg' : 'text-sm md:text-base' %> font-semibold text-horriver-light tracking-wide">
                <%- renderTeamName(team, "Time") %>
              </div>
            </div>
          <% }); %>
        </div>
        <div class="mt-4 flex items-center justify-center text-sm text-horriver-light">
          <div class="flex flex-col items-center gap-2 text-center">
            <span class="podium-badge px-3 h-6 rounded-full border border-horriver-border text-[11px] inline-flex items-center justify-center text-center min-w-[120px] leading-none">
              4&ordm; Colocado
            </span>
            <span
              class="rounded-full border-2 border-horriver-orange/80"
              style="width:34px; height:34px; background:<%= getTeamColor(fourthTeam) %>;"
            ></span>
            <span class="font-semibold"><%- renderTeamName(fourthTeam, "Time") %></span>
          </div>
        </div>
      </div>
    <% } %>

    <div class="grid gap-4 lg:grid-cols-2">
      <div class="bg-black/40 border border-horriver-border rounded-2xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm md:text-base font-semibold text-horriver-light">
            Classificacao
          </h3>
          <% if (canImportDraw) { %>
            <span class="text-[11px] text-horriver-gray">
              Use o botao no sorteador para importar.
            </span>
          <% } %>
        </div>
        <% if (!standings.length) { %>
          <p class="text-xs text-horriver-gray">
            Sem dados de classificacao ainda.
          </p>
        <% } else { %>
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs md:text-sm">
              <thead class="bg-black/60">
                <tr>
                  <th class="px-3 py-2 text-left font-semibold text-horriver-gray">Time</th>
                  <th class="px-3 py-2 text-center font-semibold text-horriver-gray">J</th>
                  <th class="px-3 py-2 text-center font-semibold text-horriver-gray">V</th>
                  <th class="px-3 py-2 text-center font-semibold text-horriver-gray">E</th>
                  <th class="px-3 py-2 text-center font-semibold text-horriver-gray">D</th>
                  <th class="px-3 py-2 text-center font-semibold text-horriver-gray">GP</th>
                  <th class="px-3 py-2 text-center font-semibold text-horriver-gray">GC</th>
                  <th class="px-3 py-2 text-center font-semibold text-horriver-gray">SG</th>
                  <th class="px-3 py-2 text-center font-semibold text-horriver-gray">Pts</th>
                </tr>
              </thead>
              <tbody>
                <% standings.forEach((row) => { %>
                  <tr class="border-t border-horriver-border/40">
                    <td class="px-3 py-2 text-horriver-light"><%- renderTeamName(teamById.get(row.teamId), teamNameFromRow(row)) %></td>
                    <td class="px-3 py-2 text-center text-horriver-light"><%= statVal(row, "played") %></td>
                    <td class="px-3 py-2 text-center text-horriver-light"><%= statVal(row, "wins") %></td>
                    <td class="px-3 py-2 text-center text-horriver-light"><%= statVal(row, "draws") %></td>
                    <td class="px-3 py-2 text-center text-horriver-light"><%= statVal(row, "losses") %></td>
                    <td class="px-3 py-2 text-center text-horriver-light"><%= statVal(row, "gf", "goalsFor") %></td>
                    <td class="px-3 py-2 text-center text-horriver-light"><%= statVal(row, "ga", "goalsAgainst") %></td>
                    <td class="px-3 py-2 text-center text-horriver-light"><%= statVal(row, "gd", "goalDiff") %></td>
                    <td class="px-3 py-2 text-center text-horriver-orange font-semibold"><%= statVal(row, "pts", "points") %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>

      <div class="space-y-3">
        <div class="flex flex-wrap gap-2">
          <form action="/admin/matches/<%= match.id %>/tournament/generate-semis" method="POST">
            <button
              type="submit"
              class="px-3 py-2 rounded-full bg-horriver-orange text-horriver-bg text-[11px] font-semibold hover:bg-orange-500 transition <%= (!groupComplete || semisExist) ? 'opacity-50 cursor-not-allowed' : '' %>"
              <%= (!groupComplete || semisExist) ? "disabled" : "" %>
            >
              Gerar Semifinais
            </button>
          </form>
          <form action="/admin/matches/<%= match.id %>/tournament/generate-final" method="POST">
            <button
              type="submit"
              class="px-3 py-2 rounded-full bg-horriver-orange text-horriver-bg text-[11px] font-semibold hover:bg-orange-500 transition <%= (!semisDecided || finalExists) ? 'opacity-50 cursor-not-allowed' : '' %>"
              <%= (!semisDecided || finalExists) ? "disabled" : "" %>
            >
              Gerar Final
            </button>
          </form>
          <form
            action="/admin/matches/<%= match.id %>/tournament/reset"
            method="POST"
            onsubmit="return confirm('Tem certeza que deseja resetar o torneio?');"
          >
            <button
              type="submit"
              class="px-3 py-2 rounded-full border border-horriver-border text-horriver-light text-[11px] font-semibold hover:border-horriver-orange hover:text-horriver-orange transition"
            >
              Resetar Torneio
            </button>
          </form>
        </div>

        <div class="bg-black/40 border border-horriver-border rounded-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm md:text-base font-semibold text-horriver-light">
              <%= stageLabels.GROUP %>
            </h3>
            <span class="text-[11px] text-horriver-gray">
              <%= (gamesByStage.GROUP || []).length %> jogo(s)
            </span>
          </div>

          <% const stageGamesGroup = gamesByStage.GROUP || []; %>
          <% if (!stageGamesGroup.length) { %>
            <p class="text-xs text-horriver-gray">Sem jogos.</p>
          <% } else { %>
            <div class="overflow-x-auto">
              <table class="min-w-full text-xs md:text-sm">
                <thead class="bg-black/60">
                  <tr>
                    <th class="px-3 py-2 text-left font-semibold text-horriver-gray">Jogo</th>
                    <th class="px-3 py-2 text-center font-semibold text-horriver-gray">Placar</th>
                    <th class="px-3 py-2 text-center font-semibold text-horriver-gray">Vencedor</th>
                    <th class="px-3 py-2 text-center font-semibold text-horriver-gray">Lancar</th>
                  </tr>
                </thead>
                <tbody>
                  <% stageGamesGroup.forEach((game) => { %>
                    <% const homeName = renderTeamName(game.homeTeam, "Casa"); %>
                    <% const awayName = renderTeamName(game.awayTeam, "Visitante"); %>
                    <% const hasScore = game.homeGoals != null && game.awayGoals != null; %>
                    <% const scoreLabel = hasScore ? `${game.homeGoals} x ${game.awayGoals}` : "-"; %>
                    <tr class="border-t border-horriver-border/40">
                      <td class="px-3 py-2 text-horriver-light">
                        <span class="text-horriver-orange text-[10px] uppercase mr-2">
                          <%= game.round ? `R${game.round}` : "GROUP" %>
                        </span>
                        <%- homeName %> x <%- awayName %>
                      </td>
                      <td class="px-3 py-2 text-center text-horriver-light"><%= scoreLabel %></td>
                      <td class="px-3 py-2 text-center text-horriver-light">
                        <% if (game.winnerTeam) { %>
                          Vencedor: <%- renderTeamName(game.winnerTeam, "Time") %>
                        <% } else if (hasScore) { %>
                          Empate
                        <% } else { %>
                          -
                        <% } %>
                      </td>
                      <td class="px-3 py-2 text-center">
                        <form
                          action="/admin/tournament/game/<%= game.id %>/result"
                          method="POST"
                          class="flex items-center justify-center gap-2"
                        >
                          <input
                            type="number"
                            name="homeGoals"
                            min="0"
                            step="1"
                            class="w-14 bg-black/40 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs"
                            value="<%= game.homeGoals != null ? game.homeGoals : '' %>"
                            placeholder="0"
                          />
                          <span class="text-horriver-gray text-[11px]">x</span>
                          <input
                            type="number"
                            name="awayGoals"
                            min="0"
                            step="1"
                            class="w-14 bg-black/40 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs"
                            value="<%= game.awayGoals != null ? game.awayGoals : '' %>"
                            placeholder="0"
                          />
                          <button
                            type="submit"
                            class="px-3 py-1 rounded-full bg-horriver-orange text-horriver-bg text-[11px] font-semibold hover:bg-orange-500 transition"
                          >
                            Salvar
                          </button>
                        </form>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </div>
    </div>
    <div class="grid gap-4 mt-4 lg:grid-cols-2">
      <% ["SEMI", "THIRD"].forEach((stage) => { %>
        <div class="bg-black/40 border border-horriver-border rounded-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm md:text-base font-semibold text-horriver-light">
              <%= stage === "THIRD" ? "Terceiro lugar" : (stageLabels[stage] || stage) %>
            </h3>
            <span class="text-[11px] text-horriver-gray">
              <%= stage === "THIRD" ? (thirdPlaceGame ? 1 : 0) : (gamesByStage[stage] || []).length %> jogo(s)
            </span>
          </div>

          <% const stageGamesKnockout = stage === "THIRD" ? (thirdPlaceGame ? [thirdPlaceGame] : []) : (gamesByStage[stage] || []); %>
          <% if (!stageGamesKnockout.length) { %>
            <p class="text-xs text-horriver-gray">Sem jogos.</p>
          <% } else { %>
            <div class="overflow-x-auto">
              <table class="min-w-full text-xs md:text-sm">
                <thead class="bg-black/60">
                  <tr>
                    <th class="px-3 py-2 text-left font-semibold text-horriver-gray">Jogo</th>
                    <th class="px-3 py-2 text-center font-semibold text-horriver-gray">Placar</th>
                    <th class="px-3 py-2 text-center font-semibold text-horriver-gray">Vencedor</th>
                    <th class="px-3 py-2 text-center font-semibold text-horriver-gray">Lancar</th>
                  </tr>
                </thead>
                <tbody>
                  <% stageGamesKnockout.forEach((game) => { %>
                    <% const homeName = renderTeamName(game.homeTeam, "Casa"); %>
                    <% const awayName = renderTeamName(game.awayTeam, "Visitante"); %>
                    <% const hasScore = game.homeGoals != null && game.awayGoals != null; %>
                    <% const scoreLabel = hasScore ? `${game.homeGoals} x ${game.awayGoals}` : "-"; %>
                    <% const isFinal = stage === "FINAL"; %>
                    <% const isSemi = stage === "SEMI"; %>
                    <% const isDraw = hasScore && game.homeGoals === game.awayGoals; %>
                    <% const hasPens = game.homePenalties != null && game.awayPenalties != null; %>
                    <tr class="border-t border-horriver-border/40">
                      <td class="px-3 py-2 text-horriver-light">
                        <span class="text-horriver-orange text-[10px] uppercase mr-2">
                          <%= stage === "THIRD" ? "3º" : stage %>
                        </span>
                        <%- homeName %> x <%- awayName %>
                        <% if (isSemi && game.decidedBy === "ADVANTAGE") { %>
                          <span class="ml-2 text-[10px] text-horriver-orange uppercase">Vantagem do melhor colocado</span>
                        <% } %>
                      </td>
                      <td class="px-3 py-2 text-center text-horriver-light"><%= scoreLabel %></td>
                      <td class="px-3 py-2 text-center text-horriver-light">
                        <% if (game.winnerTeam) { %>
                          Vencedor: <%- renderTeamName(game.winnerTeam, "Time") %>
                        <% } else if (hasScore) { %>
                          Empate
                        <% } else { %>
                          -
                        <% } %>
                        <% if (isFinal && hasPens) { %>
                          <span class="text-[11px] text-horriver-gray">
                            (Penaltis: <%= game.homePenalties %>-<%= game.awayPenalties %>)
                          </span>
                        <% } %>
                      </td>
                      <td class="px-3 py-2 text-center">
                        <form
                          action="/admin/tournament/game/<%= game.id %>/result"
                          method="POST"
                          class="flex items-center justify-center gap-2"
                        >
                          <input
                            type="number"
                            name="homeGoals"
                            min="0"
                            step="1"
                            class="w-14 bg-black/40 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs"
                            value="<%= game.homeGoals != null ? game.homeGoals : '' %>"
                            placeholder="0"
                          />
                          <span class="text-horriver-gray text-[11px]">x</span>
                          <input
                            type="number"
                            name="awayGoals"
                            min="0"
                            step="1"
                            class="w-14 bg-black/40 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs"
                            value="<%= game.awayGoals != null ? game.awayGoals : '' %>"
                            placeholder="0"
                          />
                          <button
                            type="submit"
                            class="px-3 py-1 rounded-full bg-horriver-orange text-horriver-bg text-[11px] font-semibold hover:bg-orange-500 transition"
                          >
                            Salvar
                          </button>
                        </form>
                        <% if (isFinal && isDraw) { %>
                          <form
                            action="/admin/tournament/game/<%= game.id %>/pens"
                            method="POST"
                            class="mt-2 flex items-center justify-center gap-2"
                          >
                            <input
                              type="number"
                              name="homePens"
                              min="0"
                              step="1"
                              class="w-14 bg-black/40 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs"
                              value="<%= game.homePenalties != null ? game.homePenalties : '' %>"
                              placeholder="0"
                            />
                            <span class="text-horriver-gray text-[11px]">x</span>
                            <input
                              type="number"
                              name="awayPens"
                              min="0"
                              step="1"
                              class="w-14 bg-black/40 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs"
                              value="<%= game.awayPenalties != null ? game.awayPenalties : '' %>"
                              placeholder="0"
                            />
                            <button
                              type="submit"
                              class="px-3 py-1 rounded-full border border-horriver-border text-horriver-light text-[11px] font-semibold hover:border-horriver-orange hover:text-horriver-orange transition"
                            >
                              Salvar penaltis
                            </button>
                          </form>
                        <% } %>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      <% }); %>
    </div>
    <div class="grid gap-4 mt-4 lg:grid-cols-1">
      <div class="bg-black/40 border border-horriver-border rounded-2xl p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm md:text-base font-semibold text-horriver-light">
            <%= stageLabels.FINAL %>
          </h3>
          <span class="text-[11px] text-horriver-gray">
            <%= finalGame ? 1 : 0 %> jogo(s)
          </span>
        </div>

        <% const stageGamesFinal = finalGame ? [finalGame] : []; %>
        <% if (!stageGamesFinal.length) { %>
          <p class="text-xs text-horriver-gray">Sem jogos.</p>
        <% } else { %>
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs md:text-sm">
              <thead class="bg-black/60">
                <tr>
                  <th class="px-3 py-2 text-left font-semibold text-horriver-gray">Jogo</th>
                  <th class="px-3 py-2 text-center font-semibold text-horriver-gray">Placar</th>
                  <th class="px-3 py-2 text-center font-semibold text-horriver-gray">Vencedor</th>
                  <th class="px-3 py-2 text-center font-semibold text-horriver-gray">Lancar</th>
                </tr>
              </thead>
              <tbody>
                <% stageGamesFinal.forEach((game) => { %>
                  <% const homeName = renderTeamName(game.homeTeam, "Casa"); %>
                  <% const awayName = renderTeamName(game.awayTeam, "Visitante"); %>
                  <% const hasScore = game.homeGoals != null && game.awayGoals != null; %>
                  <% const scoreLabel = hasScore ? `${game.homeGoals} x ${game.awayGoals}` : "-"; %>
                  <% const isDraw = hasScore && game.homeGoals === game.awayGoals; %>
                  <% const hasPens = game.homePenalties != null && game.awayPenalties != null; %>
                  <tr class="border-t border-horriver-border/40">
                    <td class="px-3 py-2 text-horriver-light">
                      <span class="text-horriver-orange text-[10px] uppercase mr-2">FINAL</span>
                      <%- homeName %> x <%- awayName %>
                    </td>
                    <td class="px-3 py-2 text-center text-horriver-light"><%= scoreLabel %></td>
                    <td class="px-3 py-2 text-center text-horriver-light">
                      <% if (game.winnerTeam) { %>
                        Vencedor: <%- renderTeamName(game.winnerTeam, "Time") %>
                      <% } else if (hasScore) { %>
                        Empate
                      <% } else { %>
                        -
                      <% } %>
                      <% if (hasPens) { %>
                        <span class="text-[11px] text-horriver-gray">
                          (Penaltis: <%= game.homePenalties %>-<%= game.awayPenalties %>)
                        </span>
                      <% } %>
                    </td>
                    <td class="px-3 py-2 text-center">
                      <form
                        action="/admin/tournament/game/<%= game.id %>/result"
                        method="POST"
                        class="flex items-center justify-center gap-2"
                      >
                        <input
                          type="number"
                          name="homeGoals"
                          min="0"
                          step="1"
                          class="w-14 bg-black/40 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs"
                          value="<%= game.homeGoals != null ? game.homeGoals : '' %>"
                          placeholder="0"
                        />
                        <span class="text-horriver-gray text-[11px]">x</span>
                        <input
                          type="number"
                          name="awayGoals"
                          min="0"
                          step="1"
                          class="w-14 bg-black/40 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs"
                          value="<%= game.awayGoals != null ? game.awayGoals : '' %>"
                          placeholder="0"
                        />
                        <button
                          type="submit"
                          class="px-3 py-1 rounded-full bg-horriver-orange text-horriver-bg text-[11px] font-semibold hover:bg-orange-500 transition"
                        >
                          Salvar
                        </button>
                      </form>
                      <% if (isDraw) { %>
                        <form
                          action="/admin/tournament/game/<%= game.id %>/pens"
                          method="POST"
                          class="mt-2 flex items-center justify-center gap-2"
                        >
                          <input
                            type="number"
                            name="homePens"
                            min="0"
                            step="1"
                            class="w-14 bg-black/40 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs"
                            value="<%= game.homePenalties != null ? game.homePenalties : '' %>"
                            placeholder="0"
                          />
                          <span class="text-horriver-gray text-[11px]">x</span>
                          <input
                            type="number"
                            name="awayPens"
                            min="0"
                            step="1"
                            class="w-14 bg-black/40 border border-horriver-border rounded-md px-2 py-1 text-center text-horriver-light text-xs"
                            value="<%= game.awayPenalties != null ? game.awayPenalties : '' %>"
                            placeholder="0"
                          />
                          <button
                            type="submit"
                            class="px-3 py-1 rounded-full border border-horriver-border text-horriver-light text-[11px] font-semibold hover:border-horriver-orange hover:text-horriver-orange transition"
                          >
                            Salvar penaltis
                          </button>
                        </form>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    </div>
  <% } %>
</section>

<style>
  /* Feedback suave para drag-and-drop */
  li.dragging {
    opacity: 0.6;
    transform: scale(0.98);
  }
  .drop-target {
    outline: 1px dashed rgba(249, 115, 22, 0.8);
    background: rgba(249, 115, 22, 0.05);
  }
  .drop-placeholder {
    border: 1px dashed rgba(249, 115, 22, 0.5);
    border-radius: 8px;
    height: 32px;
    margin-top: 4px;
    background: rgba(255, 255, 255, 0.04);
  }
  #sorterResults.teams-4 {
    grid-template-columns: repeat(2, minmax(320px, 1fr));
  }
  #sorterResults [data-team] {
    min-width: 0;
  }
  @media (max-width: 639px) {
    #sorterResults {
      grid-template-columns: 1fr !important;
    }
    #sorterResults.teams-4 {
      grid-template-columns: 1fr !important;
    }
  }
</style>

<script>
  (() => {
    const statusEl = document.getElementById("sorterStatus");
    try {
    const matchId = <%= match.id %>;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");
    const form = document.getElementById("sorterForm");
    const resultsEl = document.getElementById("sorterResults");
    const shareBox = document.getElementById("sorterShare");
    const copyBtn = document.getElementById("copyTeamsBtn");
    const imgBtn = document.getElementById("imgTeamsBtn");
    const saveBtn = document.getElementById("saveTeamsBtn");
    const sortBtn = document.getElementById("sortBtn");
    const shareStatus = document.getElementById("shareStatus");
    const importForm = document.getElementById("importTournamentForm");
    const importBtn = document.getElementById("importTournamentBtn");
    const importStatus = document.getElementById("importTournamentStatus");
    const importNameInputs = Array.from(document.querySelectorAll("[data-import-name]"));
    const importColorInputs = Array.from(document.querySelectorAll("[data-import-color]"));
    const benchBox = document.getElementById("benchBox");
    const goalkeeperBenchBox = document.getElementById("goalkeeperBenchBox");
    const availableBox = document.getElementById("availableBox");
    const initialLineup = <%- JSON.stringify(lineupResult || null) %>;

    const guestName = document.getElementById("guestName");
    const guestPos = document.getElementById("guestPos");
    const guestStr = document.getElementById("guestStr");
    const guestsField = document.getElementById("guestsField");
    const guestList = document.getElementById("guestList");
    const addGuestBtn = document.getElementById("addGuestBtn");
    const seedList = document.getElementById("seedList");

    if (!form || !resultsEl) return;

    const matchDateLabel = new Date("<%= match.playedAt.toISOString() %>").toLocaleDateString("pt-BR", { timeZone: 'America/Sao_Paulo' });

    const guests = [];
    const seedIds = new Set();
    const guestsStorageKey = `hp_match_${matchId}_guests`;
    const seedStorageKey = `hp_match_${matchId}_seeds`;

    function getPresentIdsFromForm() {
      const ids = Array.from(document.querySelectorAll('input[name^="present_"]'))
        .filter((cb) => cb.checked)
        .map((cb) => cb.name.replace("present_", ""))
        .filter(Boolean);
      return Array.from(new Set(ids));
    }

    function getPresentPlayersDetail() {
      const players = Array.from(document.querySelectorAll('input[name^="present_"]'))
        .filter((cb) => cb.checked)
        .map((cb) => ({
          id: cb.name.replace("present_", ""),
          name: cb.dataset.playerName || "Jogador",
          position: cb.dataset.playerPosition || "",
          strength: Number(cb.dataset.playerStrength || cb.dataset.playerOverall || 0),
        }));
      const unique = new Map();
      players.forEach((p) => {
        if (!p.id || unique.has(p.id)) return;
        unique.set(p.id, p);
      });
      return Array.from(unique.values());
    }

    function isGoalkeeperPosition(pos = "") {
      const p = pos.toLowerCase();
      return p.includes("goleiro") || p.includes("gol");
    }

    function renderSeedList() {
      if (!seedList) return;
      const presentPlayers = getPresentPlayersDetail();
      const allowedIds = new Set(presentPlayers.map((p) => p.id));
      Array.from(seedIds).forEach((id) => {
        if (!allowedIds.has(id)) seedIds.delete(id);
      });
      localStorage.setItem(seedStorageKey, JSON.stringify(Array.from(seedIds)));
      if (!presentPlayers.length) {
        seedList.innerHTML = `<span class="text-horriver-gray">Marque presenças para escolher os cabeças de chave.</span>`;
        return;
      }
      seedList.innerHTML = presentPlayers
        .map((p) => {
          const checked = seedIds.has(p.id) ? "checked" : "";
          return `
            <label class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-white/5 border border-horriver-border text-horriver-light cursor-pointer">
              <input type="checkbox" class="accent-horriver-orange" data-seed-id="${p.id}" ${checked} />
              <span>${p.name}</span>
              <span class="text-horriver-gray text-[10px] uppercase">${p.position}</span>
            </label>
          `;
        })
        .join("");
    }

    seedList?.addEventListener("change", (e) => {
      const cb = e.target.closest("input[data-seed-id]");
      if (!cb) return;
      const id = cb.dataset.seedId;
      if (!id) return;
      if (cb.checked) seedIds.add(id);
      else seedIds.delete(id);
      localStorage.setItem(seedStorageKey, JSON.stringify(Array.from(seedIds)));
    });

    document.querySelectorAll('input[name^="present_"]').forEach((cb) => {
      cb.addEventListener("change", () => {
        renderSeedList();
        updateAvailableList();
      });
    });

    // Restaura cabeças de chave ao recarregar
    try {
      const storedSeeds = JSON.parse(localStorage.getItem(seedStorageKey) || "[]");
      if (Array.isArray(storedSeeds)) {
        storedSeeds.forEach((id) => seedIds.add(String(id)));
      }
    } catch (err) {
      console.warn("Falha ao restaurar seeds:", err);
    }
    renderSeedList();

    function normalizeGuests() {
      const unique = new Map();
      guests.forEach((g) => {
        const name = (g.name || "Convidado").trim();
        const position = (g.position || "Outros").trim();
        const strength = Math.max(40, Math.min(100, parseInt(g.strength || "60", 10) || 60));
        const key = name.toLowerCase();
        // Se repetir nome, mantém a entrada mais recente
        unique.set(key, { name, position, strength });
      });
      guests.length = 0;
      unique.forEach((g) => guests.push(g));
    }

    function syncGuestsField() {
      normalizeGuests();
      const lines = guests.map((g) => `${g.name};${g.position};${g.strength}`);
      guestsField.value = lines.join("\n");
      try {
        localStorage.setItem(guestsStorageKey, guestsField.value);
      } catch (err) {
        console.warn("Nao foi possivel salvar convidados no storage.", err);
      }
      guestList.innerHTML = guests
        .map(
          (g, idx) => `
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-white/5 border border-horriver-border text-horriver-light">
              ${g.name} (Convidado) - ${g.position} - ${g.strength}
              <button type="button" data-remove="${idx}" class="text-horriver-orange hover:text-white">x</button>
            </span>
          `
        )
        .join("");
    }

    function loadGuestsFromStorage() {
      let raw = "";
      try {
        raw = localStorage.getItem(guestsStorageKey) || "";
      } catch (err) {
        console.warn("Nao foi possivel ler convidados do storage.", err);
      }
      if (!raw) return;
      raw
        .split("\n")
        .map((line) => line.trim())
        .filter(Boolean)
        .forEach((line) => {
          const [name, position, strengthRaw] = line.split(";");
          const strength = Math.max(40, Math.min(100, parseInt(strengthRaw || "60", 10) || 60));
          guests.push({
            name: (name || "Convidado").trim(),
            position: (position || "Outros").trim(),
            strength,
          });
        });
      syncGuestsField();
    }

    guestList.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-remove]");
      if (!btn) return;
      const idx = parseInt(btn.dataset.remove, 10);
      if (!Number.isNaN(idx)) {
        guests.splice(idx, 1);
        syncGuestsField();
      }
    });

    addGuestBtn?.addEventListener("click", () => {
      const name = (guestName.value || "Convidado").trim();
      const position = guestPos.value || "Outros";
      const strength = Math.max(40, Math.min(100, parseInt(guestStr.value || "60", 10) || 60));
      const key = name.toLowerCase();
      const existingIdx = guests.findIndex((g) => (g.name || "").trim().toLowerCase() === key);
      if (existingIdx >= 0) {
        guests[existingIdx] = { name, position, strength };
      } else {
        guests.push({ name, position, strength });
      }
      guestName.value = "";
      guestStr.value = "60";
      syncGuestsField();
      updateAvailableList();
    });
    loadGuestsFromStorage();

    const teamColors = [
      { name: "Amarelo", value: "#facc15" },
      { name: "Azul", value: "#3b82f6" },
      { name: "Preto", value: "#18181b" },
      { name: "Vermelho", value: "#ef4444" },
      { name: "Branco", value: "#e5e7eb" },
    ];
    const sponsorNameByLabel = {
      Amarelo: "Natureza em Flores",
      Vermelho: "Matheus Gomes Barbearia",
      Azul: "Carrocerias Santana",
      Preto: "Advance Compressores",
    };

    function renderTeams(teams, bench) {
      const overallByPresentPlayerId = new Map(
        getPresentPlayersDetail().map((p) => [String(p.id), Number(p.strength || 0)])
      );
      const resolveDisplayOverall = (player) => {
        const presentOverall = overallByPresentPlayerId.get(String(player?.id || ""));
        if (Number.isFinite(presentOverall) && presentOverall > 0) {
          return Math.round(presentOverall);
        }
        const fallback = Number(player?.displayOverall ?? player?.strength ?? 0);
        return Number.isFinite(fallback) ? Math.round(fallback) : 0;
      };

      const abbrevPos = (pos) => {
        const p = String(pos || "").toLowerCase();
        if (!p) return "";
        if (p.includes("goleiro") || p.includes("gol")) return "GOL";
        if (p.includes("ata")) return "ATA";
        if (p.includes("atac")) return "ATA";
        if (p.includes("meia") || p.includes("mei")) return "MEI";
        if (p.includes("vol")) return "VOL";
        if (p.includes("zag") || p.includes("def")) return "ZAG";
        return p.slice(0, 3).toUpperCase();
      };

      if (resultsEl) {
        if (teams && teams.length === 4) {
          resultsEl.classList.add("teams-4");
        } else {
          resultsEl.classList.remove("teams-4");
        }
      }
      const goalkeepers = (bench || []).filter((p) => {
        const pos = (p.position || "").toLowerCase();
        return pos.includes("goleiro") || pos.includes("gol");
      });
      const fieldBench = (bench || []).filter((p) => {
        const pos = (p.position || "").toLowerCase();
        return !(pos.includes("goleiro") || pos.includes("gol"));
      });

      resultsEl.innerHTML = (teams || [])
        .map((t, idx) => {
          const players = Array.isArray(t.players) ? t.players : [];
          const power = players.reduce((sum, p) => sum + Number(p.strength || 0), 0);
          const selectedColor = t.colorName || teamColors[idx % teamColors.length].name;
          const selectedDef = teamColors.find((c) => c.name === selectedColor) || teamColors[0];
          const sponsorName = sponsorNameByLabel[selectedDef.name] || t.name || `Time ${selectedDef.name}`;
          return `
            <div class="border border-horriver-border/60 rounded-xl p-3 bg-black/30" data-team="${idx}" data-team-id="${idx}" data-team-color="${selectedDef.value}" data-team-color-name="${selectedDef.name}">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="w-2.5 h-2.5 rounded-full" data-color-indicator style="background:${selectedDef.value}"></span>
                  <span data-team-name>${sponsorName}</span>
                </div>
                <div class="flex items-center gap-2">
                  <select data-color-select class="bg-horriver-dark border border-horriver-border rounded px-2 py-1 text-[11px] text-horriver-light">
                    ${teamColors
                      .map(
                        (c) => `<option value="${c.value}" ${c.name === selectedColor ? "selected" : ""}>${c.name}</option>`
                      )
                      .join("")}
                  </select>
                  <p class="text-horriver-light" data-team-power>Forca: ${Math.round(power)}</p>
                </div>
              </div>
              <ul class="space-y-1" data-team-list data-list-id="team-${idx}">
                ${players
                  .map(
                    (p) => {
                      const displayName = p.guest ? `${p.name} (Convidado)` : p.name;
                      const displayPos = p.guest ? abbrevPos(p.position) : (p.position || "");
                      return `
                      <li
                        class="flex items-center justify-between gap-1 bg-white/5 rounded-lg px-2 py-1 text-horriver-light text-[12px]"
                        data-player-id="${p.id}"
                        data-player-strength="${p.strength}"
                        data-player-overall="${resolveDisplayOverall(p)}"
                        data-player-position="${p.position}"
                        data-player-name="${p.name}"
                        data-player-nickname="${p.nickname || ""}"
                        data-player-guest="${p.guest ? "true" : "false"}"
                      >
                        <div class="flex flex-col">
                          <span>${displayName}${p.nickname ? " (" + p.nickname + ")" : ""}</span>
                          <span class="text-horriver-orange text-[11px]">${displayPos}</span>
                        </div>
                        <span class="text-horriver-gray">${resolveDisplayOverall(p)}</span>
                      </li>
                    `;
                    }
                  )
                  .join("")}
              </ul>
            </div>
          `;
        })
        .join("");

      // aplica cor escolhida no nome/indicador e habilita troca
      resultsEl.querySelectorAll("[data-team]").forEach((teamEl) => {
        const select = teamEl.querySelector("[data-color-select]");
        const indicator = teamEl.querySelector("[data-color-indicator]");
        const nameEl = teamEl.querySelector("[data-team-name]");
        if (!select) return;
        const applyColor = () => {
          if (indicator) indicator.style.background = select.value;
          if (nameEl) nameEl.style.color = select.value;
          teamEl.setAttribute("data-team-color", select.value);
          const selectedText = select.options[select.selectedIndex]?.text || "";
          if (selectedText) {
            teamEl.setAttribute("data-team-color-name", selectedText);
            const sponsorName = sponsorNameByLabel[selectedText] || `Time ${selectedText}`;
            if (nameEl) nameEl.textContent = sponsorName;
          }
        };
        select.addEventListener("change", applyColor);
        applyColor();
      });

      const renderBenchList = (players, listId) =>
        players
          .map((p) => {
            const displayName = p.guest ? `${p.name} (Convidado)` : p.name;
            const displayPos = p.guest ? abbrevPos(p.position) : (p.position || "");
            return `
              <li
                class="flex items-center justify-between bg-white/5 rounded-lg px-2 py-1 text-horriver-light text-[12px]"
                data-player-id="${p.id}"
                data-player-strength="${p.strength}"
                data-player-overall="${resolveDisplayOverall(p)}"
                data-player-position="${p.position}"
                data-player-name="${p.name}"
                data-player-nickname="${p.nickname || ""}"
                data-player-guest="${p.guest ? "true" : "false"}"
                data-list-id="${listId}"
              >
                <div class="flex flex-col">
                  <span>${displayName}${p.nickname ? " (" + p.nickname + ")" : ""}</span>
                  <span class="text-horriver-orange text-[11px]">${displayPos}</span>
                </div>
                <span class="text-horriver-gray">${resolveDisplayOverall(p)}</span>
              </li>
            `;
          })
          .join("");

      if (goalkeeperBenchBox) {
        if (goalkeepers.length) {
          goalkeeperBenchBox.classList.remove("hidden");
          goalkeeperBenchBox.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <div>
                <p class="text-horriver-orange font-semibold">Goleiros</p>
                <p class="text-horriver-gray text-[11px]">Arraste para um time se quiser.</p>
              </div>
              <p class="text-horriver-light">${goalkeepers.length} jogador(es)</p>
            </div>
            <ul class="space-y-1 min-h-[12px]" data-list-id="goalkeeper-bench">
              ${renderBenchList(goalkeepers, "goalkeeper-bench")}
            </ul>
          `;
        } else {
          goalkeeperBenchBox.classList.add("hidden");
          goalkeeperBenchBox.innerHTML = "";
        }
      }

      // Banco somente para goleiros; esconde reservas de linha
      if (benchBox) {
        benchBox.classList.add("hidden");
        benchBox.innerHTML = "";
      }
      updateAvailableList();
      recalculatePower();
      setupDragAndDrop();
      updateImportFormVisibility(teams);
    }

    function normalizeTeamLabel(value) {
      const raw = value ? String(value).trim().toLowerCase() : "";
      if (raw.includes("preto")) return "Preto";
      if (raw.includes("vermelho")) return "Vermelho";
      if (raw.includes("azul")) return "Azul";
      if (raw.includes("amarelo")) return "Amarelo";
      return "Preto";
    }

    function updateImportFormVisibility(teams = []) {
      if (!importForm) return;
      const hasTeams = Array.isArray(teams) && teams.length === 4;
      if (hasTeams) {
        importForm.classList.remove("hidden");
      } else {
        importForm.classList.add("hidden");
      }
    }

    function fillImportInputs() {
      if (!resultsEl) return false;
      const requiredLabels = ["preto", "vermelho", "azul", "amarelo"];
      const allSelects = Array.from(resultsEl.querySelectorAll("select"));
      const colorSelects = allSelects.filter((select) => {
        const optionLabels = Array.from(select.options).map((opt) =>
          (opt.text || "").toLowerCase()
        );
        return requiredLabels.every((label) =>
          optionLabels.some((optLabel) => optLabel.includes(label))
        );
      });
      if (colorSelects.length === 4) {
        colorSelects.forEach((select, idx) => {
          const rawValue = select.value || "";
          const selectedText = select.options[select.selectedIndex]?.text || "";
          const normalized = normalizeTeamLabel(selectedText || rawValue);
          const nameInput = importNameInputs[idx];
          const colorInput = importColorInputs[idx];
        if (nameInput) nameInput.value = sponsorNameByLabel[normalized] || `Time ${normalized}`;
          if (colorInput) colorInput.value = normalized;
        });
      } else if (initialLineup && Array.isArray(initialLineup.teams) && initialLineup.teams.length === 4) {
        initialLineup.teams.forEach((team, idx) => {
          const raw = team?.colorName || team?.colorValue || "";
          const normalized = normalizeTeamLabel(raw);
          const nameInput = importNameInputs[idx];
          const colorInput = importColorInputs[idx];
          if (nameInput) nameInput.value = sponsorNameByLabel[normalized] || `Time ${normalized}`;
          if (colorInput) colorInput.value = normalized;
        });
      } else {
        if (importStatus) importStatus.textContent = "Gere 4 times antes de importar.";
        return false;
      }

      if (importStatus) importStatus.textContent = "";
      return true;
    }

    function recalculatePower() {
      const teamBoxes = resultsEl.querySelectorAll("[data-team]");
      teamBoxes.forEach((box) => {
        const players = box.querySelectorAll("li[data-player-strength]");
        const total = Array.from(players).reduce((sum, li) => sum + parseFloat(li.dataset.playerStrength || "0"), 0);
        const powerEl = box.querySelector("[data-team-power]");
        if (powerEl) powerEl.textContent = `Forca: ${Math.round(total)}`;
      });

      if (goalkeeperBenchBox) {
        const gkCount = goalkeeperBenchBox.querySelectorAll("li[data-player-id]").length;
        const gkCountEl = goalkeeperBenchBox.querySelector(".text-horriver-light");
        if (gkCountEl) gkCountEl.textContent = `${gkCount} jogador(es)`;
      }

      if (benchBox) {
        const benchCount = benchBox.querySelectorAll("li[data-player-id]").length;
        const benchCountEl = benchBox.querySelector(".text-horriver-light");
        if (benchCountEl) benchCountEl.textContent = `${benchCount} jogador(es)`;
      }
    }

    function updateAvailableList() {
      if (!availableBox) return;
      if (!resultsEl.querySelector("[data-team]")) {
        availableBox.classList.add("hidden");
        availableBox.innerHTML = "";
        return;
      }

      const assignedIds = new Set(
        Array.from(
          document.querySelectorAll(
            "#sorterResults li[data-player-id], #goalkeeperBenchBox li[data-player-id]"
          )
        ).map((li) => li.dataset.playerId)
      );

      const available = getPresentPlayersDetail()
        .filter((p) => !assignedIds.has(p.id))
        .filter((p) => !isGoalkeeperPosition(p.position));

      if (!available.length) {
        availableBox.classList.add("hidden");
        availableBox.innerHTML = "";
        return;
      }

      availableBox.classList.remove("hidden");
      availableBox.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div>
            <p class="text-horriver-orange font-semibold">Disponiveis</p>
            <p class="text-horriver-gray text-[11px]">Arraste para trocar sem refazer o sorteio.</p>
          </div>
          <p class="text-horriver-light">${available.length} jogador(es)</p>
        </div>
        <ul class="space-y-1 min-h-[12px]" data-list-id="available">
          ${available
            .map(
              (p) => `
                <li
                  class="flex items-center justify-between bg-white/5 rounded-lg px-2 py-1 text-horriver-light text-[12px]"
                  data-player-id="${p.id}"
                  data-player-strength="${p.strength || 0}"
                  data-player-overall="${p.strength || 0}"
                  data-player-position="${p.position || ""}"
                  data-player-name="${p.name}"
                  data-player-nickname=""
                  data-player-guest="false"
                  data-list-id="available"
                >
                  <div class="flex flex-col">
                    <span>${p.name}</span>
                    <span class="text-horriver-orange text-[11px]">${p.position || ""}</span>
                  </div>
                  <span class="text-horriver-gray">${Number(p.strength || 0).toFixed(1)}</span>
                </li>
              `
            )
            .join("")}
        </ul>
      `;
    }

    function setupDragAndDrop() {
      const placeholder = document.createElement("li");
      placeholder.className = "drop-placeholder";
      const draggableItems = document.querySelectorAll(
        "#sorterResults li[data-player-id], #benchBox li[data-player-id], #goalkeeperBenchBox li[data-player-id], #availableBox li[data-player-id]"
      );
      const lists = document.querySelectorAll("[data-team-list],[data-list-id]");
      let currentDragEl = null;

      draggableItems.forEach((li) => {
        li.setAttribute("draggable", "true");
        li.addEventListener("dragstart", (e) => {
          currentDragEl = li;
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", "moving");
          li.classList.add("dragging");
        });
        li.addEventListener("dragend", () => {
          li.classList.remove("dragging");
          if (placeholder.parentNode) placeholder.parentNode.removeChild(placeholder);
          lists.forEach((list) => list.classList.remove("drop-target"));
          currentDragEl = null;
        });
      });

      lists.forEach((list) => {
        list.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
          if (currentDragEl) {
            list.classList.add("drop-target");
            if (placeholder.parentNode !== list) {
              if (placeholder.parentNode) placeholder.parentNode.removeChild(placeholder);
              list.appendChild(placeholder);
            }
          }
        });
        list.addEventListener("drop", (e) => {
          e.preventDefault();
          if (!currentDragEl) return;
          list.classList.remove("drop-target");
          if (placeholder.parentNode === list) {
            list.insertBefore(currentDragEl, placeholder);
            placeholder.parentNode.removeChild(placeholder);
          } else {
            list.appendChild(currentDragEl);
          }
          currentDragEl = null;
          recalculatePower();
          updateAvailableList();
        });
        list.addEventListener("dragleave", () => {
          list.classList.remove("drop-target");
          if (placeholder.parentNode === list) {
            placeholder.parentNode.removeChild(placeholder);
          }
        });
      });
    }

    function buildLineupPayload() {
      const teams = Array.from(resultsEl.querySelectorAll("[data-team]"))
        .map((teamEl, idx) => {
          const colorSelect = teamEl.querySelector("[data-color-select]");
          const colorName =
            colorSelect?.options[colorSelect.selectedIndex]?.text || null;
          const colorValue = colorSelect?.value || null;
          const players = Array.from(teamEl.querySelectorAll("li[data-player-id]"))
            .map((li) => ({
              id: li.dataset.playerId,
              name: li.dataset.playerName || li.querySelector("span")?.textContent || "Jogador",
              nickname: li.dataset.playerNickname || null,
              position: li.dataset.playerPosition || "",
              strength: Number(li.dataset.playerStrength || 0),
              displayOverall: li.dataset.playerOverall ? Number(li.dataset.playerOverall) : null,
              guest: li.dataset.playerGuest === "true",
            }));
          const power = players.reduce((sum, p) => sum + (p.strength || 0), 0);
          const colorLabel = teamEl.getAttribute("data-team-color-name") || "";
          const fallbackName = sponsorNameByLabel[colorLabel] || `Time ${idx + 1}`;
          return {
            name: teamEl.querySelector("[data-team-name]")?.textContent?.trim() || fallbackName ,
            colorName,
            colorValue,
            power,
            players,
          };
        });

      const benchPlayers = [
        ...Array.from(goalkeeperBenchBox?.querySelectorAll("li[data-player-id]") || []).map((li) => ({
          id: li.dataset.playerId,
          name: li.dataset.playerName || li.querySelector("span")?.textContent || "Jogador",
          nickname: li.dataset.playerNickname || null,
          position: li.dataset.playerPosition || "",
          strength: Number(li.dataset.playerStrength || 0),
          displayOverall: li.dataset.playerOverall ? Number(li.dataset.playerOverall) : null,
          guest: li.dataset.playerGuest === "true",
        })),
        ...Array.from(benchBox?.querySelectorAll("li[data-player-id]") || []).map((li) => ({
          id: li.dataset.playerId,
          name: li.dataset.playerName || li.querySelector("span")?.textContent || "Jogador",
          nickname: li.dataset.playerNickname || null,
          position: li.dataset.playerPosition || "",
          strength: Number(li.dataset.playerStrength || 0),
          displayOverall: li.dataset.playerOverall ? Number(li.dataset.playerOverall) : null,
          guest: li.dataset.playerGuest === "true",
        })),
      ];

      return { teams, bench: benchPlayers };
    }

    async function persistLineup(source = "manual") {
      const payload = buildLineupPayload();
      if (!payload.teams.length) {
        if (shareStatus) shareStatus.textContent = "Sorteie os times antes de salvar.";
        return;
      }

      try {
        const headers = { "Content-Type": "application/json" };
        if (csrfToken) headers["X-CSRF-Token"] = csrfToken;
        const resp = await fetch(`/admin/matches/${matchId}/save-lineup`, {
          method: "POST",
          headers,
          body: JSON.stringify({ ...payload, source }),
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || data.error) throw new Error(data.error || "Erro ao salvar lineup.");
        if (shareStatus) shareStatus.textContent = "Times salvos para esta pelada.";
      } catch (err) {
        console.error(err);
        if (shareStatus) shareStatus.textContent = "Falha ao salvar os times.";
      }
    }

    if (initialLineup && Array.isArray(initialLineup.teams) && initialLineup.teams.length) {
      renderTeams(initialLineup.teams || [], initialLineup.bench || []);
      if (shareBox) shareBox.classList.remove("hidden");
      statusEl.textContent = "Times salvos carregados.";
    }

    async function handleSort(e) {
      if (e) e.preventDefault();
      statusEl.textContent = "Sorteando...";
      resultsEl.innerHTML = "";
      benchBox.classList.add("hidden");
      benchBox.innerHTML = "";
      if (goalkeeperBenchBox) {
        goalkeeperBenchBox.classList.add("hidden");
        goalkeeperBenchBox.innerHTML = "";
      }
      if (availableBox) {
        availableBox.classList.add("hidden");
        availableBox.innerHTML = "";
      }

      const presentIds = getPresentIdsFromForm();
      if (!presentIds.length) {
        statusEl.textContent = "Sorteando com os presentes já salvos (marque acima se quiser alterar).";
      }

      syncGuestsField();
      const payload = { guests: guestsField.value || "", presentIds, seedIds: Array.from(seedIds) };

      try {
        const headers = { "Content-Type": "application/json" };
        if (csrfToken) headers["X-CSRF-Token"] = csrfToken;
        const resp = await fetch(`/admin/matches/${matchId}/sort-teams`, {
          method: "POST",
          headers,
          body: JSON.stringify(payload),
        });
        const data = await resp.json();
        if (!resp.ok || data.error) {
          statusEl.textContent = data.error || "Erro ao sortear.";
          return;
        }

        renderTeams(data.teams || [], data.bench || []);
        statusEl.textContent = `Gerados ${data.teams?.length || 0} time(s). Ajuste e salve se precisar.`;
        if (shareBox) shareBox.classList.remove("hidden");
        await persistLineup("auto-sort");
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Erro inesperado ao sortear.";
      }
    }
    form.addEventListener("submit", handleSort);
    sortBtn?.addEventListener("click", handleSort);
    saveBtn?.addEventListener("click", () => {
      persistLineup("manual-save");
    });
    if (importForm) {
      importForm.addEventListener("submit", (e) => {
        if (!fillImportInputs()) {
          e.preventDefault();
        }
      });
    }

    if (copyBtn) {
      copyBtn.addEventListener("click", () => {
        const blocks = resultsEl.querySelectorAll("[data-team]");
        if (!blocks.length) return;
        let text = `Sorteio da pelada ${matchDateLabel}\n`;
        const abbrevPos = (pos) => {
          const p = (pos || "").toLowerCase();
          if (!p) return "";
          if (p.includes("goleiro")) return "GOL";
          if (p.includes("ata")) return "ATA";
          if (p.includes("atac")) return "ATA";
          if (p.includes("meia") || p.includes("mei")) return "MEI";
          if (p.includes("vol")) return "VOL";
          if (p.includes("zag") || p.includes("def")) return "ZAG";
          return p.slice(0, 3).toUpperCase();
        };

        blocks.forEach((box) => {
          const colorName =
            box.getAttribute("data-team-color-name") ||
            box.querySelector("[data-color-select]")?.selectedOptions?.[0]?.text ||
            "";
          const rawName = box.querySelector("[data-team-name]")?.textContent || "Time";
          const colorEmojiMap = {
            Amarelo: "AMARELO",
            Azul: "AZUL",
            Preto: "PRETO",
            Vermelho: "VERMELHO",
            Branco: "BRANCO",
          };
          const emoji = colorEmojiMap[colorName] || "";
          const sponsorName = sponsorNameByLabel[colorName] || `Time ${colorName}`;
          const name = colorName ? `${emoji} ${sponsorName}` : rawName;
          const lines = Array.from(box.querySelectorAll("li")).map((li) => {
            const spans = li.querySelectorAll("span");
            const nome = spans[0]?.textContent?.trim() || "";
            const isGuest = li.dataset.playerGuest === "true";
            const pos = isGuest ? abbrevPos(spans[1]?.textContent?.trim() || "") : "";
            return pos ? `- ${nome} ${pos}` : `- ${nome}`;
          });
          text += `\n${name}\n${lines.join("\n")}\n`;
        });
        const gkItems = goalkeeperBenchBox ? goalkeeperBenchBox.querySelectorAll("li") : [];
        if (gkItems.length) {
          text += "\nGoleiros\n";
          gkItems.forEach((li) => {
            const spans = li.querySelectorAll("span");
            const nome = spans[0]?.textContent?.trim() || "";
            text += `- ${nome}\n`;
          });
        }

        const benchItems = benchBox.querySelectorAll("li");
        if (benchItems.length) {
          text += "\nBanco/Reservas\n";
          benchItems.forEach((li) => {
            const spans = li.querySelectorAll("span");
            const nome = spans[0]?.textContent?.trim() || "";
            const isGuest = li.dataset.playerGuest === "true";
            const pos = isGuest ? abbrevPos(spans[1]?.textContent?.trim() || "") : "";
            text += pos ? `- ${nome} ${pos}\n` : `- ${nome}\n`;
          });
        }
        try {
          navigator.clipboard.writeText(text);
          if (shareStatus) shareStatus.textContent = "Times copiados para a área de transferência.";
        } catch (err) {
          if (shareStatus) shareStatus.textContent = "Falha ao copiar. Copie manualmente.";
        }
      });
    }

    if (imgBtn) {
      imgBtn.addEventListener("click", async () => {
        shareStatus.textContent = "Gerando imagem...";
        try {
          // carrega html2canvas se ainda não estiver presente
          if (typeof html2canvas === "undefined") {
            await new Promise((resolve, reject) => {
              const s = document.createElement("script");
              s.src = "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js";
              s.onload = resolve;
              s.onerror = () => reject(new Error("Falha ao carregar html2canvas"));
              document.body.appendChild(s);
            });
          }

          const teamsForShare = Array.from(resultsEl.querySelectorAll("[data-team]")).map((box, idx) => {
            const rawName = box.querySelector("[data-team-name]")?.textContent?.trim() || `Time ${idx + 1}`;
            const selectEl = box.querySelector("[data-color-select]");
            const color =
              selectEl?.value ||
              box.getAttribute("data-team-color") ||
              box.querySelector("[data-color-indicator]")?.style?.backgroundColor ||
              "#f97316";
            const players = Array.from(box.querySelectorAll("li")).map((li) => {
              const spans = li.querySelectorAll("span");
              const nome = spans[0]?.textContent?.trim() || "";
              const pos = spans[1]?.textContent?.trim() || "";
              return { nome, pos };
            });
            const nomeCor =
              box.getAttribute("data-team-color-name") ||
              selectEl?.selectedOptions?.[0]?.text ||
              rawName;
            const sponsorName = sponsorNameByLabel[nomeCor] || rawName;
            const displayName = sponsorName || rawName;
            return { name: displayName, color, players };
          });

          const goalkeepersForShare = Array.from(goalkeeperBenchBox?.querySelectorAll("li") || []).map((li) => {
            const spans = li.querySelectorAll("span");
            const nome = spans[0]?.textContent?.trim() || "";
            const pos = spans[1]?.textContent?.trim() || "";
            return { nome, pos };
          });

          const getLuminance = (hex) => {
            if (!hex || !hex.startsWith("#") || hex.length < 7) return 0.5;
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            const lin = (c) => (c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4));
            return 0.2126 * lin(r) + 0.7152 * lin(g) + 0.0722 * lin(b);
          };

          if (!teamsForShare.length) {
            shareStatus.textContent = "Sorteie os times antes de gerar imagem.";
            return;
          }

          const card = document.createElement("div");
          card.style.position = "fixed";
          card.style.left = "-9999px";
          card.style.top = "0";
          card.style.width = "1400px";
          card.style.padding = "24px 24px 28px";
          card.style.borderRadius = "30px";
          card.style.background = "radial-gradient(circle at 25% 15%, #2b0d0d 0%, #140a0c 45%, #0b0b10 100%)";
          card.style.color = "#f3f4f6";
          card.style.fontFamily = "Inter, system-ui, -apple-system, sans-serif";
          card.style.boxShadow = "0 12px 28px rgba(0,0,0,0.35)";

          const headerHtml = `
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
              <div style="display:flex;flex-direction:column;gap:8px;">
                <span style="font-size:12px;color:#f97316;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;opacity:0.8;">Times Sorteados</span>
                <span style="font-size:34px;font-weight:900;letter-spacing:-0.4px;line-height:1.05;">Pelada ${matchDateLabel}</span>
                <span style="height:2px;width:160px;border-radius:999px;background:linear-gradient(90deg, rgba(249,115,22,0.85) 0%, rgba(249,115,22,0) 100%);"></span>
              </div>
              <div style="width:88px;height:88px;border-radius:50%;overflow:hidden;border:2px solid rgba(249,115,22,0.6);background:#0f0f15;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 18px rgba(0,0,0,0.35);">
                <img src="/img/logo-32x32.svg" alt="Horriver Plate" style="width:auto;height:auto;max-width:80%;max-height:80%;object-fit:contain;display:block;opacity:0.9;" />
              </div>
            </div>
          `;

          const colors = ["#facc15", "#3b82f6", "#1f2937", "#10b981"];
          const gridColumns = teamsForShare.length === 4 ? 2 : 3;
          const getPosBadge = (pos = "") => {
            const raw = String(pos || "").toUpperCase();
            const key = raw.includes("GOL") ? "GOL" : raw.includes("ZAG") ? "ZAG" : raw.includes("MEI") ? "MEI" : raw.includes("ATA") ? "ATA" : raw.slice(0, 3);
            const colorMap = {
              ATA: "#b84040",
              MEI: "#3a6fae",
              ZAG: "#3f9a63",
              GOL: "#c9a227",
            };
            const bg = colorMap[key] || "#94a3b8";
            return {
              label: key || raw,
              bg,
            };
          };

          const teamsHtml = `
            <div style="display:grid;grid-template-columns:repeat(${gridColumns},minmax(0,1fr));gap:14px;">
              ${teamsForShare
                .map((t, idx) => {
                  const headerBg = t.color || colors[idx % colors.length];
                  const isDark = getLuminance(headerBg) < 0.45 || t.name.toLowerCase().includes("preto");
                  const headerText = isDark ? "#f8fafc" : "#0b0b0b";
                  const bodyText = "#f8fafc";
                  const lineColor = "rgba(255,255,255,0.07)";
                  const panelBg = `linear-gradient(160deg, rgba(255,255,255,0.06) 0%, rgba(8,8,12,0.75) 100%)`;
                  return `
                    <div style="position:relative;border:1px solid ${headerBg}55;border-radius:20px;overflow:hidden;background:${panelBg};box-shadow:0 10px 22px rgba(0,0,0,0.28), 0 0 0 1px ${headerBg}33;transition:transform .2s ease, box-shadow .2s ease;will-change:transform;">
                      <div style="position:absolute;inset:0;background:rgba(0,0,0,0.24);"></div>
                      <div style="position:absolute;right:12px;bottom:10px;width:132px;height:132px;opacity:0.05;background:url('/img/logo.jpg') center/contain no-repeat;pointer-events:none;z-index:0;"></div>
                      <div style="position:relative;z-index:1;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:${headerBg};color:${headerText};font-weight:800;letter-spacing:0.6px;font-size:15px;">
                        <span style="font-size:21px;font-weight:800;letter-spacing:0.4px;line-height:1.1;">${t.name}</span>
                        <span style="font-size:11px;opacity:0.8;">${t.players.length} jogadores</span>
                      </div>
                      <div style="position:relative;z-index:1;padding:14px 16px 16px;display:flex;flex-direction:column;gap:12px;color:${bodyText};">
                        ${t.players
                          .map(
                            (p) => {
                              const badge = getPosBadge(p.pos);
                              return `
                              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 6px 8px 0;border-bottom:1px solid ${lineColor};">
                                <span style="font-weight:700;font-size:16px;letter-spacing:0.1px;line-height:1.2;flex:1;min-width:0;word-break:break-word;">${p.nome}</span>
                                <span style="display:inline-block;font-size:11px;font-weight:700;letter-spacing:0.08em;color:rgba(255,255,255,0.65);line-height:1;margin:0 8px 0 0;white-space:nowrap;">${badge.label}</span>
                                </span>
                              </div>
                            `;
                            }
                          )
                          .join("")}
                      </div>
                    </div>
                  `;
                })
                .join("")}
            </div>
          `;

          const gkHtml =
            goalkeepersForShare.length > 0
              ? `
            <div style="margin-top:18px;border:1px solid rgba(255,122,0,0.28);border-radius:18px;padding:14px 16px;background:rgba(12,12,16,0.7);box-shadow:0 10px 22px rgba(0,0,0,0.22);">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                <span style="font-weight:800;color:#f97316;letter-spacing:0.6px;">Goleiros</span>
                <span style="font-size:12px;color:rgba(243,244,246,0.8);">${goalkeepersForShare.length} jogador(es)</span>
              </div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;">
                ${goalkeepersForShare
                  .map(
                    (gk) => `
                      <div style="display:flex;align-items:center;justify-content:space-between;border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:8px 10px;background:rgba(255,255,255,0.03);">
                        <div style="display:flex;align-items:center;gap:8px;">
                          <span style="font-size:14px;">🧤</span>
                          <div style="display:flex;flex-direction:column;gap:4px;">
                            <span style="font-weight:700;font-size:13px;line-height:1.1;">${gk.nome}</span>
                            <span style="font-size:10px;color:rgba(203,213,225,0.7);text-transform:uppercase;letter-spacing:0.5px;">${gk.pos}</span>
                          </div>
                        </div>
                        <span style="display:inline-block;font-size:11px;font-weight:700;letter-spacing:0.08em;color:rgba(255,255,255,0.65);line-height:1;margin:0;white-space:nowrap;">GOL</span>
                      </div>
                    `
                  )
                  .join("")}
              </div>
            </div>`
              : "";

          card.innerHTML = headerHtml + teamsHtml + gkHtml;

          document.body.appendChild(card);
          const canvas = await html2canvas(card, { backgroundColor: null, scale: 2 });
          document.body.removeChild(card);

          const link = document.createElement("a");
          link.download = "times-sorteio.png";
          link.href = canvas.toDataURL("image/png");
          link.click();
          shareStatus.textContent = "Imagem baixada.";
        } catch (err) {
          console.error(err);
          shareStatus.textContent = "Erro ao gerar imagem.";
        }
      });
    }

    console.info("Sorteador carregado");
  } catch (err) {
    console.error("Erro no script do sorteador", err);
    if (statusEl) statusEl.textContent = "Erro no script. Veja o console.";
  }
  })();
</script>





