<section class="space-y-4">
  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <p class="text-xs text-horriver-gray uppercase tracking-[0.2em]">Painel</p>
      <h1 class="font-title text-2xl text-horriver-light">Votacao do mes</h1>
      <p class="text-sm text-horriver-gray">Top 6 (minimo 2 peladas no mes) e links para votar.</p>
    </div>
    <a
      href="/admin"
      class="inline-flex items-center justify-center px-4 py-2 rounded-full bg-horriver-dark border border-horriver-border text-horriver-light text-xs hover:border-horriver-orange transition"
    >
      Voltar ao painel
    </a>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="bg-black/40 border border-horriver-border rounded-2xl p-4 space-y-3">
      <h3 class="font-semibold text-lg text-horriver-light">Gerar votacao</h3>
      <form action="/admin/monthly-vote-session" method="POST" class="space-y-3" data-toast="Votacao do mes gerada.">
        <div class="grid grid-cols-2 gap-2">
          <label class="flex flex-col gap-1 text-sm text-horriver-gray">
            Mes
            <select name="month" class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light">
              <% (monthNames || []).forEach((name, idx) => { const val = idx + 1; %>
                <option value="<%= val %>" <%= mvMonth === val ? "selected" : "" %>><%= name %></option>
              <% }) %>
            </select>
          </label>
          <label class="flex flex-col gap-1 text-sm text-horriver-gray">
            Ano
            <input
              type="number"
              name="year"
              value="<%= mvYear %>"
              class="bg-horriver-dark border border-horriver-border rounded px-3 py-2 text-horriver-light"
            />
          </label>
        </div>
        <% if (monthlyVoteError) { %>
          <p class="text-xs text-red-400">
            <% if (monthlyVoteError === 'noVoters') { %>
              Nenhum jogador presente no mes para votar.
            <% } else if (monthlyVoteError === 'noCandidates') { %>
              Nenhum candidato com pelo menos 2 peladas no mes.
            <% } else { %>
              Erro ao gerar votacao. Tente novamente.
            <% } %>
          </p>
        <% } %>
        <% if (monthlyVoteCreated) { %>
          <p class="text-xs text-emerald-400">Votacao gerada com sucesso.</p>
        <% } %>
        <button
          type="submit"
          class="w-full px-4 py-2 rounded-full bg-horriver-orange text-black font-semibold hover:bg-orange-500 transition"
        >
          Gerar links
        </button>
      </form>
    </div>

    <div class="lg:col-span-2 bg-black/40 border border-horriver-border rounded-2xl p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-lg text-horriver-light">Candidatos do mes</h3>
        <% if (monthlyVoteSession) { %>
          <span class="text-[11px] text-horriver-gray">
            Sessao: <%= (monthlyVoteSession.month || mvMonth) %>/<%= (monthlyVoteSession.year || mvYear) %>
          </span>
        <% } %>
      </div>

      <% if (!monthlyVoteSession || !monthlyVoteCandidates.length) { %>
        <p class="text-sm text-horriver-gray">Nenhuma sessao criada ainda.</p>
      <% } else { %>
        <div class="grid sm:grid-cols-2 gap-3">
          <% monthlyVoteCandidates.forEach((c) => { %>
            <div class="rounded-xl border border-horriver-border/60 bg-black/50 p-3 text-[11px]">
              <p class="text-horriver-light font-semibold"><%= c.name %></p>
              <% if (c.nickname) { %>
                <p class="text-horriver-gray">"<%= c.nickname %>"</p>
              <% } %>
              <p class="text-horriver-gray mt-1">Peladas: <span class="text-horriver-light"><%= c.matches %></span></p>
              <p class="text-horriver-gray">Gols no mes: <span class="text-horriver-light"><%= c.goals ?? c.avgGoals %></span></p>
              <p class="text-horriver-gray">Assist no mes: <span class="text-horriver-light"><%= c.assists ?? c.avgAssists %></span></p>
              <p class="text-horriver-gray">Media nota: <span class="text-horriver-light"><%= String(c.avgRating).replace('.', ',') %></span></p>
              <p class="text-horriver-gray">Votos: <span class="text-horriver-light"><%= (monthlyVoteCounts && monthlyVoteCounts[c.id]) || 0 %></span></p>
            </div>
          <% }) %>
        </div>
      <% } %>

      <% if (monthlyVoteTokens && monthlyVoteTokens.length) { %>
        <div class="pt-2 border-t border-horriver-border/60">
          <h4 class="text-sm text-horriver-light font-semibold mb-2">Links de votacao</h4>
          <div class="overflow-x-auto text-[11px]">
            <table class="min-w-[520px] border-collapse">
              <thead>
                <tr class="border-b border-horriver-border/60 text-horriver-gray/80">
                  <th class="py-2 pr-3 text-left font-normal">Jogador</th>
                  <th class="py-2 pr-3 text-left font-normal">Link</th>
                  <th class="py-2 pr-3 text-left font-normal">WhatsApp</th>
                  <th class="py-2 pr-3 text-left font-normal">Status</th>
                  <th class="py-2 pr-3 text-left font-normal">Votou</th>
                </tr>
              </thead>
              <tbody>
                  <% monthlyVoteTokens.forEach((t) => {
                       const link = `${voteBaseUrl}/monthly-vote/${t.token}`;
                       const waRaw = t.player?.whatsapp || "";
                       const waDigits = waRaw.replace(/\\D/g, "");
                       const msg = `Fala ${t.player?.name || "jogador"}! Seu link de votação do mês: ${link}`;
                       const waUrl = waDigits ? `https://wa.me/${waDigits}?text=${encodeURIComponent(msg)}` : null;
                  %>
                    <tr class="border-b border-horriver-border/40 last:border-0">
                      <td class="py-2 pr-3 text-horriver-light"><%= t.player?.name || "Jogador" %></td>
                      <td class="py-2 pr-3">
                        <a href="<%= link %>" target="_blank" class="text-horriver-orange hover:underline break-all"><%= link %></a>
                      </td>
                      <td class="py-2 pr-3">
                        <% if (waUrl) { %>
                          <a
                            href="<%= waUrl %>"
                            target="_blank"
                            class="inline-flex items-center px-3 py-1 rounded-full bg-horriver-red text-white hover:bg-horriver-orange transition"
                          >
                            Mandar link
                          </a>
                        <% } else { %>
                          <span class="text-horriver-gray">Sem numero</span>
                        <% } %>
                      </td>
                    <td class="py-2 pr-3 text-horriver-gray whitespace-nowrap">
                      <%= t.usedAt ? "Votou" : "Pendente" %>
                    </td>
                    <td class="py-2 pr-3 whitespace-nowrap">
                      <% if (t.usedAt) { %>
                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-emerald-500/20 text-emerald-300 text-[11px]">✓</span>
                      <% } else { %>
                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-white/10 text-horriver-gray text-[11px]">—</span>
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      <% } %>
    </div>
  </div>

  <% if (monthlyVoteSession) { %>
    <div class="bg-black/40 border border-horriver-border rounded-2xl p-4 space-y-3">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <h3 class="font-semibold text-lg text-horriver-light">Votos registrados</h3>
        <form action="/admin/monthly-vote/<%= monthlyVoteSession.id %>/delete" method="POST" onsubmit="return confirm('Excluir esta votacao e todos os votos?');">
          <button type="submit" class="px-4 py-2 rounded-full bg-red-600/80 text-white text-xs font-semibold hover:bg-red-500 transition">
            Excluir votacao
          </button>
        </form>
      </div>

      <% if (!monthlyVoteBallots || !monthlyVoteBallots.length) { %>
        <p class="text-sm text-horriver-gray">Nenhum voto registrado ainda.</p>
      <% } else { %>
        <div class="overflow-x-auto text-[11px]">
          <table class="min-w-full border-collapse">
            <thead>
              <tr class="border-b border-horriver-border/60 text-horriver-gray/80">
                <th class="py-2 pr-3 text-left font-normal">Quem votou</th>
                <th class="py-2 pr-3 text-left font-normal">Votou em</th>
                <th class="py-2 pr-3 text-left font-normal">Quando</th>
              </tr>
            </thead>
            <tbody>
              <% monthlyVoteBallots.forEach((b) => { %>
                <tr class="border-b border-horriver-border/40 last:border-0">
                  <td class="py-2 pr-3 text-horriver-light"><%= b.token?.player?.name || "Jogador" %></td>
                  <td class="py-2 pr-3 text-horriver-light"><%= b.candidate?.name || "Jogador" %></td>
                  <td class="py-2 pr-3 text-horriver-gray"><%= new Date(b.createdAt).toLocaleString('pt-BR') %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  <% } %>
</section>
