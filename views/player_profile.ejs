<section class="w-full max-w-5xl mx-auto px-4 sm:px-6 space-y-6 animate-fadeIn">
  <header class="flex flex-col md:flex-row gap-4 items-center md:items-start">
    <div class="w-32 h-32 rounded-full overflow-hidden border-4 border-horriver-orange shadow-card-soft">
      <% if (player.photoUrl) { %>
        <img
          src="<%= thumbUrl(player.photoUrl, 320) %>"
          srcset="<%= thumbUrl(player.photoUrl, 320) %> 1x, <%= thumbUrl(player.photoUrl, 640) %> 2x"
          sizes="128px"
          class="w-full h-full object-cover"
        />
      <% } else { %>
        <div class="w-full h-full bg-black/40 flex items-center justify-center text-horriver-gray">Sem foto</div>
      <% } %>
    </div>
    <div class="flex-1 space-y-1">
      <h1 class="text-3xl font-title text-horriver-light"><%= player.name %></h1>
      <% if (player.nickname) { %><p class="text-horriver-orange text-sm">(<%= player.nickname %>)</p><% } %>
      <p class="text-sm text-horriver-gray">Posição: <span class="text-horriver-orange"><%= player.position %></span></p>
            <div class="mt-2">
        <span class="px-3 py-1 rounded-full bg-horriver-red/20 text-horriver-orange text-sm">
          Overall: <%= Math.round(latestOverall || 0) %>
        </span>
      </div>
      <div class="flex items-center gap-2 mt-3 text-sm">
        <button
          type="button"
          id="copyProfileLink"
          class="px-3 py-1 rounded-full border border-horriver-border bg-black/40 text-horriver-light hover:border-horriver-orange hover:text-horriver-orange transition"
        >
          Copiar link do perfil
        </button>
        <span id="copyStatus" class="text-[11px] text-horriver-gray hidden">Copiado!</span>
      </div>
    </div>
  </header>

  <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
    <% [['Jogos', totals.matches], ['Gols', totals.goals], ['Assistências', totals.assists], ['Fotos', totals.photos]].forEach(([label, val]) => { %>
      <div class="card-inner rounded-2xl p-4 text-center">
        <p class="text-horriver-gray text-xs"><%= label %></p>
        <p class="text-2xl text-horriver-light font-semibold"><%= val %></p>
      </div>
    <% }) %>
  </div>

  <div class="card-inner rounded-2xl p-4 space-y-3">
    <div class="flex items-center justify-between">
      <h2 class="font-title text-xl text-horriver-light">Conquistas</h2>
      <span class="text-xs text-horriver-gray"><%= achievements.length %> desbloqueadas</span>
    </div>
    <% if (!achievements.length) { %>
      <p class="text-horriver-gray text-sm">Nenhuma conquista desbloqueada ainda.</p>
    <% } else { %>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <% achievements.forEach(pa => { %>
          <%- include('partials/achievementCard', { ach: {
                title: pa.achievement.title || pa.achievement.name,
                description: pa.achievement.description || '',
                category: pa.achievement.category,
                rarity: pa.achievement.rarity || 'prata',
                targetValue: pa.achievement.targetValue,
                unlockedAt: pa.unlockedAt
          } }) %>
        <% }) %>
      </div>
    <% } %>
  </div>

  <div class="card-inner rounded-2xl p-4 space-y-2">
    <h2 class="font-title text-xl text-horriver-light">Evolução das notas</h2>
    <% if (!ratingsSeries.length) { %>
      <p class="text-sm text-horriver-gray">Sem notas ainda.</p>
    <% } else { %>
      <svg viewBox="0 0 100 40" class="w-full h-32 text-horriver-orange">
        <% const maxR = 10, minR = 0; const n = ratingsSeries.length; const step = n > 1 ? 100/(n-1) : 0; let path=''; ratingsSeries.forEach((p,i)=>{ const x = i*step; const y = 40 - ((p.rating - minR)/(maxR-minR))*40; path += (i===0? 'M':' L')+x+','+y; }); %>
        <path d="<%= path %>" fill="none" stroke="currentColor" stroke-width="1.5" />
      </svg>
    <% } %>
  </div>

  <div class="card-inner rounded-2xl p-4 space-y-2">
    <h2 class="font-title text-xl text-horriver-light">Gols por mês</h2>
    <% if (!goalsByMonth.length) { %>
      <p class="text-sm text-horriver-gray">Sem gols registrados.</p>
    <% } else { 
         // Ordena por ano-mês para garantir sequência correta e formata label manualmente
         const sortedGoals = [...goalsByMonth].sort((a, b) => new Date(a.label + "-01") - new Date(b.label + "-01"));
         const monthNames = ["jan", "fev", "mar", "abr", "mai", "jun", "jul", "ago", "set", "out", "nov", "dez"];
         const maxG = Math.max(...sortedGoals.map(g => g.value), 1);
    %>
      <div class="w-full overflow-x-auto">
        <div class="flex items-end gap-3 h-48 min-w-[640px]">
        <% sortedGoals.forEach(g => { 
             const [year, month] = g.label.split("-");
             const monthIdx = Math.max(1, Math.min(12, parseInt(month, 10)));
             const monthLabel = monthNames[monthIdx - 1] || month;
             const maxBarPx = 160; // altura máxima da barra em px
             const barHeight = Math.max(8, Math.round((g.value / maxG) * maxBarPx));
        %>
          <div class="flex-1 flex flex-col items-center">
            <div class="flex flex-col items-center w-full">
              <div class="w-full rounded-t-md bg-gradient-to-t from-horriver-red to-horriver-orange relative" style="height:<%= barHeight %>px">
                <span class="absolute inset-0 bg-horriver-orange/30 rounded-t-md"></span>
              </div>
              <span class="text-[11px] text-horriver-light mt-1"><%= g.value %></span>
              <span class="text-[10px] text-horriver-gray mt-1"><%= monthLabel %>/<%= year.slice(-2) %></span>
            </div>
          </div>
        <% }) %>
        </div>
      </div>
    <% } %>
  </div>

  <div class="card-inner rounded-2xl p-4 space-y-2">
    <h2 class="font-title text-xl text-horriver-light">Partidas recentes</h2>
    <% if (!recentMatches.length) { %>
      <p class="text-sm text-horriver-gray">Sem partidas.</p>
    <% } else { %>
      <div class="space-y-2">
        <% recentMatches.forEach(m => { %>
          <div class="flex items-center justify-between text-sm border border-horriver-border/60 rounded-lg px-3 py-2 bg-black/30">
            <div>
              <p class="text-horriver-light"><%= m.desc || 'Pelada' %></p>
              <p class="text-[11px] text-horriver-gray"><%= new Date(m.date).toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' }) %></p>
            </div>
            <div class="flex gap-3 text-[11px] text-horriver-gray">
              <span>G: <span class="text-horriver-orange"><%= m.goals || 0 %></span></span>
              <span>A: <span class="text-horriver-orange"><%= m.assists || 0 %></span></span>
              <span>Nota: <span class="text-horriver-orange"><%= m.rating ?? '-' %></span></span>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>
</section>




<script>
  (function () {
    const btn = document.getElementById("copyProfileLink");
    const status = document.getElementById("copyStatus");
    if (!btn || !navigator.clipboard) return;

    btn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        if (status) {
          status.classList.remove("hidden");
          status.textContent = "Copiado!";
          setTimeout(() => status.classList.add("hidden"), 2000);
        }
      } catch (err) {
        if (status) {
          status.classList.remove("hidden");
          status.textContent = "Erro ao copiar";
          setTimeout(() => status.classList.add("hidden"), 2000);
        }
      }
    });
  })();
</script>

