<%
  const fmtDate = (d) =>
    d ? new Date(d).toLocaleDateString("pt-BR", { timeZone: 'America/Sao_Paulo' }) : "-";

  const fmtRating = (val) => {
    if (val === null || val === undefined || Number.isNaN(val)) return "‚Äî";
    return Number(val).toFixed(2).replace(".", ",");
  };

  const safeStats = Array.isArray(stats) ? stats : [];
%>

<section class="space-y-6 animate-fadeIn">

  <!-- Cabe√ßalho da pelada -->
  <header class="space-y-2">
    <h1 class="font-title text-3xl md:text-4xl text-horriver-light">
      Pelada em <span class="text-horriver-orange"><%= fmtDate(match.playedAt) %></span>
    </h1>

    <div class="text-sm text-horriver-gray space-y-1">
      <p>
        <span class="font-semibold text-horriver-light">Descri√ß√£o:</span>
        <%= match.description || "Sem descri√ß√£o" %>
      </p>
      <p>
        <span class="font-semibold text-horriver-light">Time vencedor:</span>
        <%= match.winnerTeam || "Sem time vencedor" %>
      </p>
      <p class="text-[11px] text-horriver-gray/80 mt-1">
        Esta p√°gina √© apenas para visualiza√ß√£o p√∫blica. Para lan√ßar ou editar estat√≠sticas,
        use o painel do administrador.
      </p>
    </div>
  </header>

  <!-- Torneio (publico) -->
  <%
    const tournamentData = typeof tournament !== "undefined" ? tournament : null;
    const standings = Array.isArray(tournamentStandings) ? tournamentStandings : [];
    const games = tournamentData && Array.isArray(tournamentData.games) ? tournamentData.games : [];
    const tournamentTeamList = Array.isArray(tournamentTeams) ? tournamentTeams : [];
    const stages = ["GROUP", "SEMI", "FINAL"];
    const stageLabels = {
      GROUP: "Fase de grupos",
      SEMI: "Semifinais",
      FINAL: "Final",
    };
    const sponsorNameByLabel = {
      Amarelo: "Natureza em Flores",
      Vermelho: "Matheus Gomes Barbearia",
      Azul: "Carrocerias Santana",
      Preto: "Advance Compressores",
    };
    const sponsorStyleByLabel = {
      Amarelo: "color: #facc15;",
      Vermelho: "color: #ef4444;",
      Azul: "color: #3b82f6;",
      Preto: "color: #6b7280;",
    };
    const escapeHtml = (value) => {
      const text = value == null ? "" : String(value);
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    };
    const normalizeSponsorLabel = (value) => {
      const raw = value ? String(value).trim().toLowerCase() : "";
      if (raw.includes("amarelo")) return "Amarelo";
      if (raw.includes("vermelho")) return "Vermelho";
      if (raw.includes("azul")) return "Azul";
      if (raw.includes("preto")) return "Preto";
      if (raw.includes("#facc15")) return "Amarelo";
      if (raw.includes("#ef4444")) return "Vermelho";
      if (raw.includes("#3b82f6")) return "Azul";
      if (raw.includes("#18181b") || raw.includes("#111827")) return "Preto";
      return null;
    };
    const sortByRoundOrId = (a, b) => {
      const ar = a.round != null ? a.round : 999;
      const br = b.round != null ? b.round : 999;
      if (ar !== br) return ar - br;
      return (a.id || 0) - (b.id || 0);
    };
    const gamesByStage = stages.reduce((acc, stage) => {
      acc[stage] = games.filter((g) => g.stage === stage).sort(sortByRoundOrId);
      return acc;
    }, {});
    const teamById = new Map(tournamentTeamList.map((team) => [team.id, team]));
    const formatTeamName = (team) => {
      if (!team) return "Time";
      const label = normalizeSponsorLabel(team.color || team.name);
      return sponsorNameByLabel[label] || team.name || "Time";
    };
    const renderTeamName = (team, fallbackName) => {
      if (!team) return fallbackName || "Time";
      const label = normalizeSponsorLabel(team.color || team.name);
      const name = sponsorNameByLabel[label] || team.name || fallbackName || "Time";
      const style = sponsorStyleByLabel[label] || "";
      return `<span style="${style}">${escapeHtml(name)}</span>`;
    };
    const teamNameFromRow = (row) => {
      const team = teamById.get(row.teamId);
      if (team) return formatTeamName(team);
      const label = normalizeSponsorLabel(row.name);
      return sponsorNameByLabel[label] || row.name || "Time";
    };
    const statVal = (row, primary, fallback) => {
      if (row && row[primary] != null) return row[primary];
      if (fallback && row && row[fallback] != null) return row[fallback];
      return 0;
    };
  %>

  <% if (!tournamentData) { %>
    <p class="text-xs text-horriver-gray">
      Sem torneio nesta pelada.
    </p>
  <% } else { %>
    <style>
      .tournament-export {
        background: linear-gradient(180deg, #0f1115 0%, #050608 100%);
        border: 1px solid rgba(255, 122, 26, 0.2);
        border-radius: 24px;
        padding: 28px 32px;
        color: #f1f5f9;
      }
      .tournament-export .export-only {
        display: none;
      }
      .tournament-export.is-exporting {
        width: 1600px;
        max-width: 1600px;
      }
      body.is-exporting .tournament-export .export-only {
        display: flex;
      }
      body.is-exporting .tournament-export .no-export {
        display: none !important;
      }
      body.is-exporting {
        height: auto !important;
      }
      body.is-exporting .tournament-export {
        overflow: visible !important;
        height: auto !important;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.45);
      }
      body.is-exporting .tournament-export .export-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        margin-bottom: 16px;
      }
      body.is-exporting .tournament-export .export-title {
        font-size: 26px;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }
      body.is-exporting .tournament-export .export-subtitle {
        font-size: 14px;
        color: rgba(148, 163, 184, 0.9);
        margin-top: 4px;
      }
      body.is-exporting .tournament-export .export-logo {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 2px solid rgba(255, 122, 26, 0.6);
        background: #0b0c0f;
        display: grid;
        place-items: center;
      }
      body.is-exporting .tournament-export .export-logo img {
        width: 34px;
        height: 34px;
        object-fit: contain;
      }
      body.is-exporting .tournament-export .export-footer {
        margin-top: 20px;
        font-size: 14px;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        text-align: center;
        color: rgba(255, 255, 255, 0.35);
      }
      body.is-exporting .tournament-export .export-card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 18px;
      }
      body.is-exporting .tournament-export .export-card h3 {
        font-size: 18px;
      }
      body.is-exporting .tournament-export table th,
      body.is-exporting .tournament-export table td {
        font-size: 14px;
      }
      body.is-exporting .tournament-export .game-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 14px 16px;
      }
      body.is-exporting .tournament-export .score {
        font-size: 18px;
        font-weight: 700;
        color: #ff7a1a;
      }
    </style>
    <section class="space-y-4">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="font-title text-xl text-horriver-light">Torneio</h2>
          <p class="text-[11px] text-horriver-gray">
            Classificacao e jogos do torneio.
          </p>
        </div>
        <div class="no-export flex items-center gap-2">
          <button
            type="button"
            class="px-3 py-1.5 rounded-full border border-horriver-border text-[11px] text-horriver-gray hover:border-horriver-orange hover:text-horriver-orange transition"
            data-export-target="tournament-standings-export"
            data-export-name="tournament-classificacao"
          >
            Exportar classificacao
          </button>
          <button
            type="button"
            class="px-3 py-1.5 rounded-full border border-horriver-border text-[11px] text-horriver-gray hover:border-horriver-orange hover:text-horriver-orange transition"
            data-export-target="tournament-games-export"
            data-export-name="tournament-jogos"
          >
            Exportar jogos
          </button>
        </div>
      </div>

      <div class="grid gap-4">
        <div id="tournament-standings-export" class="tournament-export">
          <div class="export-header export-only">
            <div>
              <div class="export-title">HORRIVER PLATE ‚Äî TORNEIO</div>
              <div class="export-subtitle">Classificacao da pelada</div>
            </div>
            <div class="export-logo">
              <img src="/img/logo-64x64.svg" alt="Horriver Plate" />
            </div>
          </div>

          <div class="export-card rounded-2xl border border-horriver-border/60 bg-black/40 p-4">
            <h3 class="text-sm font-semibold text-horriver-light mb-2">Classificacao</h3>
            <div class="overflow-x-auto">
              <table class="min-w-[520px] w-full text-[11px]">
                <thead class="text-horriver-gray">
                  <tr>
                    <th class="text-left py-2 pr-3">#</th>
                    <th class="text-left py-2 pr-3">Time</th>
                    <th class="text-center py-2">P</th>
                    <th class="text-center py-2">V</th>
                    <th class="text-center py-2">E</th>
                    <th class="text-center py-2">D</th>
                    <th class="text-center py-2">SG</th>
                  </tr>
                </thead>
                <tbody>
                  <% standings.forEach((row, idx) => { %>
                    <tr class="border-t border-horriver-border/40">
                      <td class="py-2 pr-3 text-horriver-gray"><%= idx + 1 %></td>
                      <td class="py-2 pr-3 text-horriver-light"><%- renderTeamName(teamById.get(row.teamId), teamNameFromRow(row)) %></td>
                      <td class="py-2 text-center"><%= statVal(row, "points", "pts") %></td>
                      <td class="py-2 text-center"><%= statVal(row, "wins", "v") %></td>
                      <td class="py-2 text-center"><%= statVal(row, "draws", "e") %></td>
                      <td class="py-2 text-center"><%= statVal(row, "losses", "d") %></td>
                      <td class="py-2 text-center"><%= statVal(row, "goalDiff", "sg") %></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>

          <div class="export-footer export-only">@horriverplate</div>
        </div>

        <div id="tournament-games-export" class="tournament-export">
          <div class="export-header export-only">
            <div>
              <div class="export-title">HORRIVER PLATE ‚Äî TORNEIO</div>
              <div class="export-subtitle">Jogos e resultados</div>
            </div>
            <div class="export-logo">
              <img src="/img/logo-64x64.svg" alt="Horriver Plate" />
            </div>
          </div>

          <% stages.forEach((stage) => {
              const stageGames = gamesByStage[stage] || [];
              if (!stageGames.length) return;
          %>
            <div class="export-card rounded-2xl border border-horriver-border/60 bg-black/40 p-4 mb-4 last:mb-0">
              <h3 class="text-sm font-semibold text-horriver-light mb-2"><%= stageLabels[stage] || stage %></h3>
              <div class="grid gap-3">
                <% stageGames.forEach((game) => { %>
                  <div class="game-card rounded-xl border border-horriver-border/60 bg-black/50 p-3">
                    <div class="flex items-center justify-between gap-3 text-[11px]">
                      <div class="text-horriver-light">
                        <%- renderTeamName(teamById.get(game.homeTeamId), "Time") %>
                        <span class="text-horriver-gray">x</span>
                        <%- renderTeamName(teamById.get(game.awayTeamId), "Time") %>
                      </div>
                      <div class="score text-horriver-orange font-semibold">
                        <%= game.homeGoals ?? "-" %> x <%= game.awayGoals ?? "-" %>
                      </div>
                    </div>
                    <% if (game.decidedBy === "PENALTIES") { %>
                      <div class="text-[10px] text-horriver-gray mt-1">
                        Decidido nos p√™naltis
                        <% if (game.homePenalties != null && game.awayPenalties != null) { %>
                          <span class="ml-2 text-[10px] text-horriver-gray">
                            Penaltis: <%= game.homePenalties %>-<%= game.awayPenalties %>
                          </span>
                        <% } %>
                      </div>
                    <% } %>
                  </div>
                <% }); %>
              </div>
            </div>
          <% }); %>

          <div class="export-footer export-only">@horriverplate</div>
        </div>
      </div>
    </section>
  <% } %>

  <!-- Card grande -->
  <section
    class="relative mt-4 rounded-3xl border border-horriver-red/60 overflow-hidden
           bg-gradient-to-b from-black/80 via-horriver-dark to-black/95 shadow-card">

    <!-- Glows -->
    <div class="absolute inset-0 pointer-events-none opacity-70">
      <div class="absolute -top-32 left-10 w-80 h-80 bg-horriver-orange/15 blur-3xl rounded-full"></div>
      <div class="absolute bottom-[-120px] right-[-80px] w-[380px] h-[380px] bg-horriver-red/30 blur-3xl rounded-full"></div>
    </div>

    <!-- Conte√∫do -->
    <div class="relative z-10 px-4 md:px-6 py-4 md:py-5">

      <!-- T√≠tulo -->
      <div class="flex items-center justify-between gap-4 mb-3">
        <div>
          <h2 class="font-title text-xl text-horriver-light">Estat√≠sticas da pelada</h2>
          <p class="text-[11px] text-horriver-gray">Jogadores em ordem alfab√©tica, com gols, assist√™ncias, presen√ßa e nota.</p>
        </div>

        <p class="text-[11px] text-horriver-gray">
          Total de jogadores:
          <span class="text-horriver-orange font-semibold"><%= safeStats.length %></span>
        </p>
      </div>

      <!-- MOBILE FIX ‚Äì SCROLL HORIZONTAL -->
      <div class="rounded-2xl border border-horriver-red/50 bg-black/60 overflow-hidden">

        <!-- WRAPPER COM SCROLL HORIZONTAL NO MOBILE -->
        <div class="overflow-x-auto md:overflow-x-visible">

          <!-- TABELA COM MIN WIDTH PRA MOBILE -->
          <table class="min-w-[620px] w-full text-[11px] sm:text-xs" data-sortable="match-stats">
            <thead class="bg-gradient-to-r from-horriver-red/70 via-horriver-red/60 to-horriver-orange/70">
              <tr>
                <th class="px-3 py-2 text-left w-10 sticky left-0 z-20 bg-horriver-red/70">#</th>
                <th class="px-3 py-2 text-left cursor-pointer select-none sticky left-10 z-20 bg-horriver-red/70" data-sort="name">Jogador</th>
                <th class="px-3 py-2 text-left">Posi√ß√£o</th>
                <th class="px-3 py-2 text-center cursor-pointer select-none" data-sort="present">Presente</th>
                <th class="px-3 py-2 text-center cursor-pointer select-none" data-sort="goals">Gols</th>
                <th class="px-3 py-2 text-center cursor-pointer select-none" data-sort="assists">Assist.</th>
                <th class="px-3 py-2 text-center cursor-pointer select-none" data-sort="rating">Nota</th>
                <th class="px-3 py-2 text-center cursor-pointer select-none" data-sort="photo">Foto</th>
              </tr>
            </thead>

            <tbody>
              <% if (!safeStats.length) { %>
                <tr>
                  <td colspan="8" class="px-3 py-4 text-center text-sm text-horriver-gray">
                    Nenhuma estat√≠stica lan√ßada para esta pelada.
                  </td>
                </tr>
              <% } else { %>
                <% safeStats.forEach((s, idx) => { %>
                  <tr class="border-t border-horriver-red/30 hover:bg-white/5 transition-colors" data-name="<%= (s.player.name || '').toLowerCase() %>" data-position="<%= (s.player.position || '').toLowerCase() %>" data-present="<%= s.present ? 1 : 0 %>" data-goals="<%= s.goals || 0 %>" data-assists="<%= s.assists || 0 %>" data-rating="<%= s.rating != null ? s.rating : 0 %>" data-photo="<%= s.appearedInPhoto ? 1 : 0 %>">

                    <!-- # -->
                    <td class="px-3 py-2 text-[11px] text-horriver-gray sticky left-0 z-10 bg-black/90"><%= idx + 1 %></td>

                    <!-- Nome -->
                    <td class="px-3 py-2 whitespace-nowrap sticky left-10 z-10 bg-black/90">
                      <span class="text-horriver-light text-[13px]">
                        <%= s.player.name %>
                      </span>
                      <% if (s.player.nickname) { %>
                        <span class="text-horriver-gray text-[10px]">
                          ("<%= s.player.nickname %>")
                        </span>
                      <% } %>
                    </td>

                    <!-- Posi√ß√£o -->
                    <td class="px-3 py-2 text-[11px] text-horriver-orange uppercase whitespace-nowrap">
                      <%= s.player.position %>
                    </td>

                    <!-- Presente -->
                    <td class="px-3 py-2 text-center">
                      <% if (s.present) { %>
                        <span class="text-emerald-400 text-sm">?</span>
                      <% } else { %>
                        <span class="text-horriver-gray/70 text-sm">‚Äî</span>
                      <% } %>
                    </td>

                    <!-- Gols -->
                    <td class="px-3 py-2 text-center font-semibold text-horriver-light">
                      <%= s.goals || 0 %>
                    </td>

                    <!-- Assist -->
                    <td class="px-3 py-2 text-center font-semibold text-horriver-light">
                      <%= s.assists || 0 %>
                    </td>

                    <!-- Nota -->
                    <td class="px-3 py-2 text-center font-semibold text-horriver-light">
                      <%= fmtRating(s.rating) %>
                    </td>

                    <!-- Foto -->
                    <td class="px-3 py-2 text-center">
                      <% if (s.appearedInPhoto) { %>
                        <span class="text-horriver-orange text-base">üì∑</span>
                      <% } else { %>
                        <span class="text-horriver-gray/70 text-xs">‚Äî</span>
                      <% } %>
                    </td>

                  </tr>
                <% }) %>
              <% } %>
            </tbody>
          </table>

        </div>
      </div>

      <!-- Bot√£o voltar -->
      <div class="mt-4 flex justify-end">
        <a
          href="/"
          class="inline-flex items-center px-4 py-1.5 rounded-full text-[11px]
                 border border-horriver-border text-horriver-gray
                 hover:border-horriver-orange hover:text-horriver-orange
                 transition-colors">
          Voltar para a home
        </a>
      </div>

    </div>
  </section>
</section>

<script>
  (() => {
    const table = document.querySelector('table[data-sortable="match-stats"]');
    if (!table) return;
    const tbody = table.querySelector('tbody');
    const headers = Array.from(table.querySelectorAll('th[data-sort]'));
    let currentSort = { key: 'name', dir: 'asc' };

    const getValue = (row, key) => {
      switch (key) {
        case 'name':
          return row.dataset.name || '';
        case 'present':
        case 'goals':
        case 'assists':
        case 'rating':
        case 'photo':
          return Number(row.dataset[key] || 0);
        case 'position':
          return row.dataset.position || '';
        default:
          return row.dataset[key] || '';
      }
    };

    const sortRows = (key) => {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const dir = currentSort.key === key && currentSort.dir === 'asc' ? 'desc' : 'asc';
      currentSort = { key, dir };
      rows.sort((a, b) => {
        const av = getValue(a, key);
        const bv = getValue(b, key);
        if (typeof av === 'number' && typeof bv === 'number') {
          return dir === 'asc' ? av - bv : bv - av;
        }
        return dir === 'asc'
          ? String(av).localeCompare(String(bv))
          : String(bv).localeCompare(String(av));
      });
      rows.forEach((row) => tbody.appendChild(row));
    };

    headers.forEach((th) => {
      th.addEventListener('click', () => sortRows(th.dataset.sort));
    });
  })();
</script>

<script>
  (() => {
    const buttons = Array.from(document.querySelectorAll('[data-export-target]'));
    if (!buttons.length) return;

    const loadHtml2Canvas = () =>
      new Promise((resolve, reject) => {
        if (typeof html2canvas !== 'undefined') return resolve();
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
        s.onload = resolve;
        s.onerror = () => reject(new Error('Falha ao carregar html2canvas'));
        document.body.appendChild(s);
      });

    const runExport = async (targetId, name) => {
      const el = document.getElementById(targetId);
      if (!el) return;
      try {
        await loadHtml2Canvas();
        document.body.classList.add('is-exporting');
        el.classList.add('is-exporting');
        await (document.fonts?.ready || Promise.resolve());

        const exportHeight = Math.ceil(el.scrollHeight || el.getBoundingClientRect().height || 0);
        const canvas = await html2canvas(el, {
          backgroundColor: '#0f1115',
          scale: 2,
          height: exportHeight,
          windowHeight: exportHeight,
        });

        const link = document.createElement('a');
        link.download = `${name}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (err) {
        console.error(err);
      } finally {
        el.classList.remove('is-exporting');
        document.body.classList.remove('is-exporting');
      }
    };

    buttons.forEach((btn) => {
      btn.addEventListener('click', () => {
        runExport(btn.dataset.exportTarget, btn.dataset.exportName || 'tournament');
      });
    });
  })();
</script>






