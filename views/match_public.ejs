<%
  const fmtDate = (d) =>
    d ? new Date(d).toLocaleDateString("pt-BR") : "-";

  const fmtRating = (val) => {
    if (val === null || val === undefined || Number.isNaN(val)) return "—";
    return Number(val).toFixed(2).replace(".", ",");
  };

  const safeStats = Array.isArray(stats) ? stats : [];
%>

<section class="space-y-6 animate-fadeIn">

  <!-- Cabeçalho da pelada -->
  <header class="space-y-2">
    <h1 class="font-title text-3xl md:text-4xl text-horriver-light">
      Pelada em <span class="text-horriver-orange"><%= fmtDate(match.playedAt) %></span>
    </h1>

    <div class="text-sm text-horriver-gray space-y-1">
      <p>
        <span class="font-semibold text-horriver-light">Descrição:</span>
        <%= match.description || "Sem descrição" %>
      </p>
      <p>
        <span class="font-semibold text-horriver-light">Time vencedor:</span>
        <%= match.winnerTeam || "Sem time vencedor" %>
      </p>
      <p class="text-[11px] text-horriver-gray/80 mt-1">
        Esta página é apenas para visualização pública. Para lançar ou editar estatísticas,
        use o painel do administrador.
      </p>
    </div>
  </header>

  <!-- Torneio (publico) -->
  <%
    const tournamentData = typeof tournament !== "undefined" ? tournament : null;
    const standings = Array.isArray(tournamentStandings) ? tournamentStandings : [];
    const games = tournamentData && Array.isArray(tournamentData.games) ? tournamentData.games : [];
    const tournamentTeamList = Array.isArray(tournamentTeams) ? tournamentTeams : [];
    const stages = ["GROUP", "SEMI", "FINAL"];
    const stageLabels = {
      GROUP: "Fase de grupos",
      SEMI: "Semifinais",
      FINAL: "Final",
    };
    const sponsorNameByLabel = {
      Amarelo: "Natureza em Flores",
      Vermelho: "Matheus Gomes Barbearia",
      Azul: "Carrocerias Santana",
      Preto: "Advance Compressores",
    };
    const sponsorStyleByLabel = {
      Amarelo: "color: #facc15;",
      Vermelho: "color: #ef4444;",
      Azul: "color: #3b82f6;",
      Preto: "color: #6b7280;",
    };
    const normalizeSponsorLabel = (value) => {
      const raw = value ? String(value).trim().toLowerCase() : "";
      if (raw.includes("amarelo")) return "Amarelo";
      if (raw.includes("vermelho")) return "Vermelho";
      if (raw.includes("azul")) return "Azul";
      if (raw.includes("preto")) return "Preto";
      if (raw.includes("#facc15")) return "Amarelo";
      if (raw.includes("#ef4444")) return "Vermelho";
      if (raw.includes("#3b82f6")) return "Azul";
      if (raw.includes("#18181b") || raw.includes("#111827")) return "Preto";
      return null;
    };
    const sortByRoundOrId = (a, b) => {
      const ar = a.round != null ? a.round : 999;
      const br = b.round != null ? b.round : 999;
      if (ar !== br) return ar - br;
      return (a.id || 0) - (b.id || 0);
    };
    const gamesByStage = stages.reduce((acc, stage) => {
      acc[stage] = games.filter((g) => g.stage === stage).sort(sortByRoundOrId);
      return acc;
    }, {});
    const teamById = new Map(tournamentTeamList.map((team) => [team.id, team]));
    const formatTeamName = (team) => {
      if (!team) return "Time";
      const label = normalizeSponsorLabel(team.color || team.name);
      return sponsorNameByLabel[label] || team.name || "Time";
    };
    const renderTeamName = (team, fallbackName) => {
      if (!team) return fallbackName || "Time";
      const label = normalizeSponsorLabel(team.color || team.name);
      const name = sponsorNameByLabel[label] || team.name || fallbackName || "Time";
      const style = sponsorStyleByLabel[label] || "";
      return `<span style="${style}">${name}</span>`;
    };
    const teamNameFromRow = (row) => {
      const team = teamById.get(row.teamId);
      if (team) return formatTeamName(team);
      const label = normalizeSponsorLabel(row.name);
      return sponsorNameByLabel[label] || row.name || "Time";
    };
    const statVal = (row, primary, fallback) => {
      if (row && row[primary] != null) return row[primary];
      if (fallback && row && row[fallback] != null) return row[fallback];
      return 0;
    };
  %>

  <% if (!tournamentData) { %>
    <p class="text-xs text-horriver-gray">
      Sem torneio nesta pelada.
    </p>
  <% } else { %>
    <section class="space-y-4">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="font-title text-xl text-horriver-light">Torneio</h2>
          <p class="text-[11px] text-horriver-gray">
            Classificacao e jogos do torneio.
          </p>
        </div>
      </div>

      <div class="grid gap-4">
        <div class="rounded-2xl border border-horriver-border/60 bg-black/40 p-4">
          <h3 class="text-sm font-semibold text-horriver-light mb-2">Classificacao</h3>
          <div class="overflow-x-auto">
            <table class="min-w-[520px] w-full text-[11px]">
              <thead class="text-horriver-gray">
                <tr>
                  <th class="text-left py-2 pr-3">#</th>
                  <th class="text-left py-2 pr-3">Time</th>
                  <th class="text-center py-2">P</th>
                  <th class="text-center py-2">V</th>
                  <th class="text-center py-2">E</th>
                  <th class="text-center py-2">D</th>
                  <th class="text-center py-2">SG</th>
                </tr>
              </thead>
              <tbody>
                <% standings.forEach((row, idx) => { %>
                  <tr class="border-t border-horriver-border/40">
                    <td class="py-2 pr-3 text-horriver-gray"><%= idx + 1 %></td>
                    <td class="py-2 pr-3 text-horriver-light"><%- renderTeamName(teamById.get(row.teamId), teamNameFromRow(row)) %></td>
                    <td class="py-2 text-center"><%= statVal(row, "points", "pts") %></td>
                    <td class="py-2 text-center"><%= statVal(row, "wins", "v") %></td>
                    <td class="py-2 text-center"><%= statVal(row, "draws", "e") %></td>
                    <td class="py-2 text-center"><%= statVal(row, "losses", "d") %></td>
                    <td class="py-2 text-center"><%= statVal(row, "goalDiff", "sg") %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>

        <% stages.forEach((stage) => {
            const stageGames = gamesByStage[stage] || [];
            if (!stageGames.length) return;
        %>
          <div class="rounded-2xl border border-horriver-border/60 bg-black/40 p-4">
            <h3 class="text-sm font-semibold text-horriver-light mb-2"><%= stageLabels[stage] || stage %></h3>
            <div class="grid gap-3">
              <% stageGames.forEach((game) => { %>
                <div class="rounded-xl border border-horriver-border/60 bg-black/50 p-3">
                  <div class="flex items-center justify-between gap-3 text-[11px]">
                    <div class="text-horriver-light">
                      <%- renderTeamName(teamById.get(game.homeTeamId), "Time") %>
                      <span class="text-horriver-gray">x</span>
                      <%- renderTeamName(teamById.get(game.awayTeamId), "Time") %>
                    </div>
                    <div class="text-horriver-orange font-semibold">
                      <%= game.homeGoals ?? "-" %> x <%= game.awayGoals ?? "-" %>
                    </div>
                  </div>
                  <% if (game.decidedBy === "PENALTIES") { %>
                    <div class="text-[10px] text-horriver-gray mt-1">
                      Decidido nos pênaltis
                      <% if (game.homePenalties != null && game.awayPenalties != null) { %>
                        <span class="ml-2 text-[10px] text-horriver-gray">
                          Penaltis: <%= game.homePenalties %>-<%= game.awayPenalties %>
                        </span>
                      <% } %>
                    </div>
                  <% } %>
                </div>
              <% }); %>
            </div>
          </div>
        <% }); %>
      </div>
    </section>
  <% } %>

  <!-- Card grande -->
  <section
    class="relative mt-4 rounded-3xl border border-horriver-red/60 overflow-hidden
           bg-gradient-to-b from-black/80 via-horriver-dark to-black/95 shadow-card">

    <!-- Glows -->
    <div class="absolute inset-0 pointer-events-none opacity-70">
      <div class="absolute -top-32 left-10 w-80 h-80 bg-horriver-orange/15 blur-3xl rounded-full"></div>
      <div class="absolute bottom-[-120px] right-[-80px] w-[380px] h-[380px] bg-horriver-red/30 blur-3xl rounded-full"></div>
    </div>

    <!-- Conteúdo -->
    <div class="relative z-10 px-4 md:px-6 py-4 md:py-5">

      <!-- Título -->
      <div class="flex items-center justify-between gap-4 mb-3">
        <div>
          <h2 class="font-title text-xl text-horriver-light">Estatísticas da pelada</h2>
          <p class="text-[11px] text-horriver-gray">Jogadores em ordem alfabética, com gols, assistências, presença e nota.</p>
        </div>

        <p class="text-[11px] text-horriver-gray">
          Total de jogadores:
          <span class="text-horriver-orange font-semibold"><%= safeStats.length %></span>
        </p>
      </div>

      <!-- MOBILE FIX – SCROLL HORIZONTAL -->
      <div class="rounded-2xl border border-horriver-red/50 bg-black/60 overflow-hidden">

        <!-- WRAPPER COM SCROLL HORIZONTAL NO MOBILE -->
        <div class="overflow-x-auto md:overflow-x-visible">

          <!-- TABELA COM MIN WIDTH PRA MOBILE -->
          <table class="min-w-[620px] w-full text-[11px] sm:text-xs" data-sortable="match-stats">
            <thead class="bg-gradient-to-r from-horriver-red/70 via-horriver-red/60 to-horriver-orange/70">
              <tr>
                <th class="px-3 py-2 text-left w-10 sticky left-0 z-20 bg-horriver-red/70">#</th>
                <th class="px-3 py-2 text-left cursor-pointer select-none sticky left-10 z-20 bg-horriver-red/70" data-sort="name">Jogador</th>
                <th class="px-3 py-2 text-left">Posição</th>
                <th class="px-3 py-2 text-center cursor-pointer select-none" data-sort="present">Presente</th>
                <th class="px-3 py-2 text-center cursor-pointer select-none" data-sort="goals">Gols</th>
                <th class="px-3 py-2 text-center cursor-pointer select-none" data-sort="assists">Assist.</th>
                <th class="px-3 py-2 text-center cursor-pointer select-none" data-sort="rating">Nota</th>
                <th class="px-3 py-2 text-center cursor-pointer select-none" data-sort="photo">Foto</th>
              </tr>
            </thead>

            <tbody>
              <% if (!safeStats.length) { %>
                <tr>
                  <td colspan="8" class="px-3 py-4 text-center text-sm text-horriver-gray">
                    Nenhuma estatística lançada para esta pelada.
                  </td>
                </tr>
              <% } else { %>
                <% safeStats.forEach((s, idx) => { %>
                  <tr class="border-t border-horriver-red/30 hover:bg-white/5 transition-colors" data-name="<%= (s.player.name || '').toLowerCase() %>" data-position="<%= (s.player.position || '').toLowerCase() %>" data-present="<%= s.present ? 1 : 0 %>" data-goals="<%= s.goals || 0 %>" data-assists="<%= s.assists || 0 %>" data-rating="<%= s.rating != null ? s.rating : 0 %>" data-photo="<%= s.appearedInPhoto ? 1 : 0 %>">

                    <!-- # -->
                    <td class="px-3 py-2 text-[11px] text-horriver-gray sticky left-0 z-10 bg-black/90"><%= idx + 1 %></td>

                    <!-- Nome -->
                    <td class="px-3 py-2 whitespace-nowrap sticky left-10 z-10 bg-black/90">
                      <span class="text-horriver-light text-[13px]">
                        <%= s.player.name %>
                      </span>
                      <% if (s.player.nickname) { %>
                        <span class="text-horriver-gray text-[10px]">
                          ("<%= s.player.nickname %>")
                        </span>
                      <% } %>
                    </td>

                    <!-- Posição -->
                    <td class="px-3 py-2 text-[11px] text-horriver-orange uppercase whitespace-nowrap">
                      <%= s.player.position %>
                    </td>

                    <!-- Presente -->
                    <td class="px-3 py-2 text-center">
                      <% if (s.present) { %>
                        <span class="text-emerald-400 text-sm">✔</span>
                      <% } else { %>
                        <span class="text-horriver-gray/70 text-sm">—</span>
                      <% } %>
                    </td>

                    <!-- Gols -->
                    <td class="px-3 py-2 text-center font-semibold text-horriver-light">
                      <%= s.goals || 0 %>
                    </td>

                    <!-- Assist -->
                    <td class="px-3 py-2 text-center font-semibold text-horriver-light">
                      <%= s.assists || 0 %>
                    </td>

                    <!-- Nota -->
                    <td class="px-3 py-2 text-center font-semibold text-horriver-light">
                      <%= fmtRating(s.rating) %>
                    </td>

                    <!-- Foto -->
                    <td class="px-3 py-2 text-center">
                      <% if (s.appearedInPhoto) { %>
                        <span class="text-horriver-orange text-base">📸</span>
                      <% } else { %>
                        <span class="text-horriver-gray/70 text-xs">—</span>
                      <% } %>
                    </td>

                  </tr>
                <% }) %>
              <% } %>
            </tbody>
          </table>

        </div>
      </div>

      <!-- Botão voltar -->
      <div class="mt-4 flex justify-end">
        <a
          href="/"
          class="inline-flex items-center px-4 py-1.5 rounded-full text-[11px]
                 border border-horriver-border text-horriver-gray
                 hover:border-horriver-orange hover:text-horriver-orange
                 transition-colors">
          Voltar para a home
        </a>
      </div>

    </div>  <script>
    (() => {
      const table = document.querySelector('table[data-sortable="match-stats"]');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const headers = Array.from(table.querySelectorAll('th[data-sort]'));

      const getValue = (row, key) => {
        switch (key) {
          case 'name':
            return row.dataset.name || '';
